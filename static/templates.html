<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¨¡æ¿ç®¡ç† - æ™´è¾°äº‘é‚®</title>
    <link href="/dashboard/css/tailwind.min.css?v=8.0" rel="stylesheet">
    <script src="/dashboard/js/common.js?v=8.0"></script>
    <script src="/dashboard/js/layout.js?v=8.0"></script>
</head>
<body class="hidden" data-i18n-module="templates">
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-gray-800" data-i18n="templates.title">é‚®ä»¶æ¨¡æ¿</h2>
            <p class="text-gray-500 mt-1" data-i18n="templates.subtitle">åˆ›å»ºå’Œç®¡ç† HTML é‚®ä»¶å†…å®¹</p>
        </div>
        <button onclick="openModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span data-i18n="templates.add_btn">æ–°å»ºæ¨¡æ¿</span>
        </button>
    </div>

    <!-- åˆ—è¡¨ -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                <tr>
                    <th class="px-6 py-4" data-i18n="templates.table.name">æ¨¡æ¿åç§°</th>
                    <th class="px-6 py-4" data-i18n="templates.table.subject">é‚®ä»¶ä¸»é¢˜</th>
                    <th class="px-6 py-4 text-right" data-i18n="templates.table.created_at">åˆ›å»ºæ—¶é—´</th>
                    <th class="px-6 py-4 text-right" data-i18n="templates.table.actions">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="template-list" class="divide-y divide-gray-100 text-sm text-gray-700">
                <!-- JS æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>

    <!-- æ¨¡æ€æ¡† (è¶…å®½å±åŒæ ) -->
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 flex flex-col shadow-2xl" style="width: 95vw; max-width: 1600px; height: 92vh;">
            <!-- é¡¶éƒ¨æ  -->
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
                <h3 class="font-bold text-xl text-gray-800" id="modal-title" data-i18n="templates.modal.add_title">æ–°å»ºæ¨¡æ¿</h3>
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-purple-600" data-i18n="templates.modal.preset_label">âœ¨ å¿«é€Ÿå¡«å……ï¼š</span>
                    <select onchange="applyPreset(this.value)" class="border border-purple-200 rounded-lg px-3 py-1.5 text-sm bg-purple-50 text-purple-700 focus:ring-2 focus:ring-purple-500 outline-none cursor-pointer">
                        <option value="" data-i18n="templates.modal.preset_select">-- é€‰æ‹©é¢„è®¾åœºæ™¯ --</option>
                        <option value="welcome" data-i18n="templates.preset.welcome">ğŸ‰ æ¬¢è¿æ³¨å†Œ</option>
                        <option value="verify" data-i18n="templates.preset.verify">ğŸ›¡ï¸ éªŒè¯ç </option>
                        <option value="reset_pwd" data-i18n="templates.preset.reset_pwd">ğŸ”’ é‡ç½®å¯†ç </option>
                        <option value="order" data-i18n="templates.preset.order">ğŸ“¦ è®¢å•ç¡®è®¤</option>
                        <option value="shipping" data-i18n="templates.preset.shipping">ğŸšš å‘è´§é€šçŸ¥</option>
                        <option value="activity" data-i18n="templates.preset.activity">ğŸ“¢ æ´»åŠ¨æ¨å¹¿</option>
                        <option value="holiday" data-i18n="templates.preset.holiday">ğŸ èŠ‚æ—¥é—®å€™</option>
                        <option value="recall" data-i18n="templates.preset.recall">ğŸ‘‹ ç”¨æˆ·å¬å›</option>
                        <option value="feedback" data-i18n="templates.preset.feedback">ğŸ“ é—®å·è°ƒæŸ¥</option>
                        <option value="system" data-i18n="templates.preset.system">âš ï¸ ç³»ç»Ÿé€šçŸ¥</option>
                    </select>
                </div>
            </div>

            <!-- ä¸»ä½“å†…å®¹ (åŒæ ) -->
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <!-- å·¦ä¾§ï¼šç¼–è¾‘åŒº -->
                <form id="tpl-form" onsubmit="saveTemplate(event)" class="flex flex-col space-y-4 h-full overflow-y-auto pr-2">
                    <input type="hidden" id="tpl-id">
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="templates.modal.name_label">æ¨¡æ¿åç§°</label>
                        <input type="text" id="tpl-name" required data-i18n-attr="placeholder:templates.modal.name_ph" placeholder="ä¾‹å¦‚: æ³¨å†Œæ¬¢è¿ä¿¡" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1" data-i18n="templates.modal.subject_label">é‚®ä»¶ä¸»é¢˜</label>
                        <input type="text" id="tpl-subject" required data-i18n-attr="placeholder:templates.modal.subject_ph" placeholder="ä¾‹å¦‚: æ¬¢è¿åŠ å…¥æˆ‘ä»¬" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    
                    <div class="flex-1 flex flex-col min-h-[300px]">
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase" data-i18n="templates.modal.body_label">HTML å†…å®¹</label>
                            <span class="text-xs text-blue-500 cursor-pointer hover:underline" onclick="insertVariable('{username}')" data-i18n="templates.modal.insert_var">æ’å…¥ {username}</span>
                        </div>
                        <textarea id="tpl-body" required class="w-full border rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs flex-1 resize-none bg-gray-50 leading-relaxed" oninput="updatePreview()" placeholder="<html>...</html>"></textarea>
                        <p class="text-xs text-gray-400 mt-2" data-i18n="templates.modal.body_hint">æ”¯æŒå˜é‡: {username}, {code}, {link} ç­‰</p>
                    </div>
                </form>

                <!-- å³ä¾§ï¼šé¢„è§ˆåŒº -->
                <div class="flex flex-col h-full bg-gray-100 rounded-xl border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide" data-i18n="templates.modal.preview_title">å®æ—¶é¢„è§ˆ (Preview)</span>
                        <div class="flex space-x-2">
                            <div class="w-3 h-3 rounded-full bg-red-400"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                            <div class="w-3 h-3 rounded-full bg-green-400"></div>
                        </div>
                    </div>
                    <div class="flex-1 relative bg-white">
                        <iframe id="preview-frame" class="absolute inset-0 w-full h-full border-none"></iframe>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨æ  -->
            <div class="flex justify-between items-center pt-5 mt-4 border-t border-gray-100">
                <button type="button" onclick="sendTest()" class="text-gray-600 hover:text-blue-600 text-sm font-medium flex items-center transition">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span data-i18n="templates.modal.test_btn">å‘é€æµ‹è¯•é‚®ä»¶</span>
                </button>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition text-sm" data-i18n="common.cancel">å–æ¶ˆ</button>
                    <button onclick="document.getElementById('tpl-form').requestSubmit()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition text-sm font-medium" data-i18n="templates.modal.save_btn">ä¿å­˜æ¨¡æ¿</button>
                </div>
            </div>
        </div>
    </div>

    <!-- çº¯é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl overflow-hidden shadow-2xl flex flex-col" style="width: 80vw; height: 85vh;">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <span data-i18n="templates.preview.title">æ¨¡æ¿é¢„è§ˆ</span>
                </h3>
                <button onclick="closePreview()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-1 bg-gray-100 p-8 flex justify-center">
                <div class="w-full max-w-[800px] h-full bg-white shadow-lg rounded-lg overflow-hidden">
                    <iframe id="readonly-preview-frame" class="w-full h-full border-none"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        Auth.check();

        let templateList = [];

        // ç»Ÿä¸€å“åº”å¼é‚®ä»¶éª¨æ¶
        const baseStyle = `<style>body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6}.wrapper{width:100%;table-layout:fixed;background-color:#f4f7f6;padding-bottom:40px}.main{background-color:#ffffff;margin:0 auto;max-width:600px;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.05)}.header{text-align:center;padding:30px 0}.content{padding:40px}.btn{display:inline-block;padding:12px 24px;background-color:#2563eb;color:#ffffff;text-decoration:none;border-radius:6px;font-weight:bold;margin-top:20px;transition:background-color 0.2s}.btn:hover{background-color:#1d4ed8}.footer{text-align:center;padding:20px;color:#9ca3af;font-size:12px;line-height:1.5}</style>`;
        
        function wrap(title, content) {
            return `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width">${baseStyle}</head><body><div class="wrapper"><div class="header"><h1 style="color:#1f2937;margin:0;font-size:24px;font-weight:700">{app_name}</h1></div><div class="main"><div class="content"><h2 style="color:#111827;margin-top:0;font-size:20px;margin-bottom:20px">${title}</h2>${content}</div></div><div class="footer"><p>&copy; 2026 {app_name}. All rights reserved.</p><p>æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ | <a href="#" style="color:#6b7280;text-decoration:underline">å–æ¶ˆè®¢é˜…</a></p></div></div></body></html>`;
        }

        // 10ä¸ªç²¾ç¾é¢„è®¾æ¨¡æ¿
        const presets = {
            welcome: { 
                name: "æ–°ç”¨æˆ·æ¬¢è¿ä¿¡", 
                subject: "æ¬¢è¿åŠ å…¥ {app_name}ï¼", 
                body: wrap("æ¬¢è¿åŠ å…¥æˆ‘ä»¬ï¼ğŸ‰", `<p style="color:#4b5563;line-height:1.6">äº²çˆ±çš„ {username}ï¼š</p><p style="color:#4b5563;line-height:1.6">æ„Ÿè°¢æ‚¨æ³¨å†Œæˆ‘ä»¬çš„æœåŠ¡ã€‚æˆ‘ä»¬éå¸¸é«˜å…´èƒ½æœ‰æ‚¨çš„åŠ å…¥ï¼åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥ä½“éªŒåˆ°æœ€ä¸“ä¸šçš„æœåŠ¡ã€‚</p><p style="color:#4b5563;line-height:1.6">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ‚¨çš„æ¢ç´¢ä¹‹æ—…ï¼š</p><center><a href="{link}" class="btn">å¼€å§‹ä½¿ç”¨</a></center>`)
            },
            verify: { 
                name: "éªŒè¯ç é‚®ä»¶", 
                subject: "ã€å®‰å…¨æé†’ã€‘æ‚¨çš„éªŒè¯ç æ˜¯ {code}", 
                body: wrap("èº«ä»½éªŒè¯", `<p style="color:#4b5563">æ‚¨æ­£åœ¨è¿›è¡Œèº«ä»½éªŒè¯æ“ä½œï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹éªŒè¯ç å®Œæˆæµç¨‹ï¼š</p><div style="background:#eff6ff;padding:20px;text-align:center;font-size:32px;font-weight:bold;color:#2563eb;letter-spacing:8px;margin:24px 0;border-radius:8px;border:1px dashed #bfdbfe">{code}</div><p style="color:#6b7280;font-size:13px;text-align:center">éªŒè¯ç  10 åˆ†é’Ÿå†…æœ‰æ•ˆã€‚è¯·å‹¿å°†æ­¤éªŒè¯ç æ³„éœ²ç»™ä»–äººã€‚</p>`)
            },
            reset_pwd: { 
                name: "é‡ç½®å¯†ç ", 
                subject: "é‡ç½®æ‚¨çš„è´¦æˆ·å¯†ç ", 
                body: wrap("é‡ç½®å¯†ç è¯·æ±‚", `<p style="color:#4b5563">æˆ‘ä»¬æ”¶åˆ°äº†é‡ç½®æ‚¨è´¦æˆ·å¯†ç çš„è¯·æ±‚ã€‚</p><p style="color:#4b5563">å¦‚æœæ˜¯æ‚¨æœ¬äººçš„æ“ä½œï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®¾ç½®æ–°å¯†ç ï¼š</p><center><a href="{reset_link}" class="btn" style="background-color:#dc2626">é‡ç½®å¯†ç </a></center><p style="margin-top:24px;color:#9ca3af;font-size:13px">å¦‚æœæ‚¨æ²¡æœ‰è¯·æ±‚é‡ç½®å¯†ç ï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ï¼Œæ‚¨çš„è´¦æˆ·æ˜¯å®‰å…¨çš„ã€‚</p>`)
            },
            order: { 
                name: "è®¢å•ç¡®è®¤", 
                subject: "æ‚¨çš„è®¢å• #{order_id} å·²ç¡®è®¤", 
                body: wrap("è®¢å•ç¡®è®¤ âœ…", `<p style="color:#4b5563">æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼æ‚¨çš„è®¢å•å·²å¤„ç†ã€‚</p><table style="width:100%;border-collapse:collapse;margin:20px 0;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden"><tr><td style="padding:12px;border-bottom:1px solid #e5e7eb;background:#f9fafb;color:#6b7280">è®¢å•å·</td><td style="padding:12px;border-bottom:1px solid #e5e7eb;text-align:right;font-weight:bold;color:#111827">#{order_id}</td></tr><tr><td style="padding:12px;background:#f9fafb;color:#6b7280">æ”¯ä»˜é‡‘é¢</td><td style="padding:12px;text-align:right;font-weight:bold;color:#059669">ï¿¥{amount}</td></tr></table><p style="color:#4b5563">æˆ‘ä»¬å°†åœ¨å‘è´§åå†æ¬¡é€šçŸ¥æ‚¨ã€‚</p>`)
            },
            shipping: { 
                name: "å‘è´§é€šçŸ¥", 
                subject: "ğŸ“¦ æ‚¨çš„åŒ…è£¹å·²å‘è´§ï¼", 
                body: wrap("åŒ…è£¹å·²å‘è´§", `<p style="color:#4b5563">æ‚¨å¥½ {username}ï¼Œ</p><p style="color:#4b5563">å¥½æ¶ˆæ¯ï¼æ‚¨çš„è®¢å• #{order_id} å·²ç»å‘è´§ã€‚</p><div style="background:#f3f4f6;padding:16px;border-radius:8px;margin:20px 0"><p style="margin:0;color:#6b7280;font-size:12px">ç‰©æµå•å·</p><p style="margin:4px 0 0 0;font-weight:bold;color:#111827;font-size:18px">{tracking_no}</p></div><center><a href="{tracking_link}" class="btn">è¿½è¸ªç‰©æµ</a></center>`)
            },
            activity: { 
                name: "æ´»åŠ¨æ¨å¹¿", 
                subject: "ğŸ”¥ é™æ—¶ç‰¹æƒ ï¼šå…¨åœº 8 æŠ˜èµ·ï¼", 
                body: wrap("å¹´ä¸­å¤§ä¿ƒæ¥è¢­", `<div style="background:linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);color:white;padding:30px;border-radius:8px;text-align:center;margin-bottom:20px"><h2 style="margin:0;font-size:28px">å…¨åœº 8 æŠ˜</h2><p style="margin:10px 0 0 0;opacity:0.9">é™æ—¶ 3 å¤© Â· æ¬²è´­ä»é€Ÿ</p></div><p style="color:#4b5563">äº²çˆ±çš„ç”¨æˆ·ï¼Œä¸ºäº†å›é¦ˆæ‚¨çš„æ”¯æŒï¼Œæˆ‘ä»¬æ¨å‡ºäº†å¹´åº¦æœ€å¼ºä¼˜æƒ ï¼</p><center><a href="{promo_link}" class="btn" style="background-color:#dc2626">ç«‹å³æŠ¢è´­</a></center>`)
            },
            holiday: { 
                name: "èŠ‚æ—¥é—®å€™", 
                subject: "ğŸ„ {app_name} ç¥æ‚¨èŠ‚æ—¥å¿«ä¹", 
                body: wrap("èŠ‚æ—¥å¿«ä¹", `<div style="text-align:center"><img src="https://img.icons8.com/color/96/000000/christmas-star.png" alt="icon" style="width:64px;height:64px;margin-bottom:20px"></div><p style="color:#4b5563;text-align:center;font-size:16px">åœ¨è¿™ä¸ªæ¸©é¦¨çš„æ—¶åˆ»ï¼Œæˆ‘ä»¬æƒ³å‘æ‚¨è‡´ä»¥æœ€è¯šæŒšçš„é—®å€™ã€‚<br>æ„Ÿè°¢æ‚¨ä¸€å¹´æ¥çš„é™ªä¼´ï¼Œæ„¿æ‚¨çš„ç”Ÿæ´»å……æ»¡çˆ±ä¸å–œæ‚¦ã€‚</p><br><p style="text-align:center;color:#6b7280">â€” {app_name} å›¢é˜Ÿ æ•¬ä¸Š</p>`)
            },
            recall: { 
                name: "ç”¨æˆ·å¬å›", 
                subject: "ğŸ‘‹ {username}ï¼Œå¥½ä¹…ä¸è§", 
                body: wrap("å¥½ä¹…ä¸è§", `<p style="color:#4b5563">äº²çˆ±çš„ {username}ï¼š</p><p style="color:#4b5563">æˆ‘ä»¬å‘ç°æ‚¨å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰ç™»å½•äº†ã€‚æœ€è¿‘æˆ‘ä»¬æ›´æ–°äº†è®¸å¤šæ–°åŠŸèƒ½ï¼Œç›¸ä¿¡æ‚¨ä¼šå–œæ¬¢ã€‚</p><div style="background:#fff7ed;border:1px solid #ffedd5;padding:16px;border-radius:8px;margin:20px 0;color:#c2410c"><strong>ğŸ ä¸“å±å›å½’ç¤¼åŒ…å·²æ”¾å…¥æ‚¨çš„è´¦æˆ·</strong></div><center><a href="{link}" class="btn">å›æ¥çœ‹çœ‹</a></center>`)
            },
            feedback: { 
                name: "é—®å·è°ƒæŸ¥", 
                subject: "ğŸ“ æˆ‘ä»¬æƒ³å¬å¬æ‚¨çš„å£°éŸ³", 
                body: wrap("æ»¡æ„åº¦è°ƒæŸ¥", `<p style="color:#4b5563">æ‚¨å¥½ï¼Œ</p><p style="color:#4b5563">ä¸ºäº†ç»™æ‚¨æä¾›æ›´å¥½çš„æœåŠ¡ï¼Œæˆ‘ä»¬è¯šé‚€æ‚¨å‚ä¸æœ¬æ¬¡æ»¡æ„åº¦è°ƒæŸ¥ã€‚æ‚¨çš„æ„è§å¯¹æˆ‘ä»¬è‡³å…³é‡è¦ã€‚</p><p style="color:#6b7280;font-size:13px">é¢„è®¡ç”¨æ—¶ï¼š1 åˆ†é’Ÿ</p><center><a href="{survey_link}" class="btn" style="background-color:#059669">å‚ä¸è°ƒæŸ¥</a></center>`)
            },
            system: { 
                name: "ç³»ç»Ÿé€šçŸ¥", 
                subject: "âš ï¸ ç³»ç»Ÿç»´æŠ¤é€šçŸ¥", 
                body: wrap("ç³»ç»Ÿç»´æŠ¤å…¬å‘Š", `<div style="background:#fffbeb;border-left:4px solid #f59e0b;padding:16px;margin-bottom:20px"><p style="margin:0;color:#92400e;font-weight:bold">ç»´æŠ¤æ—¶é—´ï¼š{time}</p></div><p style="color:#4b5563">å°Šæ•¬çš„ç”¨æˆ·ï¼š</p><p style="color:#4b5563">ä¸ºäº†æä¾›æ›´ç¨³å®šçš„æœåŠ¡ï¼Œæˆ‘ä»¬å°†è¿›è¡Œç³»ç»Ÿå‡çº§ç»´æŠ¤ã€‚</p><p style="color:#4b5563">ç»´æŠ¤æœŸé—´æœåŠ¡å¯èƒ½æ— æ³•è®¿é—®ï¼Œè¯·æ‚¨æå‰åšå¥½å®‰æ’ã€‚ç»™æ‚¨å¸¦æ¥çš„ä¸ä¾¿æ•¬è¯·è°…è§£ã€‚</p>`)
            }
        };

        function applyPreset(key) {
            if (presets[key]) {
                const t = presets[key];
                document.getElementById('tpl-name').value = t.name;
                document.getElementById('tpl-subject').value = t.subject;
                document.getElementById('tpl-body').value = t.body;
                updatePreview();
                showToast(I18n.t('templates.toast.preset_applied'));
            }
        }

        function updatePreview() {
            const html = document.getElementById('tpl-body').value;
            // ç®€å•æ¨¡æ‹Ÿå˜é‡æ›¿æ¢ï¼Œæ–¹ä¾¿é¢„è§ˆæ•ˆæœ
            const simulatedHtml = html
                .replace(/{username}/g, 'John Doe')
                .replace(/{app_name}/g, 'æ™´è¾°äº‘é‚®')
                .replace(/{code}/g, '123456')
                .replace(/{order_id}/g, '20260120001')
                .replace(/{amount}/g, '99.00')
                .replace(/{link}|{reset_link}|{promo_link}|{survey_link}/g, '#')
                .replace(/{tracking_no}/g, 'SF1000000000')
                .replace(/{tracking_link}/g, '#')
                .replace(/{time}/g, '2026-01-21 00:00 - 02:00');
                
            const iframe = document.getElementById('preview-frame');
            iframe.srcdoc = simulatedHtml;
        }

        function insertVariable(v) {
            const textarea = document.getElementById('tpl-body');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + v + text.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + v.length;
            updatePreview();
        }

        async function sendTest() {
            const subject = document.getElementById('tpl-subject').value;
            const body = document.getElementById('tpl-body').value;
            
            if (!body) {
                alert(I18n.t('templates.alert.body_empty'));
                return;
            }

            const email = prompt(I18n.t('templates.prompt.test_email'), "");
            if (email) {
                const testBody = body
                    .replace(/{username}/g, 'Test User')
                    .replace(/{app_name}/g, 'æ™´è¾°äº‘é‚®')
                    .replace(/{code}/g, '888888')
                    .replace(/{order_id}/g, 'TEST-001')
                    .replace(/{amount}/g, '0.01');

                try {
                    await request('/send', {
                        method: 'POST',
                        body: JSON.stringify({
                            to: email,
                            subject: "[æµ‹è¯•] " + subject,
                            body: testBody
                        })
                    });
                    showToast(I18n.t('templates.toast.test_sent'));
                } catch(e) {
                    // request handles error
                }
            }
        }

        function openModal() {
            document.getElementById('tpl-id').value = '';
            document.getElementById('tpl-form').reset();
            document.getElementById('modal-title').innerText = I18n.t('templates.modal.add_title');
            document.getElementById('preview-frame').srcdoc = '';
            document.getElementById('template-modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('template-modal').classList.add('hidden'); }

        async function loadTemplates() {
            try {
                const list = await request('/templates');
                templateList = list;
                const tbody = document.getElementById('template-list');
                tbody.innerHTML = '';

                if (list.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center text-gray-400"><span data-i18n="templates.table.empty">æš‚æ— æ¨¡æ¿ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ–°å»º</span></td></tr>`;
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                list.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 transition';

                    tr.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900">${Utils.escapeHtml(t.name)}</td>
                        <td class="px-6 py-4 text-gray-500 truncate max-w-xs">${Utils.escapeHtml(t.subject)}</td>
                        <td class="px-6 py-4 text-right text-gray-400 font-mono text-xs">${Utils.formatDate(t.created_at)}</td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button onclick="openPreview(${t.id})" class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded transition" data-i18n-attr="title:templates.action.preview" title="é¢„è§ˆ">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                            <button onclick="testTemplate(${t.id})" class="px-2 py-1 text-gray-500 hover:bg-gray-100 rounded transition" data-i18n-attr="title:templates.action.test" title="å‘é€æµ‹è¯•">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            </button>
                            <button onclick="editTemplate(${t.id})" class="px-2 py-1 text-blue-600 hover:bg-blue-50 rounded transition font-medium text-sm" data-i18n="templates.action.edit">ç¼–è¾‘</button>
                            <button onclick="deleteTemplate(${t.id})" class="px-2 py-1 text-red-500 hover:bg-red-50 rounded transition text-sm" data-i18n="templates.action.delete">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) {}
        }

        function editTemplate(id) {
            const t = templateList.find(item => item.id === id);
            if (!t) return;

            document.getElementById('tpl-id').value = t.id;
            document.getElementById('tpl-name').value = t.name;
            document.getElementById('tpl-subject').value = t.subject;
            document.getElementById('tpl-body').value = t.body;
            document.getElementById('modal-title').innerText = I18n.t('templates.modal.edit_title');
            updatePreview();
            document.getElementById('template-modal').classList.remove('hidden');
        }

        async function saveTemplate(e) {
            e.preventDefault();
            const id = document.getElementById('tpl-id').value;
            const data = {
                name: document.getElementById('tpl-name').value,
                subject: document.getElementById('tpl-subject').value,
                body: document.getElementById('tpl-body').value
            };

            try {
                if (id) {
                    await request(`/templates/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await request('/templates', { method: 'POST', body: JSON.stringify(data) });
                }
                closeModal();
                loadTemplates();
                showToast(I18n.t('common.success'));
            } catch (err) {}
        }

        async function deleteTemplate(id) {
            if (confirm(I18n.t('templates.alert.delete_confirm'))) {
                try {
                    await request(`/templates/${id}`, { method: 'DELETE' });
                    loadTemplates();
                    showToast(I18n.t('common.deleted'));
                } catch (e) {}
            }
        }

        loadTemplates();
    </script>
</body>
</html>
