<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åŸŸåç®¡ç† - æ™´è¾°äº‘é‚®</title>
    <link href="/dashboard/css/tailwind.min.css?v=8.0" rel="stylesheet">
    <script src="/dashboard/js/loader.js?v=8.0"></script>
    <script src="/dashboard/js/common.js?v=8.0"></script>
    <script src="/dashboard/js/layout.js?v=8.0"></script>
</head>
<body class="hidden" data-i18n-module="domains">
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-gray-800" data-i18n="domains.title">åŸŸåç®¡ç†</h2>
            <p class="text-gray-500 mt-1" data-i18n="domains.subtitle">é…ç½®å‘ä¿¡åŸŸåä¸ DNS éªŒè¯</p>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="openCertDrawer()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition shadow-sm flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                <span data-i18n="domains.cert_drawer_btn">è¯ä¹¦å¤¹</span>
            </button>
            <button onclick="openModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                <span data-i18n="domains.add_btn">æ·»åŠ åŸŸå</span>
            </button>
        </div>
    </div>

    <!-- åŸŸååˆ—è¡¨å®¹å™¨ -->
    <div id="domain-list" class="space-y-6">
        <!-- åŸŸåå¡ç‰‡ç”± JS åŠ¨æ€ç”Ÿæˆ -->
        <div class="text-center py-16">
            <svg class="animate-spin h-8 w-8 mx-auto mb-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-500" data-i18n="common.loading">åŠ è½½ä¸­...</span>
        </div>
    </div>

    <!-- è¯ä¹¦å¤¹ä¾§è¾¹æ  -->
    <div id="cert-drawer" class="fixed inset-y-0 right-0 w-[600px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <div class="p-6 border-b flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    <span data-i18n="certs.title">SSL è¯ä¹¦ç®¡ç†</span>
                </h3>
                <p class="text-sm text-gray-500 mt-1" data-i18n="certs.subtitle">ç®¡ç†ç”¨äº STARTTLS å’Œ HTTPS çš„è¯ä¹¦</p>
            </div>
            <button onclick="closeCertDrawer()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div class="p-4 border-b bg-white flex space-x-3">
            <button onclick="openUploadCertModal()" class="flex-1 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span data-i18n="certs.upload_btn">ä¸Šä¼ è¯ä¹¦</span>
            </button>
            <button onclick="openAcmeModal()" class="flex-1 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span data-i18n="certs.apply_btn">ä¸€é”®ç”³è¯· (å…è´¹)</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <div id="cert-list" class="space-y-4">
                <!-- è¯ä¹¦åˆ—è¡¨åŠ è½½ä¸­ -->
                <div class="text-center py-8 text-gray-500">
                    <svg class="animate-spin h-8 w-8 mx-auto mb-4 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span data-i18n="common.loading">åŠ è½½ä¸­...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åŸŸåæ¨¡æ€æ¡† -->
    <div id="domain-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 w-[500px] shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800" data-i18n="domains.modal.add_title">æ·»åŠ å‘ä¿¡åŸŸå</h3>
            <div class="mb-6 bg-blue-50 text-blue-700 text-sm p-4 rounded-lg flex items-start">
                <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p data-i18n="domains.modal.add_desc">ç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆ SPFã€DKIM å’Œ DMARC è®°å½•ã€‚è¯·ç¡®ä¿æ‚¨æ‹¥æœ‰è¯¥åŸŸåçš„ DNS ç®¡ç†æƒé™ã€‚</p>
            </div>
            <form onsubmit="saveDomain(event)">
                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.domain_label">åŸŸå</label>
                <input type="text" id="domain-name" required placeholder="ä¾‹å¦‚: newsletter.example.com" pattern="^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$" title="è¯·è¾“å…¥æœ‰æ•ˆçš„åŸŸåæ ¼å¼" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none mb-6">
                
                <!-- åˆå§‹é…ç½®: é‚®ä»¶å­åŸŸå -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.prefix_label">é‚®ä»¶æœåŠ¡å™¨å‰ç¼€ (å¯é€‰)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="domain-prefix" data-i18n-attr="placeholder:domains.modal.prefix_ph" placeholder="é»˜è®¤ä¸ºä¸»åŸŸå (@)" class="w-32 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <span class="text-gray-400 text-sm">.your-domain.com</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" data-i18n="domains.modal.prefix_hint">æ¨èå¡« "mail" æˆ– "smtp"ã€‚ç•™ç©ºåˆ™ä½¿ç”¨ä¸»åŸŸåã€‚</p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">å–æ¶ˆ</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition" data-i18n="common.next">ä¸‹ä¸€æ­¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ è½¬å‘è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="forward-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 w-[550px] shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800" data-i18n="domains.modal.fwd_title">æ·»åŠ é‚®ä»¶è½¬å‘è§„åˆ™</h3>
            <div class="mb-4 bg-indigo-50 text-indigo-700 text-sm p-4 rounded-lg flex items-start">
                <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                    <p class="font-medium mb-1" data-i18n="domains.modal.fwd_desc_title">è½¬å‘è§„åˆ™è¯´æ˜</p>
                    <p data-i18n="domains.modal.fwd_desc">å½“æœ‰é‚®ä»¶å‘é€åˆ°åŸŸåé‚®ç®±æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½¬å‘åˆ°æŒ‡å®šçš„ç›®æ ‡é‚®ç®±ã€‚éœ€è¦å…ˆåœ¨ DNS æ·»åŠ  MX è®°å½•æŒ‡å‘æœ¬æœåŠ¡å™¨ï¼Œå¹¶å¯ç”¨æ¥æ”¶æœåŠ¡ã€‚</p>
                </div>
            </div>
            <form onsubmit="saveForwardRule(event)">
                <input type="hidden" id="forward-domain-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.match_type">åŒ¹é…æ¨¡å¼</label>
                    <select id="forward-match-type" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" onchange="updateMatchAddrPlaceholder()">
                        <option value="all" data-i18n="domains.match.all">å…¨éƒ¨ - æ¥æ”¶æ‰€æœ‰å‘å¾€è¯¥åŸŸåçš„é‚®ä»¶</option>
                        <option value="exact" data-i18n="domains.match.exact">ç²¾ç¡®åŒ¹é… - ä»…åŒ¹é…æŒ‡å®šåœ°å€</option>
                        <option value="prefix" data-i18n="domains.match.prefix">å‰ç¼€åŒ¹é… - åŒ¹é…ä»¥æŒ‡å®šå‰ç¼€å¼€å¤´çš„åœ°å€</option>
                    </select>
                </div>
                <div class="mb-4" id="match-addr-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.match_addr">åŒ¹é…åœ°å€</label>
                    <div class="flex items-center">
                        <input type="text" id="forward-match-addr" placeholder="ä¾‹å¦‚: support" class="flex-1 border rounded-l-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <span id="forward-domain-suffix" class="bg-gray-100 border border-l-0 rounded-r-lg px-3 py-2 text-gray-500">@example.com</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" data-i18n="domains.modal.match_hint">ç•™ç©ºè¡¨ç¤ºåŒ¹é…æ‰€æœ‰åœ°å€ï¼ˆä»…é™"å…¨éƒ¨"æ¨¡å¼ï¼‰</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.forward_to">è½¬å‘åˆ° <span class="text-red-500">*</span></label>
                    <input type="email" id="forward-to" required placeholder="ä¾‹å¦‚: your-email@gmail.com" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.remark">å¤‡æ³¨</label>
                    <input type="text" id="forward-remark" data-i18n-attr="placeholder:domains.modal.remark_ph" placeholder="å¯é€‰å¤‡æ³¨" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeForwardModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">å–æ¶ˆ</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md transition" data-i18n="domains.modal.save_rule">ä¿å­˜è§„åˆ™</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è¯ä¹¦å¤¹ä¾§è¾¹æ  -->
    <div id="cert-drawer-backdrop" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40" onclick="closeCertDrawer()"></div>
    <div id="cert-drawer" class="fixed inset-y-0 right-0 w-[420px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <!-- å¤´éƒ¨ -->
        <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
            <h3 class="text-lg font-bold flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                <span data-i18n="domains.cert.drawer_title">è¯ä¹¦å¤¹</span>
            </h3>
            <button onclick="closeCertDrawer()" class="hover:bg-white/20 rounded p-1 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="p-4 border-b flex space-x-2">
            <button onclick="openUploadCertModal()" class="flex-1 bg-emerald-600 text-white px-3 py-2 rounded-lg hover:bg-emerald-700 transition text-sm flex items-center justify-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span data-i18n="domains.cert.upload_btn">ä¸Šä¼ è¯ä¹¦</span>
            </button>
            <button onclick="openAcmeModal()" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition text-sm flex items-center justify-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <span data-i18n="domains.cert.acme_btn">ç”³è¯·å…è´¹è¯ä¹¦</span>
            </button>
        </div>
        
        <!-- è¯ä¹¦åˆ—è¡¨ -->
        <div id="cert-list" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div class="text-center text-gray-400 py-8">
                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <p data-i18n="domains.cert.loading">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ è¯ä¹¦æ¨¡æ€æ¡† -->
    <div id="upload-cert-modal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-[550px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-xl mb-4 text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span data-i18n="domains.cert.upload_title">ä¸Šä¼  SSL è¯ä¹¦</span>
            </h3>
            <form onsubmit="uploadCertificate(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.cert.name_label">è¯ä¹¦åç§° (å¯é€‰)</label>
                    <input type="text" id="cert-name" placeholder="ä¾‹å¦‚: mail.example.com" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <span data-i18n="domains.cert.cert_pem_label">è¯ä¹¦å†…å®¹ (PEM æ ¼å¼)</span>
                        <span class="text-red-500">*</span>
                    </label>
                    <textarea id="cert-pem" required rows="6" placeholder="-----BEGIN CERTIFICATE-----&#10;...&#10;-----END CERTIFICATE-----" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-xs"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <span data-i18n="domains.cert.key_pem_label">ç§é’¥å†…å®¹ (PEM æ ¼å¼)</span>
                        <span class="text-red-500">*</span>
                    </label>
                    <textarea id="key-pem" required rows="6" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-xs"></textarea>
                </div>
                <div class="bg-amber-50 text-amber-700 text-xs p-3 rounded-lg mb-4">
                    <p class="font-medium mb-1" data-i18n="domains.cert.upload_tip_title">æç¤º</p>
                    <p data-i18n="domains.cert.upload_tip">ä¸Šä¼ åç³»ç»Ÿä¼šè‡ªåŠ¨è§£æè¯ä¹¦ä¿¡æ¯ï¼ˆåŸŸåã€æœ‰æ•ˆæœŸç­‰ï¼‰ã€‚ç§é’¥å°†åŠ å¯†å­˜å‚¨ã€‚</p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeUploadCertModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">å–æ¶ˆ</button>
                    <button type="submit" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-md transition" data-i18n="domains.cert.upload_submit">ä¸Šä¼ è¯ä¹¦</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç»‘å®šè¯ä¹¦æ¨¡æ€æ¡† -->
    <div id="bind-cert-modal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-[500px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-xl mb-4 text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                <span data-i18n="domains.cert.bind_title">ç»‘å®š SSL è¯ä¹¦</span>
            </h3>
            <input type="hidden" id="bind-cert-domain-id">
            <p class="text-sm text-gray-500 mb-4" data-i18n="domains.cert.bind_desc">é€‰æ‹©ä¸€ä¸ªè¯ä¹¦ç»‘å®šåˆ°æ­¤åŸŸåï¼Œç”¨äº STARTTLS é‚®ä»¶åŠ å¯†ä¼ è¾“ã€‚</p>
            
            <!-- å½“å‰ç»‘å®šçŠ¶æ€ -->
            <div id="current-cert-info" class="hidden mb-4 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                <p class="text-sm text-emerald-700 font-medium mb-1" data-i18n="domains.cert.current_cert">å½“å‰ç»‘å®šè¯ä¹¦:</p>
                <p id="current-cert-name" class="text-sm text-emerald-600"></p>
                <button type="button" onclick="unbindCertificate()" class="mt-2 text-xs text-red-500 hover:text-red-700" data-i18n="domains.cert.unbind">è§£é™¤ç»‘å®š</button>
            </div>
            
            <!-- è¯ä¹¦åˆ—è¡¨ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="domains.cert.select_cert">é€‰æ‹©è¯ä¹¦</label>
                <div id="cert-select-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <div class="text-center text-gray-400 py-4" data-i18n="common.loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
            
            <!-- å¿«æ·æ“ä½œ -->
            <div class="flex space-x-2 mb-4">
                <button type="button" onclick="closeBindCertModal(); openUploadCertModal();" class="flex-1 text-sm px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
                    <span data-i18n="domains.cert.upload_new">ä¸Šä¼ æ–°è¯ä¹¦</span>
                </button>
                <button type="button" onclick="closeBindCertModal(); openAcmeModal();" class="flex-1 text-sm px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">
                    <span data-i18n="domains.cert.apply_new">ç”³è¯·å…è´¹è¯ä¹¦</span>
                </button>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="closeBindCertModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ACME ç”³è¯·è¯ä¹¦æ¨¡æ€æ¡† -->
    <div id="acme-modal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-[550px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-xl mb-4 text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <span data-i18n="domains.cert.acme_title">ç”³è¯·å…è´¹ SSL è¯ä¹¦</span>
            </h3>
            
            <!-- æ­¥éª¤ 1: å¡«å†™ä¿¡æ¯ -->
            <div id="acme-step1">
                <div class="bg-blue-50 text-blue-700 text-sm p-3 rounded-lg mb-4">
                    <p class="font-medium mb-1">Let's Encrypt å…è´¹è¯ä¹¦</p>
                    <p data-i18n="domains.cert.acme_desc">ä½¿ç”¨ DNS-01 éªŒè¯æ–¹å¼ç”³è¯·è¯ä¹¦ï¼Œæ— éœ€å¼€æ”¾ 80/443 ç«¯å£ã€‚è¯ä¹¦æœ‰æ•ˆæœŸ 90 å¤©ï¼Œåˆ°æœŸå‰å¯ç»­æœŸã€‚</p>
                </div>
                <form onsubmit="initAcmeChallenge(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <span data-i18n="domains.cert.acme_domain">åŸŸå</span>
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="acme-domain" required placeholder="ä¾‹å¦‚: mail.example.com" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <span data-i18n="domains.cert.acme_email">é‚®ç®±</span>
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="email" id="acme-email" required placeholder="ç”¨äºæ¥æ”¶è¯ä¹¦åˆ°æœŸé€šçŸ¥" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeAcmeModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">å–æ¶ˆ</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition" data-i18n="domains.cert.acme_init">å¼€å§‹ç”³è¯·</button>
                    </div>
                </form>
            </div>
            
            <!-- æ­¥éª¤ 2: æ·»åŠ  DNS è®°å½• -->
            <div id="acme-step2" class="hidden">
                <div class="bg-amber-50 text-amber-700 text-sm p-4 rounded-lg mb-4">
                    <p class="font-medium mb-2" data-i18n="domains.cert.acme_dns_title">è¯·æ·»åŠ ä»¥ä¸‹ DNS TXT è®°å½•</p>
                    <div class="bg-white rounded p-3 font-mono text-xs space-y-2">
                        <div>
                            <span class="text-gray-500">è®°å½•ç±»å‹:</span> <span class="font-bold">TXT</span>
                        </div>
                        <div>
                            <span class="text-gray-500">ä¸»æœºè®°å½•:</span> <span id="acme-txt-record" class="font-bold select-all">-</span>
                            <button onclick="copyToClipboard(document.getElementById('acme-txt-record').innerText)" class="ml-2 text-blue-500 hover:text-blue-700">å¤åˆ¶</button>
                        </div>
                        <div>
                            <span class="text-gray-500">è®°å½•å€¼:</span> <span id="acme-txt-value" class="font-bold select-all break-all">-</span>
                            <button onclick="copyToClipboard(document.getElementById('acme-txt-value').innerText)" class="ml-2 text-blue-500 hover:text-blue-700">å¤åˆ¶</button>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-4" data-i18n="domains.cert.acme_dns_hint">æ·»åŠ  DNS è®°å½•åï¼Œè¯·ç­‰å¾… 1-5 åˆ†é’Ÿè®© DNS ç”Ÿæ•ˆï¼Œç„¶åç‚¹å‡»éªŒè¯ã€‚</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="cancelAcmeChallenge()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">å–æ¶ˆ</button>
                    <button type="button" onclick="verifyAcmeChallenge()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition" data-i18n="domains.cert.acme_verify">éªŒè¯å¹¶è·å–è¯ä¹¦</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        Auth.check();

        function openModal() { document.getElementById('domain-modal').classList.remove('hidden'); document.getElementById('domain-name').value = ''; document.getElementById('domain-prefix').value = 'mail'; }
        function closeModal() { document.getElementById('domain-modal').classList.add('hidden'); }

        // é˜²æŠ–å‡½æ•°ï¼Œç”¨äºè‡ªåŠ¨ä¿å­˜
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function loadDomains() {
            try {
                const list = await request('/domains');
                const container = document.getElementById('domain-list');
                container.innerHTML = '';

                if (list.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                            <p class="text-gray-500 text-lg" data-i18n="domains.empty_title">æš‚æ— é…ç½®åŸŸå</p>
                            <button onclick="openModal()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium" data-i18n="domains.empty_btn">ç«‹å³æ·»åŠ ç¬¬ä¸€ä¸ªåŸŸå</button>
                        </div>`;
                    
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                list.forEach(d => {
                    const statusBadge = (verified, label) => 
                        `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${verified ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                            <span class="w-2 h-2 rounded-full mr-1.5 ${verified ? 'bg-green-500' : 'bg-gray-400'}"></span>
                            ${label}: <span data-i18n="${verified ? 'domains.status.verified' : 'domains.status.unverified'}">${verified ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}</span>
                        </span>`;

                    // åˆå§‹åŒ–å‰ç¼€ï¼ˆå¦‚æœæ˜¯æ—§æ•°æ®æ²¡å­—æ®µï¼Œé»˜è®¤ä¸ºç©ºï¼‰
                    const prefix = d.mail_subdomain_prefix || '';

                    // ç”Ÿæˆè¯ä¹¦çŠ¶æ€å¾½ç« 
                    const certStatusBadge = (status, daysLeft, certDomains, domainId) => {
                        const configs = {
                            'valid': { bg: 'bg-emerald-100', text: 'text-emerald-700', dot: 'bg-emerald-500', icon: 'ğŸ”’', label: `SSL: ${daysLeft}å¤©` },
                            'warning': { bg: 'bg-yellow-100', text: 'text-yellow-700', dot: 'bg-yellow-500', icon: 'âš ï¸', label: `SSL: ${daysLeft}å¤©` },
                            'critical': { bg: 'bg-red-100', text: 'text-red-700', dot: 'bg-red-500', icon: 'ğŸ”´', label: `SSL: ${daysLeft}å¤©` },
                            'expired': { bg: 'bg-gray-100', text: 'text-gray-500', dot: 'bg-gray-400', icon: 'âŒ', label: 'SSL: å·²è¿‡æœŸ' },
                            'none': { bg: 'bg-gray-100', text: 'text-gray-500', dot: 'bg-gray-300', icon: 'ğŸ”“', label: 'SSL: æœªç»‘å®š' }
                        };
                        const cfg = configs[status] || configs['none'];
                        const tooltip = certDomains ? `è¯ä¹¦åŸŸå: ${certDomains}` : 'ç‚¹å‡»ç»‘å®šè¯ä¹¦';
                        return `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${cfg.bg} ${cfg.text} cursor-pointer hover:opacity-80 transition" 
                                  title="${tooltip}" onclick="openBindCertModal(${domainId})">
                                <span class="mr-1">${cfg.icon}</span>
                                ${cfg.label}
                            </span>`;
                    };

                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden';
                    div.innerHTML = `
                        <div class="p-6 border-b border-gray-100 flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                                    ${d.name}
                                    <span class="ml-3 text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded">ID: ${d.id}</span>
                                </h3>
                                <div class="flex flex-wrap gap-2 mt-3">
                                    ${statusBadge(d.spf_verified, 'SPF')}
                                    ${statusBadge(d.dkim_verified, 'DKIM')}
                                    ${statusBadge(d.dmarc_verified, 'DMARC')}
                                    ${statusBadge(d.mx_verified, 'MX')}
                                    <span id="badge-a-${d.id}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                        <span class="w-2 h-2 rounded-full mr-1.5 bg-gray-400"></span> <span data-i18n="domains.status.a_checking">Aè®°å½•: æ£€æµ‹ä¸­...</span>
                                    </span>
                                    ${certStatusBadge(d.cert_status, d.cert_days_left, d.cert_domains, d.id)}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="openBindCertModal(${d.id})" class="px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded hover:bg-emerald-100 transition text-sm font-medium flex items-center" title="${d.cert_status === 'none' ? 'ç»‘å®šè¯ä¹¦' : 'æ›´æ¢è¯ä¹¦'}">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                                    <span data-i18n="domains.action.bind_cert">${d.cert_status === 'none' ? 'ç»‘å®šè¯ä¹¦' : 'è¯ä¹¦'}</span>
                                </button>
                                <button onclick="verifyDomain(${d.id})" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100 transition text-sm font-medium" data-i18n="domains.action.refresh">åˆ·æ–°çŠ¶æ€</button>
                                <button onclick="deleteDomain(${d.id})" class="px-3 py-1.5 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition text-sm" data-i18n="domains.action.delete">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50">
                            <div class="mb-6 flex justify-between items-end">
                                <div>
                                    <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-1" data-i18n="domains.dns.title">DNS é…ç½®è®°å½•</h4>
                                    <p class="text-xs text-gray-500" data-i18n="domains.dns.subtitle">è¯·åœ¨æ‚¨çš„ DNS æœåŠ¡å•†å¤„æ·»åŠ ä»¥ä¸‹è®°å½•</p>
                                </div>
                                <div class="flex items-center bg-white border rounded-lg px-3 py-2 shadow-sm">
                                    <span class="text-xs text-gray-500 mr-2" data-i18n="domains.dns.mail_server">é‚®ä»¶æœåŠ¡å™¨åœ°å€:</span>
                                    <div class="relative">
                                        <input type="text" 
                                            id="prefix-input-${d.id}" 
                                            value="${prefix}" 
                                            data-i18n-attr="placeholder:domains.modal.prefix_ph"
                                            placeholder="@ (ä¸»åŸŸå)"
                                            class="w-24 text-sm font-medium text-gray-800 outline-none text-right placeholder-gray-300"
                                            oninput="handlePrefixChange(${d.id}, '${d.name}', this.value)"
                                        >
                                        <div class="absolute right-0 -bottom-5 text-[10px] text-green-600 transition-opacity opacity-0" id="save-tip-${d.id}" data-i18n="domains.dns.saved">å·²ä¿å­˜</div>
                                    </div>
                                    <span class="text-sm text-gray-400 ml-1">.${d.name}</span>
                                </div>
                            </div>

                            <div class="space-y-3" id="dns-records-${d.id}">
                                <!-- åŠ¨æ€å†…å®¹ç”± updateDNSRecords æ¸²æŸ“ -->
                            </div>

                            <!-- SPF/DKIM/DMARC -->
                            <div class="space-y-3 mt-3">
                                <!-- SPF è®°å½• (åŠ¨æ€ ID) -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">@</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="spf-${d.id}"></div>
                                    </div>
                                    <button onclick="copyText('spf-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="å¤åˆ¶è®°å½•å€¼">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>

                                <!-- DKIM è®°å½• -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">default._domainkey</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="dkim-${d.id}">v=DKIM1; k=rsa; p=${d.dkim_public_key.replace(/-----.*-----|\n/g, '')}</div>
                                    </div>
                                    <button onclick="copyText('dkim-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="å¤åˆ¶è®°å½•å€¼">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>

                                <!-- DMARC è®°å½• -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">_dmarc</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="dmarc-${d.id}">v=DMARC1; p=none; rua=mailto:postmaster@${d.name}</div>
                                    </div>
                                    <button onclick="copyText('dmarc-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="å¤åˆ¶è®°å½•å€¼">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>
                            </div>

                            <!-- å¤‡æ¡ˆæç¤º -->
                            <div class="mt-4 bg-orange-50 border border-orange-100 rounded-lg p-3 text-xs text-orange-700 flex items-start">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                <div>
                                    <p class="font-medium">âš ï¸ <span data-i18n="domains.icp.title">å¤‡æ¡ˆæç¤º</span>ï¼š</p>
                                    <p data-i18n="domains.icp.desc1">å¦‚æœæ‚¨çš„æœåŠ¡å™¨åœ¨ä¸­å›½å¤§é™†ï¼Œä¸”åŸŸåæœªå¤‡æ¡ˆï¼Œå¯èƒ½ä¼šå¯¼è‡´ 80/443 ç«¯å£ï¼ˆç½‘ç«™è®¿é—®ï¼‰è¢«æ‹¦æˆªã€‚</p>
                                    <p class="mt-1" data-i18n="domains.icp.desc2">ä½†è¿™ä¸ä¼šå½±å“é‚®ä»¶æ”¶å‘åŠŸèƒ½ï¼ˆä½¿ç”¨ SMTP/25 ç«¯å£ï¼‰ã€‚åªè¦ DNS è§£ææ­£ç¡®ï¼Œé‚®ä»¶æœåŠ¡å³å¯æ­£å¸¸è¿è¡Œã€‚</p>
                                </div>
                            </div>
                            
                            <!-- è½¬å‘è§„åˆ™... (çœç•¥ä¿æŒä¸å˜) -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 flex justify-between items-center">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                        <span data-i18n="domains.forward.title">é‚®ä»¶è½¬å‘è§„åˆ™</span>
                                    </span>
                                    <button onclick="openForwardModal(${d.id}, '${d.name}')" class="text-xs font-medium text-indigo-600 hover:text-indigo-800 flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        <span data-i18n="domains.forward.add">æ·»åŠ è§„åˆ™</span>
                                    </button>
                                </h4>
                                <div id="forward-rules-${d.id}" class="space-y-2">
                                    <div class="text-sm text-gray-400 italic">åŠ è½½ä¸­...</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                    // æ¸²æŸ“åˆå§‹ DNS è®°å½•
                    updateDNSRecords(d.id, d.name, prefix);
                    // æ£€æŸ¥ A è®°å½•
                    checkARecord(prefix ? `${prefix}.${d.name}` : d.name, d.id);
                    // åŠ è½½è½¬å‘è§„åˆ™
                    loadForwardRules(d.id, d.name);
                });
                
                // æ¸²æŸ“æ‰€æœ‰ç”Ÿæˆçš„ data-i18n
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();

            } catch (e) {
                console.error(e);
            }
        }

        // å¤„ç†å‰ç¼€å˜æ›´ï¼ˆè¾“å…¥æ¡†è¾“å…¥æ—¶è§¦å‘ï¼‰
        const savePrefixDebounced = debounce(async (id, prefix) => {
            try {
                await request(`/domains/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ mail_subdomain_prefix: prefix })
                });
                // æ˜¾ç¤ºâ€œå·²ä¿å­˜â€æç¤º
                const tip = document.getElementById(`save-tip-${id}`);
                tip.style.opacity = '1';
                setTimeout(() => tip.style.opacity = '0', 2000);
            } catch (err) {
                showToast('è‡ªåŠ¨ä¿å­˜å¤±è´¥', 'error');
            }
        }, 800); // å»¶è¿Ÿ 800ms ä¿å­˜

        function handlePrefixChange(id, domainName, value) {
            // 1. æ›´æ–° UI
            updateDNSRecords(id, domainName, value);
            // 2. è§¦å‘ A è®°å½•æ£€æŸ¥
            const host = value ? `${value}.${domainName}` : domainName;
            checkARecord(host, id);
            // 3. è§¦å‘åç«¯ä¿å­˜
            savePrefixDebounced(id, value);
        }

        async function saveDomain(e) {
            e.preventDefault();
            const name = document.getElementById('domain-name').value;
            const prefix = document.getElementById('domain-prefix').value;
            try {
                // å…ˆåˆ›å»º
                const res = await request('/domains', { method: 'POST', body: JSON.stringify({ name }) });
                // å¦‚æœæœ‰å‰ç¼€ï¼Œç«‹å³æ›´æ–°
                if (prefix && res.id) {
                    await request(`/domains/${res.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ mail_subdomain_prefix: prefix })
                    });
                }
                closeModal();
                loadDomains();
                showToast(I18n.t('domains.toast.add_success'));
            } catch (err) {
                showToast(err.message || 'æ·»åŠ å¤±è´¥', 'error');
            }
        }

        async function verifyDomain(id) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = I18n.t('domains.action.verifying');
            btn.disabled = true;
            try {
                await request(`/domains/${id}/verify`, { method: 'POST' });
                await loadDomains();
                showToast(I18n.t('domains.toast.verified'));
            } catch (e) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function deleteDomain(id) {
            if (confirm(I18n.t('domains.alert.delete_confirm'))) {
                try {
                    await request(`/domains/${id}`, { method: 'DELETE' });
                    loadDomains();
                    showToast(I18n.t('common.success'));
                } catch (e) {}
            }
        }

        // ========== é€šç”¨å‡½æ•° (Copy, CheckA, Render) ==========

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast('å·²å¤åˆ¶')).catch(() => fallbackCopyText(text));
            } else {
                fallbackCopyText(text);
            }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy') ? showToast('å·²å¤åˆ¶') : showToast('å¤åˆ¶å¤±è´¥', 'error');
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            }
            document.body.removeChild(textArea);
        }

        function updateDNSRecords(id, domainName, prefix) {
            const container = document.getElementById(`dns-records-${id}`);
            if (!container) return;

            const hostname = window.location.hostname;
            // å¦‚æœ prefix ä¸ºç©ºï¼Œè¡¨ç¤ºç”¨ä¸»åŸŸå @ï¼›å¦åˆ™ç”¨ prefix
            const aRecordHost = prefix ? prefix : '@';
            const mxRecordValue = prefix ? `${prefix}.${domainName}` : domainName;
            
            // ä¼˜åŒ– SPF: ç›´æ¥ä½¿ç”¨ ip4 æœºåˆ¶ï¼Œæ¯” mx æœºåˆ¶æ›´ç¨³å®šï¼Œä¸å— MX è§£æå»¶è¿Ÿå½±å“
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åŠ¨æ€æ›´æ–° SPF æ˜¾ç¤ºï¼Œä½†ä¸ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå› ä¸ºåç«¯éªŒè¯ä¹Ÿæ˜¯åŠ¨æ€çš„
            const spfValue = `v=spf1 ip4:${hostname} -all`;
            
            // æ›´æ–° SPF å®¹å™¨ (å¦‚æœå­˜åœ¨)
            const spfContainer = document.getElementById(`spf-${id}`);
            if (spfContainer) {
                spfContainer.innerText = spfValue;
            }

            container.innerHTML = `
                <!-- A è®°å½• -->
                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative border-l-4 border-l-blue-500">
                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1 font-bold">A</div>
                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">${aRecordHost}</div>
                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all flex items-center">
                            <span id="a-${id}" class="bg-gray-50 px-1 rounded border border-gray-200">${hostname}</span>
                            <span class="text-gray-400 ml-2 text-[10px] hidden sm:inline-block">â† <span data-i18n="domains.dns.server_ip">æ‚¨çš„æœåŠ¡å™¨IP</span></span>
                        </div>
                    </div>
                    <button onclick="copyText('a-${id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="å¤åˆ¶ IP">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    </button>
                </div>

                <!-- MX è®°å½• -->
                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">MX</div>
                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">@</div>
                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all flex items-center">
                            <span id="mx-${id}" class="bg-gray-50 px-1 rounded border border-gray-200">${mxRecordValue}</span>
                            <span class="text-gray-400 ml-2 text-[10px] hidden sm:inline-block">â† <span data-i18n="domains.dns.priority_10">ä¼˜å…ˆçº§ 10</span></span>
                        </div>
                    </div>
                    <button onclick="copyText('mx-${id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="å¤åˆ¶åŸŸå">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    </button>
                </div>
            `;
        }

        async function checkARecord(hostname, id) {
            const badge = document.getElementById(`badge-a-${id}`);
            if (!badge) return;

            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-yellow-500"></span> <span data-i18n="domains.status.a_local">Aè®°å½•: æœ¬åœ°ç¯å¢ƒ</span>`;
                // è¿™é‡Œä¹Ÿéœ€è¦ render å—ï¼ŸupdateDNSRecords æ˜¯åŒæ­¥çš„ï¼ŒcheckARecord æ˜¯å¼‚æ­¥çš„ã€‚
                // å¦‚æœ checkARecord æ‰§è¡Œæ…¢äº†ï¼Œä¸Šé¢çš„ I18n.render() å·²ç»è·‘å®Œäº†ã€‚
                // æ‰€ä»¥è¿™é‡Œæ›´æ–° HTML åï¼Œéœ€è¦å†æ¬¡ renderã€‚
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                return;
            }

            badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600';
            badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-gray-400"></span> <span data-i18n="domains.status.a_checking">Aè®°å½•: æ£€æµ‹ä¸­...</span>`;
            if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();

            try {
                const response = await fetch(`https://cloudflare-dns.com/dns-query?name=${hostname}&type=A`, {
                    headers: { 'Accept': 'application/dns-json' }
                });
                const data = await response.json();
                
                if (data.Answer && data.Answer.some(r => r.type === 1)) {
                    badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-green-500"></span> <span data-i18n="domains.status.a_ok">Aè®°å½•: å·²è§£æ</span>`;
                } else {
                    badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-red-500"></span> <span data-i18n="domains.status.a_missing">Aè®°å½•: æœªæ‰¾åˆ°</span>`;
                }
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) { console.error(e); }
        }

        // ========== è½¬å‘è§„åˆ™é€»è¾‘ ==========

        let currentForwardDomainName = '';

        function openForwardModal(domainId, domainName) {
            document.getElementById('forward-modal').classList.remove('hidden');
            document.getElementById('forward-domain-id').value = domainId;
            document.getElementById('forward-match-type').value = 'all';
            document.getElementById('forward-match-addr').value = '';
            document.getElementById('forward-to').value = '';
            document.getElementById('forward-remark').value = '';
            currentForwardDomainName = domainName;
            updateMatchAddrPlaceholder();
        }

        function closeForwardModal() {
            document.getElementById('forward-modal').classList.add('hidden');
        }

        function updateMatchAddrPlaceholder() {
            const matchType = document.getElementById('forward-match-type').value;
            const addrGroup = document.getElementById('match-addr-group');
            const addrInput = document.getElementById('forward-match-addr');
            
            if (matchType === 'all') {
                addrGroup.style.display = 'none';
            } else {
                addrGroup.style.display = 'block';
                if (matchType === 'exact') {
                    addrInput.placeholder = I18n.t('domains.match.exact'); // å®é™…ä¸Šè¿™é‡Œåº”è¯¥ç”¨ data-i18n-attr ä½†åŠ¨æ€ä¿®æ”¹å±æ€§æ¯”è¾ƒéº»çƒ¦ï¼Œç›´æ¥ç”¨ t
                } else {
                    addrInput.placeholder = I18n.t('domains.match.prefix');
                }
            }
        }

        async function loadForwardRules(domainId, domainName) {
            try {
                const rules = await request(`/forward-rules?domain_id=${domainId}`);
                const container = document.getElementById(`forward-rules-${domainId}`);
                
                if (!rules || rules.length === 0) {
                    container.innerHTML = `
                        <div class="text-sm text-gray-400 italic py-2">
                            <span data-i18n="domains.forward.empty">æš‚æ— è½¬å‘è§„åˆ™ã€‚</span><button onclick="openForwardModal(${domainId}, '${domainName}')" class="text-indigo-500 hover:text-indigo-700" data-i18n="domains.forward.click_add">ç‚¹å‡»æ·»åŠ </button>
                        </div>`;
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                container.innerHTML = rules.map(r => {
                    const matchLabel = r.match_type === 'all' ? I18n.t('domains.forward.match_all') : 
                                       r.match_type === 'exact' ? I18n.t('domains.forward.match_exact') : I18n.t('domains.forward.match_prefix');
                    const matchDisplay = r.match_type === 'all' ? `*@${domainName}` : 
                                         `${r.match_addr}${r.match_type === 'prefix' ? '*' : ''}@${domainName}`;
                    return `
                        <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-3 overflow-hidden">
                                <span class="text-xs px-2 py-0.5 rounded ${r.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'} flex-shrink-0">
                                    ${r.enabled ? I18n.t('common.enabled') : I18n.t('common.disabled')}
                                </span>
                                <span class="text-xs px-2 py-0.5 rounded bg-indigo-50 text-indigo-600 flex-shrink-0">${matchLabel}</span>
                                <div class="flex items-center space-x-1 truncate min-w-0">
                                    <span class="font-mono text-gray-700 truncate" title="${matchDisplay}">${matchDisplay}</span>
                                    <svg class="w-3 h-3 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                                    <span class="font-mono text-blue-600 truncate" title="${r.forward_to}">${r.forward_to}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0 ml-2">
                                <button onclick="toggleForwardRule(${r.id}, ${domainId}, '${domainName}')" 
                                        class="text-xs px-2 py-1 ${r.enabled ? 'text-orange-500 hover:bg-orange-50' : 'text-green-500 hover:bg-green-50'} rounded transition">
                                    ${r.enabled ? I18n.t('common.disable') : I18n.t('common.enable')}
                                </button>
                                <button onclick="deleteForwardRule(${r.id}, ${domainId}, '${domainName}')" 
                                        class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded transition" data-i18n="domains.action.delete">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }).join('');
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) {
                console.error('åŠ è½½è½¬å‘è§„åˆ™å¤±è´¥', e);
            }
        }

        async function saveForwardRule(e) {
            e.preventDefault();
            const domainId = document.getElementById('forward-domain-id').value;
            const matchType = document.getElementById('forward-match-type').value;
            const matchAddr = document.getElementById('forward-match-addr').value;
            const forwardTo = document.getElementById('forward-to').value;
            const remark = document.getElementById('forward-remark').value;

            try {
                await request('/forward-rules', {
                    method: 'POST',
                    body: JSON.stringify({
                        domain_id: parseInt(domainId),
                        match_type: matchType,
                        match_addr: matchAddr,
                        forward_to: forwardTo,
                        remark: remark
                    })
                });
                closeForwardModal();
                loadForwardRules(domainId, currentForwardDomainName);
                showToast(I18n.t('domains.toast.rule_add_success'));
            } catch (err) {
                showToast(err.message || 'æœªçŸ¥é”™è¯¯', 'error');
            }
        }

        async function toggleForwardRule(ruleId, domainId, domainName) {
            try {
                await request(`/forward-rules/${ruleId}/toggle`, { method: 'POST' });
                loadForwardRules(domainId, domainName);
                showToast(I18n.t('domains.toast.status_updated'));
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        }

        async function deleteForwardRule(ruleId, domainId, domainName) {
            if (!confirm(I18n.t('domains.alert.delete_rule_confirm'))) return;
            try {
                await request(`/forward-rules/${ruleId}`, { method: 'DELETE' });
                loadForwardRules(domainId, domainName);
                showToast(I18n.t('common.deleted'));
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ========== è¯ä¹¦å¤¹åŠŸèƒ½ ==========
        let allCertificates = [];
        let currentAcmeDomain = '';

        function openCertDrawer() {
            document.getElementById('cert-drawer').classList.remove('translate-x-full');
            document.getElementById('cert-drawer-backdrop').classList.remove('hidden');
            loadCertificates();
        }

        function closeCertDrawer() {
            document.getElementById('cert-drawer').classList.add('translate-x-full');
            document.getElementById('cert-drawer-backdrop').classList.add('hidden');
        }

        async function loadCertificates() {
            const container = document.getElementById('cert-list');
            try {
                const certs = await request('/certs');
                allCertificates = certs;
                
                if (!certs || certs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <p data-i18n="domains.cert.empty">æš‚æ— è¯ä¹¦</p>
                            <p class="text-xs mt-1" data-i18n="domains.cert.empty_hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ æˆ–ç”³è¯·è¯ä¹¦</p>
                        </div>`;
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                container.innerHTML = certs.map(c => {
                    const statusClass = {
                        'valid': 'bg-green-100 text-green-700',
                        'warning': 'bg-yellow-100 text-yellow-700',
                        'critical': 'bg-red-100 text-red-700',
                        'expired': 'bg-gray-100 text-gray-500'
                    }[c.status] || 'bg-gray-100 text-gray-500';
                    
                    const statusIcon = {
                        'valid': 'âœ…',
                        'warning': 'âš ï¸',
                        'critical': 'ğŸ”´',
                        'expired': 'âŒ'
                    }[c.status] || 'â“';

                    const sourceLabel = c.source === 'letsencrypt' ? "Let's Encrypt" : 'æ‰‹åŠ¨ä¸Šä¼ ';
                    
                    return `
                        <div class="bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-gray-800 truncate" title="${c.domains.join(', ')}">${c.domains[0] || c.name || 'æœªçŸ¥'}</h4>
                                    ${c.domains.length > 1 ? `<p class="text-xs text-gray-400">+${c.domains.length - 1} ä¸ªåŸŸå</p>` : ''}
                                </div>
                                <span class="text-xs px-2 py-0.5 rounded ${statusClass} flex-shrink-0 ml-2">
                                    ${statusIcon} ${c.days_left >= 0 ? c.days_left + 'å¤©' : 'å·²è¿‡æœŸ'}
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 space-y-1">
                                <p><span class="text-gray-400">é¢å‘è€…:</span> ${c.issuer || 'æœªçŸ¥'}</p>
                                <p><span class="text-gray-400">åˆ°æœŸ:</span> ${new Date(c.not_after).toLocaleDateString()}</p>
                                <p><span class="text-gray-400">æ¥æº:</span> ${sourceLabel}</p>
                            </div>
                            <div class="mt-3 flex justify-end space-x-2">
                                <button onclick="applyCertToSTARTTLS(${c.id})" class="text-xs px-2 py-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded transition" data-i18n="domains.cert.apply_starttls">åº”ç”¨åˆ°STARTTLS</button>
                                <button onclick="deleteCertificate(${c.id})" class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded transition" data-i18n="common.delete">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) {
                console.error('åŠ è½½è¯ä¹¦å¤±è´¥', e);
                container.innerHTML = `<div class="text-center text-red-500 py-4">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        // ä¸Šä¼ è¯ä¹¦
        function openUploadCertModal() {
            document.getElementById('upload-cert-modal').classList.remove('hidden');
            document.getElementById('cert-name').value = '';
            document.getElementById('cert-pem').value = '';
            document.getElementById('key-pem').value = '';
        }

        function closeUploadCertModal() {
            document.getElementById('upload-cert-modal').classList.add('hidden');
        }

        async function uploadCertificate(e) {
            e.preventDefault();
            const name = document.getElementById('cert-name').value;
            const certPem = document.getElementById('cert-pem').value;
            const keyPem = document.getElementById('key-pem').value;

            try {
                await request('/certs', {
                    method: 'POST',
                    body: JSON.stringify({ name, cert_pem: certPem, key_pem: keyPem })
                });
                closeUploadCertModal();
                loadCertificates();
                showToast(I18n.t('domains.cert.upload_success') || 'è¯ä¹¦ä¸Šä¼ æˆåŠŸ');
            } catch (err) {
                showToast(err.message || 'ä¸Šä¼ å¤±è´¥', 'error');
            }
        }

        // ACME ç”³è¯·è¯ä¹¦
        function openAcmeModal() {
            document.getElementById('acme-modal').classList.remove('hidden');
            document.getElementById('acme-step1').classList.remove('hidden');
            document.getElementById('acme-step2').classList.add('hidden');
            document.getElementById('acme-domain').value = '';
            document.getElementById('acme-email').value = '';
        }

        function closeAcmeModal() {
            document.getElementById('acme-modal').classList.add('hidden');
            currentAcmeDomain = '';
        }

        async function initAcmeChallenge(e) {
            e.preventDefault();
            const domain = document.getElementById('acme-domain').value;
            const email = document.getElementById('acme-email').value;
            currentAcmeDomain = domain;

            try {
                const result = await request('/certs/acme/init', {
                    method: 'POST',
                    body: JSON.stringify({ domain, email, dns_provider: 'manual' })
                });
                
                // æ˜¾ç¤º DNS è®°å½•
                document.getElementById('acme-txt-record').innerText = result.txt_record;
                document.getElementById('acme-txt-value').innerText = result.txt_value;
                
                // åˆ‡æ¢åˆ°æ­¥éª¤ 2
                document.getElementById('acme-step1').classList.add('hidden');
                document.getElementById('acme-step2').classList.remove('hidden');
                
                showToast(I18n.t('domains.cert.acme_init_success') || 'è¯·æ·»åŠ  DNS è®°å½•');
            } catch (err) {
                showToast(err.message || 'åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        async function verifyAcmeChallenge() {
            if (!currentAcmeDomain) {
                showToast('åŸŸåä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°å¼€å§‹', 'error');
                return;
            }

            try {
                await request('/certs/acme/verify', {
                    method: 'POST',
                    body: JSON.stringify({ domain: currentAcmeDomain })
                });
                
                closeAcmeModal();
                loadCertificates();
                showToast(I18n.t('domains.cert.acme_success') || 'è¯ä¹¦ç”³è¯·æˆåŠŸï¼');
            } catch (err) {
                showToast(err.message || 'éªŒè¯å¤±è´¥ï¼Œè¯·ç¡®ä¿ DNS è®°å½•å·²æ­£ç¡®æ·»åŠ ', 'error');
            }
        }

        async function cancelAcmeChallenge() {
            if (currentAcmeDomain) {
                try {
                    await request(`/certs/acme/challenge/${currentAcmeDomain}`, { method: 'DELETE' });
                } catch (e) {}
            }
            closeAcmeModal();
        }

        // åº”ç”¨è¯ä¹¦åˆ° STARTTLS
        async function applyCertToSTARTTLS(certId) {
            if (!confirm(I18n.t('domains.cert.apply_confirm') || 'ç¡®å®šè¦å°†æ­¤è¯ä¹¦åº”ç”¨åˆ° STARTTLS é…ç½®å—ï¼Ÿåº”ç”¨åéœ€è¦é‡å¯æœåŠ¡ç”Ÿæ•ˆã€‚')) {
                return;
            }

            try {
                await request(`/certs/${certId}/apply-starttls`, { method: 'POST' });
                showToast(I18n.t('domains.cert.apply_success') || 'è¯ä¹¦å·²åº”ç”¨ï¼Œè¯·é‡å¯æœåŠ¡ç”Ÿæ•ˆ');
            } catch (err) {
                showToast(err.message || 'åº”ç”¨å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤è¯ä¹¦
        async function deleteCertificate(certId) {
            if (!confirm(I18n.t('domains.cert.delete_confirm') || 'ç¡®å®šè¦åˆ é™¤æ­¤è¯ä¹¦å—ï¼Ÿ')) {
                return;
            }

            try {
                await request(`/certs/${certId}`, { method: 'DELETE' });
                loadCertificates();
                showToast(I18n.t('common.deleted') || 'å·²åˆ é™¤');
            } catch (err) {
                showToast(err.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast('å·²å¤åˆ¶')).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast('å·²å¤åˆ¶');
            } catch (e) {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            }
            document.body.removeChild(ta);
        }

        // ========== ç»‘å®šè¯ä¹¦åŠŸèƒ½ ==========
        let currentBindDomainId = null;
        let currentDomainCertId = null;

        async function openBindCertModal(domainId) {
            currentBindDomainId = domainId;
            document.getElementById('bind-cert-domain-id').value = domainId;
            document.getElementById('bind-cert-modal').classList.remove('hidden');
            
            // åŠ è½½åŸŸåå½“å‰ç»‘å®šçŠ¶æ€
            const domains = await request('/domains');
            const domain = domains.find(d => d.id === domainId);
            const currentCertInfo = document.getElementById('current-cert-info');
            
            if (domain && domain.certificate_id && domain.certificate) {
                currentDomainCertId = domain.certificate_id;
                document.getElementById('current-cert-name').textContent = 
                    `${domain.certificate.domains || domain.certificate.name || 'æœªçŸ¥'} (å‰©ä½™ ${domain.cert_days_left} å¤©)`;
                currentCertInfo.classList.remove('hidden');
            } else {
                currentDomainCertId = null;
                currentCertInfo.classList.add('hidden');
            }
            
            // åŠ è½½å¯é€‰è¯ä¹¦åˆ—è¡¨
            await loadCertSelectList();
        }

        function closeBindCertModal() {
            document.getElementById('bind-cert-modal').classList.add('hidden');
            currentBindDomainId = null;
        }

        async function loadCertSelectList() {
            const container = document.getElementById('cert-select-list');
            try {
                const certs = await request('/certs');
                
                if (!certs || certs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-6">
                            <svg class="w-10 h-10 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <p data-i18n="domains.cert.no_cert">æš‚æ— å¯ç”¨è¯ä¹¦</p>
                            <p class="text-xs mt-1" data-i18n="domains.cert.no_cert_hint">è¯·å…ˆä¸Šä¼ æˆ–ç”³è¯·è¯ä¹¦</p>
                        </div>`;
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                container.innerHTML = certs.map(c => {
                    const isSelected = currentDomainCertId === c.id;
                    const statusClass = {
                        'valid': 'border-emerald-300 bg-emerald-50',
                        'warning': 'border-yellow-300 bg-yellow-50',
                        'critical': 'border-red-300 bg-red-50',
                        'expired': 'border-gray-300 bg-gray-50'
                    }[c.status] || 'border-gray-200';
                    
                    const statusIcon = {
                        'valid': 'âœ…',
                        'warning': 'âš ï¸',
                        'critical': 'ğŸ”´',
                        'expired': 'âŒ'
                    }[c.status] || 'â“';

                    return `
                        <div class="p-3 border rounded-lg ${statusClass} hover:shadow-sm transition cursor-pointer ${isSelected ? 'ring-2 ring-emerald-500' : ''}"
                             onclick="bindCertificate(${c.id})">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-gray-800 truncate">${c.domains ? c.domains.split(',')[0] : c.name || 'æœªçŸ¥'}</p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        ${statusIcon} ${c.days_left >= 0 ? `å‰©ä½™ ${c.days_left} å¤©` : 'å·²è¿‡æœŸ'} Â· 
                                        ${c.issuer || 'æœªçŸ¥é¢å‘è€…'}
                                    </p>
                                </div>
                                ${isSelected ? '<span class="text-emerald-600 text-xs font-medium px-2 py-0.5 bg-emerald-100 rounded">å½“å‰</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) {
                console.error('åŠ è½½è¯ä¹¦åˆ—è¡¨å¤±è´¥', e);
                container.innerHTML = `<div class="text-center text-red-500 py-4">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        async function bindCertificate(certId) {
            if (!currentBindDomainId) return;
            
            try {
                await request(`/domains/${currentBindDomainId}/bind-cert`, {
                    method: 'POST',
                    body: JSON.stringify({ certificate_id: certId })
                });
                showToast(I18n.t('domains.cert.bind_success') || 'è¯ä¹¦ç»‘å®šæˆåŠŸ');
                closeBindCertModal();
                loadDomains(); // åˆ·æ–°åŸŸååˆ—è¡¨
            } catch (err) {
                showToast(err.message || 'ç»‘å®šå¤±è´¥', 'error');
            }
        }

        async function unbindCertificate() {
            if (!currentBindDomainId) return;
            if (!confirm(I18n.t('domains.cert.unbind_confirm') || 'ç¡®å®šè¦è§£é™¤è¯ä¹¦ç»‘å®šå—ï¼Ÿ')) return;
            
            try {
                await request(`/domains/${currentBindDomainId}/bind-cert`, {
                    method: 'POST',
                    body: JSON.stringify({ certificate_id: null })
                });
                showToast(I18n.t('domains.cert.unbind_success') || 'å·²è§£é™¤ç»‘å®š');
                closeBindCertModal();
                loadDomains();
            } catch (err) {
                showToast(err.message || 'è§£ç»‘å¤±è´¥', 'error');
            }
        }
        
        loadDomains();
    </script>
</body>
</html>
