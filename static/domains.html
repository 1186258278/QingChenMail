<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>域名管理 - 晴辰云邮</title>
    <link href="/dashboard/css/tailwind.min.css?v=8.0" rel="stylesheet">
    <script src="/dashboard/js/loader.js?v=8.0"></script>
    <script src="/dashboard/js/common.js?v=8.0"></script>
    <script src="/dashboard/js/layout.js?v=8.0"></script>
</head>
<body class="hidden" data-i18n-module="domains">
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-gray-800" data-i18n="domains.title">域名管理</h2>
            <p class="text-gray-500 mt-1" data-i18n="domains.subtitle">配置发信域名与 DNS 验证</p>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="openCertDrawer()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition shadow-sm flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                <span data-i18n="domains.cert_drawer_btn">证书夹</span>
            </button>
            <button onclick="openModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                <span data-i18n="domains.add_btn">添加域名</span>
            </button>
        </div>
    </div>

    <!-- 域名列表 -->
    <div id="domain-list" class="space-y-6"></div>

    <!-- 添加域名模态框 -->
    <div id="domain-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-8 w-[500px] shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800" data-i18n="domains.modal.add_title">添加发信域名</h3>
            <div class="mb-6 bg-blue-50 text-blue-700 text-sm p-4 rounded-lg flex items-start">
                <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p data-i18n="domains.modal.add_desc">系统将自动生成 SPF、DKIM 和 DMARC 记录。请确保您拥有该域名的 DNS 管理权限。</p>
            </div>
            <form onsubmit="saveDomain(event)">
                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.domain_label">域名</label>
                <input type="text" id="domain-name" required placeholder="例如: newsletter.example.com" pattern="^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$" title="请输入有效的域名格式" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none mb-6">
                
                <!-- 初始配置: 邮件子域名 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.prefix_label">邮件服务器前缀 (可选)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="domain-prefix" data-i18n-attr="placeholder:domains.modal.prefix_ph" placeholder="默认为主域名 (@)" class="w-32 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <span class="text-gray-400 text-sm">.your-domain.com</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" data-i18n="domains.modal.prefix_hint">推荐填 "mail" 或 "smtp"。留空则使用主域名。</p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">取消</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition" data-i18n="common.next">下一步</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加转发规则模态框 -->
    <div id="forward-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-8 w-[550px] shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800" data-i18n="domains.modal.fwd_title">添加邮件转发规则</h3>
            <div class="mb-4 bg-indigo-50 text-indigo-700 text-sm p-4 rounded-lg flex items-start">
                <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                    <p class="font-medium mb-1" data-i18n="domains.modal.fwd_desc_title">转发规则说明</p>
                    <p data-i18n="domains.modal.fwd_desc">当有邮件发送到域名邮箱时，系统会自动转发到指定的目标邮箱。需要先在 DNS 添加 MX 记录指向本服务器，并启用接收服务。</p>
                </div>
            </div>
            <form onsubmit="saveForwardRule(event)">
                <input type="hidden" id="forward-domain-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.match_type">匹配模式</label>
                    <select id="forward-match-type" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" onchange="updateMatchAddrPlaceholder()">
                        <option value="all" data-i18n="domains.match.all">全部 - 接收所有发往该域名的邮件</option>
                        <option value="exact" data-i18n="domains.match.exact">精确匹配 - 仅匹配指定地址</option>
                        <option value="prefix" data-i18n="domains.match.prefix">前缀匹配 - 匹配以指定前缀开头的地址</option>
                    </select>
                </div>
                <div class="mb-4" id="match-addr-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.match_addr">匹配地址</label>
                    <div class="flex items-center">
                        <input type="text" id="forward-match-addr" placeholder="例如: support" class="flex-1 border rounded-l-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <span id="forward-domain-suffix" class="bg-gray-100 border border-l-0 rounded-r-lg px-3 py-2 text-gray-500">@example.com</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" data-i18n="domains.modal.match_hint">留空表示匹配所有地址（仅限"全部"模式）</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.forward_to">转发到 <span class="text-red-500">*</span></label>
                    <input type="email" id="forward-to" required placeholder="例如: your-email@gmail.com" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.remark">备注</label>
                    <input type="text" id="forward-remark" data-i18n-attr="placeholder:domains.modal.remark_ph" placeholder="可选备注" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeForwardModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">取消</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md transition" data-i18n="domains.modal.save_rule">保存规则</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 证书夹侧边栏 -->
    <div id="cert-drawer-backdrop" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40" onclick="closeCertDrawer()"></div>
    <div id="cert-drawer" class="fixed inset-y-0 right-0 w-[420px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <!-- 头部 -->
        <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
            <h3 class="text-lg font-bold flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                <span data-i18n="domains.cert.drawer_title">证书夹</span>
            </h3>
            <button onclick="closeCertDrawer()" class="hover:bg-white/20 rounded p-1 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <!-- 操作按钮 -->
        <div class="p-4 border-b flex space-x-2">
            <button onclick="openUploadCertModal()" class="flex-1 bg-emerald-600 text-white px-3 py-2 rounded-lg hover:bg-emerald-700 transition text-sm flex items-center justify-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span data-i18n="domains.cert.upload_btn">上传证书</span>
            </button>
            <button onclick="openAcmeModal()" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition text-sm flex items-center justify-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <span data-i18n="domains.cert.acme_btn">申请免费证书</span>
            </button>
        </div>
        
        <!-- 证书列表 -->
        <div id="cert-list" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div class="text-center text-gray-400 py-8">
                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <p data-i18n="domains.cert.loading">加载中...</p>
            </div>
        </div>
    </div>

    <!-- 上传证书模态框 -->
    <div id="upload-cert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 w-[550px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-xl mb-4 text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span data-i18n="domains.cert.upload_title">上传 SSL 证书</span>
            </h3>
            <form onsubmit="uploadCertificate(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.cert.name_label">证书名称 (可选)</label>
                    <input type="text" id="cert-name" placeholder="例如: mail.example.com" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <span data-i18n="domains.cert.cert_pem_label">证书内容 (PEM 格式)</span>
                        <span class="text-red-500">*</span>
                    </label>
                    <textarea id="cert-pem" required rows="6" placeholder="-----BEGIN CERTIFICATE-----&#10;...&#10;-----END CERTIFICATE-----" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-xs"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <span data-i18n="domains.cert.key_pem_label">私钥内容 (PEM 格式)</span>
                        <span class="text-red-500">*</span>
                    </label>
                    <textarea id="key-pem" required rows="6" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-xs"></textarea>
                </div>
                <div class="bg-amber-50 text-amber-700 text-xs p-3 rounded-lg mb-4">
                    <p class="font-medium mb-1" data-i18n="domains.cert.upload_tip_title">提示</p>
                    <p data-i18n="domains.cert.upload_tip">上传后系统会自动解析证书信息（域名、有效期等）。私钥将加密存储。</p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeUploadCertModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">取消</button>
                    <button type="submit" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-md transition" data-i18n="domains.cert.upload_submit">上传证书</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ACME 申请证书模态框 -->
    <div id="acme-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 w-[550px] shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-xl mb-4 text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <span data-i18n="domains.cert.acme_title">申请免费 SSL 证书</span>
            </h3>
            
            <!-- 步骤 1: 填写信息 -->
            <div id="acme-step1">
                <div class="bg-blue-50 text-blue-700 text-sm p-3 rounded-lg mb-4">
                    <p class="font-medium mb-1">Let's Encrypt 免费证书</p>
                    <p data-i18n="domains.cert.acme_desc">使用 DNS-01 验证方式申请证书，无需开放 80/443 端口。证书有效期 90 天，到期前可续期。</p>
                </div>
                <form onsubmit="initAcmeChallenge(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <span data-i18n="domains.cert.acme_domain">域名</span>
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="acme-domain" required placeholder="例如: mail.example.com" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <span data-i18n="domains.cert.acme_email">邮箱</span>
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="email" id="acme-email" required placeholder="用于接收证书到期通知" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeAcmeModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">取消</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition" data-i18n="domains.cert.acme_init">开始申请</button>
                    </div>
                </form>
            </div>
            
            <!-- 步骤 2: 添加 DNS 记录 -->
            <div id="acme-step2" class="hidden">
                <div class="bg-amber-50 text-amber-700 text-sm p-4 rounded-lg mb-4">
                    <p class="font-medium mb-2" data-i18n="domains.cert.acme_dns_title">请添加以下 DNS TXT 记录</p>
                    <div class="bg-white rounded p-3 font-mono text-xs space-y-2">
                        <div>
                            <span class="text-gray-500">记录类型:</span> <span class="font-bold">TXT</span>
                        </div>
                        <div>
                            <span class="text-gray-500">主机记录:</span> <span id="acme-txt-record" class="font-bold select-all">-</span>
                            <button onclick="copyToClipboard(document.getElementById('acme-txt-record').innerText)" class="ml-2 text-blue-500 hover:text-blue-700">复制</button>
                        </div>
                        <div>
                            <span class="text-gray-500">记录值:</span> <span id="acme-txt-value" class="font-bold select-all break-all">-</span>
                            <button onclick="copyToClipboard(document.getElementById('acme-txt-value').innerText)" class="ml-2 text-blue-500 hover:text-blue-700">复制</button>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-4" data-i18n="domains.cert.acme_dns_hint">添加 DNS 记录后，请等待 1-5 分钟让 DNS 生效，然后点击验证。</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="cancelAcmeChallenge()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">取消</button>
                    <button type="button" onclick="verifyAcmeChallenge()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition" data-i18n="domains.cert.acme_verify">验证并获取证书</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        Auth.check();

        function openModal() { document.getElementById('domain-modal').classList.remove('hidden'); document.getElementById('domain-name').value = ''; document.getElementById('domain-prefix').value = 'mail'; }
        function closeModal() { document.getElementById('domain-modal').classList.add('hidden'); }

        // 防抖函数，用于自动保存
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function loadDomains() {
            try {
                const list = await request('/domains');
                const container = document.getElementById('domain-list');
                container.innerHTML = '';

                if (list.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                            <p class="text-gray-500 text-lg" data-i18n="domains.empty_title">暂无配置域名</p>
                            <button onclick="openModal()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium" data-i18n="domains.empty_btn">立即添加第一个域名</button>
                        </div>`;
                    
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                list.forEach(d => {
                    const statusBadge = (verified, label) => 
                        `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${verified ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                            <span class="w-2 h-2 rounded-full mr-1.5 ${verified ? 'bg-green-500' : 'bg-gray-400'}"></span>
                            ${label}: <span data-i18n="${verified ? 'domains.status.verified' : 'domains.status.unverified'}">${verified ? '已验证' : '未验证'}</span>
                        </span>`;

                    // 初始化前缀（如果是旧数据没字段，默认为空）
                    const prefix = d.mail_subdomain_prefix || '';

                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden';
                    div.innerHTML = `
                        <div class="p-6 border-b border-gray-100 flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                                    ${d.name}
                                    <span class="ml-3 text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded">ID: ${d.id}</span>
                                </h3>
                                <div class="flex flex-wrap gap-2 mt-3">
                                    ${statusBadge(d.spf_verified, 'SPF')}
                                    ${statusBadge(d.dkim_verified, 'DKIM')}
                                    ${statusBadge(d.dmarc_verified, 'DMARC')}
                                    ${statusBadge(d.mx_verified, 'MX')}
                                    <span id="badge-a-${d.id}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                        <span class="w-2 h-2 rounded-full mr-1.5 bg-gray-400"></span> <span data-i18n="domains.status.a_checking">A记录: 检测中...</span>
                                    </span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="verifyDomain(${d.id})" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100 transition text-sm font-medium" data-i18n="domains.action.refresh">刷新状态</button>
                                <button onclick="deleteDomain(${d.id})" class="px-3 py-1.5 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition text-sm" data-i18n="domains.action.delete">删除</button>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50">
                            <div class="mb-6 flex justify-between items-end">
                                <div>
                                    <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-1" data-i18n="domains.dns.title">DNS 配置记录</h4>
                                    <p class="text-xs text-gray-500" data-i18n="domains.dns.subtitle">请在您的 DNS 服务商处添加以下记录</p>
                                </div>
                                <div class="flex items-center bg-white border rounded-lg px-3 py-2 shadow-sm">
                                    <span class="text-xs text-gray-500 mr-2" data-i18n="domains.dns.mail_server">邮件服务器地址:</span>
                                    <div class="relative">
                                        <input type="text" 
                                            id="prefix-input-${d.id}" 
                                            value="${prefix}" 
                                            data-i18n-attr="placeholder:domains.modal.prefix_ph"
                                            placeholder="@ (主域名)"
                                            class="w-24 text-sm font-medium text-gray-800 outline-none text-right placeholder-gray-300"
                                            oninput="handlePrefixChange(${d.id}, '${d.name}', this.value)"
                                        >
                                        <div class="absolute right-0 -bottom-5 text-[10px] text-green-600 transition-opacity opacity-0" id="save-tip-${d.id}" data-i18n="domains.dns.saved">已保存</div>
                                    </div>
                                    <span class="text-sm text-gray-400 ml-1">.${d.name}</span>
                                </div>
                            </div>

                            <div class="space-y-3" id="dns-records-${d.id}">
                                <!-- 动态内容由 updateDNSRecords 渲染 -->
                            </div>

                            <!-- SPF/DKIM/DMARC -->
                            <div class="space-y-3 mt-3">
                                <!-- SPF 记录 (动态 ID) -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">@</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="spf-${d.id}"></div>
                                    </div>
                                    <button onclick="copyText('spf-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制记录值">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>

                                <!-- DKIM 记录 -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">default._domainkey</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="dkim-${d.id}">v=DKIM1; k=rsa; p=${d.dkim_public_key.replace(/-----.*-----|\n/g, '')}</div>
                                    </div>
                                    <button onclick="copyText('dkim-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制记录值">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>

                                <!-- DMARC 记录 -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">_dmarc</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="dmarc-${d.id}">v=DMARC1; p=none; rua=mailto:postmaster@${d.name}</div>
                                    </div>
                                    <button onclick="copyText('dmarc-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制记录值">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>
                            </div>

                            <!-- 备案提示 -->
                            <div class="mt-4 bg-orange-50 border border-orange-100 rounded-lg p-3 text-xs text-orange-700 flex items-start">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                <div>
                                    <p class="font-medium">⚠️ <span data-i18n="domains.icp.title">备案提示</span>：</p>
                                    <p data-i18n="domains.icp.desc1">如果您的服务器在中国大陆，且域名未备案，可能会导致 80/443 端口（网站访问）被拦截。</p>
                                    <p class="mt-1" data-i18n="domains.icp.desc2">但这不会影响邮件收发功能（使用 SMTP/25 端口）。只要 DNS 解析正确，邮件服务即可正常运行。</p>
                                </div>
                            </div>
                            
                            <!-- 转发规则... (省略保持不变) -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 flex justify-between items-center">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                        <span data-i18n="domains.forward.title">邮件转发规则</span>
                                    </span>
                                    <button onclick="openForwardModal(${d.id}, '${d.name}')" class="text-xs font-medium text-indigo-600 hover:text-indigo-800 flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        <span data-i18n="domains.forward.add">添加规则</span>
                                    </button>
                                </h4>
                                <div id="forward-rules-${d.id}" class="space-y-2">
                                    <div class="text-sm text-gray-400 italic">加载中...</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                    // 渲染初始 DNS 记录
                    updateDNSRecords(d.id, d.name, prefix);
                    // 检查 A 记录
                    checkARecord(prefix ? `${prefix}.${d.name}` : d.name, d.id);
                    // 加载转发规则
                    loadForwardRules(d.id, d.name);
                });
                
                // 渲染所有生成的 data-i18n
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();

            } catch (e) {
                console.error(e);
            }
        }

        // 处理前缀变更（输入框输入时触发）
        const savePrefixDebounced = debounce(async (id, prefix) => {
            try {
                await request(`/domains/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ mail_subdomain_prefix: prefix })
                });
                // 显示“已保存”提示
                const tip = document.getElementById(`save-tip-${id}`);
                tip.style.opacity = '1';
                setTimeout(() => tip.style.opacity = '0', 2000);
            } catch (err) {
                showToast('自动保存失败', 'error');
            }
        }, 800); // 延迟 800ms 保存

        function handlePrefixChange(id, domainName, value) {
            // 1. 更新 UI
            updateDNSRecords(id, domainName, value);
            // 2. 触发 A 记录检查
            const host = value ? `${value}.${domainName}` : domainName;
            checkARecord(host, id);
            // 3. 触发后端保存
            savePrefixDebounced(id, value);
        }

        async function saveDomain(e) {
            e.preventDefault();
            const name = document.getElementById('domain-name').value;
            const prefix = document.getElementById('domain-prefix').value;
            try {
                // 先创建
                const res = await request('/domains', { method: 'POST', body: JSON.stringify({ name }) });
                // 如果有前缀，立即更新
                if (prefix && res.id) {
                    await request(`/domains/${res.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ mail_subdomain_prefix: prefix })
                    });
                }
                closeModal();
                loadDomains();
                showToast(I18n.t('domains.toast.add_success'));
            } catch (err) {
                showToast(err.message || '添加失败', 'error');
            }
        }

        async function verifyDomain(id) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = I18n.t('domains.action.verifying');
            btn.disabled = true;
            try {
                await request(`/domains/${id}/verify`, { method: 'POST' });
                await loadDomains();
                showToast(I18n.t('domains.toast.verified'));
            } catch (e) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function deleteDomain(id) {
            if (confirm(I18n.t('domains.alert.delete_confirm'))) {
                try {
                    await request(`/domains/${id}`, { method: 'DELETE' });
                    loadDomains();
                    showToast(I18n.t('common.success'));
                } catch (e) {}
            }
        }

        // ========== 通用函数 (Copy, CheckA, Render) ==========

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast('已复制')).catch(() => fallbackCopyText(text));
            } else {
                fallbackCopyText(text);
            }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy') ? showToast('已复制') : showToast('复制失败', 'error');
            } catch (err) {
                showToast('复制失败', 'error');
            }
            document.body.removeChild(textArea);
        }

        function updateDNSRecords(id, domainName, prefix) {
            const container = document.getElementById(`dns-records-${id}`);
            if (!container) return;

            const hostname = window.location.hostname;
            // 如果 prefix 为空，表示用主域名 @；否则用 prefix
            const aRecordHost = prefix ? prefix : '@';
            const mxRecordValue = prefix ? `${prefix}.${domainName}` : domainName;
            
            // 优化 SPF: 直接使用 ip4 机制，比 mx 机制更稳定，不受 MX 解析延迟影响
            // 注意：这里我们动态更新 SPF 显示，但不保存到数据库，因为后端验证也是动态的
            const spfValue = `v=spf1 ip4:${hostname} -all`;
            
            // 更新 SPF 容器 (如果存在)
            const spfContainer = document.getElementById(`spf-${id}`);
            if (spfContainer) {
                spfContainer.innerText = spfValue;
            }

            container.innerHTML = `
                <!-- A 记录 -->
                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative border-l-4 border-l-blue-500">
                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1 font-bold">A</div>
                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">${aRecordHost}</div>
                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all flex items-center">
                            <span id="a-${id}" class="bg-gray-50 px-1 rounded border border-gray-200">${hostname}</span>
                            <span class="text-gray-400 ml-2 text-[10px] hidden sm:inline-block">← <span data-i18n="domains.dns.server_ip">您的服务器IP</span></span>
                        </div>
                    </div>
                    <button onclick="copyText('a-${id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制 IP">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    </button>
                </div>

                <!-- MX 记录 -->
                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">MX</div>
                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">@</div>
                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all flex items-center">
                            <span id="mx-${id}" class="bg-gray-50 px-1 rounded border border-gray-200">${mxRecordValue}</span>
                            <span class="text-gray-400 ml-2 text-[10px] hidden sm:inline-block">← <span data-i18n="domains.dns.priority_10">优先级 10</span></span>
                        </div>
                    </div>
                    <button onclick="copyText('mx-${id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制域名">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    </button>
                </div>
            `;
        }

        async function checkARecord(hostname, id) {
            const badge = document.getElementById(`badge-a-${id}`);
            if (!badge) return;

            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-yellow-500"></span> <span data-i18n="domains.status.a_local">A记录: 本地环境</span>`;
                // 这里也需要 render 吗？updateDNSRecords 是同步的，checkARecord 是异步的。
                // 如果 checkARecord 执行慢了，上面的 I18n.render() 已经跑完了。
                // 所以这里更新 HTML 后，需要再次 render。
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                return;
            }

            badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600';
            badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-gray-400"></span> <span data-i18n="domains.status.a_checking">A记录: 检测中...</span>`;
            if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();

            try {
                const response = await fetch(`https://cloudflare-dns.com/dns-query?name=${hostname}&type=A`, {
                    headers: { 'Accept': 'application/dns-json' }
                });
                const data = await response.json();
                
                if (data.Answer && data.Answer.some(r => r.type === 1)) {
                    badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-green-500"></span> <span data-i18n="domains.status.a_ok">A记录: 已解析</span>`;
                } else {
                    badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-red-500"></span> <span data-i18n="domains.status.a_missing">A记录: 未找到</span>`;
                }
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) { console.error(e); }
        }

        // ========== 转发规则逻辑 ==========

        let currentForwardDomainName = '';

        function openForwardModal(domainId, domainName) {
            document.getElementById('forward-modal').classList.remove('hidden');
            document.getElementById('forward-domain-id').value = domainId;
            document.getElementById('forward-match-type').value = 'all';
            document.getElementById('forward-match-addr').value = '';
            document.getElementById('forward-to').value = '';
            document.getElementById('forward-remark').value = '';
            currentForwardDomainName = domainName;
            updateMatchAddrPlaceholder();
        }

        function closeForwardModal() {
            document.getElementById('forward-modal').classList.add('hidden');
        }

        function updateMatchAddrPlaceholder() {
            const matchType = document.getElementById('forward-match-type').value;
            const addrGroup = document.getElementById('match-addr-group');
            const addrInput = document.getElementById('forward-match-addr');
            
            if (matchType === 'all') {
                addrGroup.style.display = 'none';
            } else {
                addrGroup.style.display = 'block';
                if (matchType === 'exact') {
                    addrInput.placeholder = I18n.t('domains.match.exact'); // 实际上这里应该用 data-i18n-attr 但动态修改属性比较麻烦，直接用 t
                } else {
                    addrInput.placeholder = I18n.t('domains.match.prefix');
                }
            }
        }

        async function loadForwardRules(domainId, domainName) {
            try {
                const rules = await request(`/forward-rules?domain_id=${domainId}`);
                const container = document.getElementById(`forward-rules-${domainId}`);
                
                if (!rules || rules.length === 0) {
                    container.innerHTML = `
                        <div class="text-sm text-gray-400 italic py-2">
                            <span data-i18n="domains.forward.empty">暂无转发规则。</span><button onclick="openForwardModal(${domainId}, '${domainName}')" class="text-indigo-500 hover:text-indigo-700" data-i18n="domains.forward.click_add">点击添加</button>
                        </div>`;
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                container.innerHTML = rules.map(r => {
                    const matchLabel = r.match_type === 'all' ? I18n.t('domains.forward.match_all') : 
                                       r.match_type === 'exact' ? I18n.t('domains.forward.match_exact') : I18n.t('domains.forward.match_prefix');
                    const matchDisplay = r.match_type === 'all' ? `*@${domainName}` : 
                                         `${r.match_addr}${r.match_type === 'prefix' ? '*' : ''}@${domainName}`;
                    return `
                        <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-3 overflow-hidden">
                                <span class="text-xs px-2 py-0.5 rounded ${r.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'} flex-shrink-0">
                                    ${r.enabled ? I18n.t('common.enabled') : I18n.t('common.disabled')}
                                </span>
                                <span class="text-xs px-2 py-0.5 rounded bg-indigo-50 text-indigo-600 flex-shrink-0">${matchLabel}</span>
                                <div class="flex items-center space-x-1 truncate min-w-0">
                                    <span class="font-mono text-gray-700 truncate" title="${matchDisplay}">${matchDisplay}</span>
                                    <svg class="w-3 h-3 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                                    <span class="font-mono text-blue-600 truncate" title="${r.forward_to}">${r.forward_to}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0 ml-2">
                                <button onclick="toggleForwardRule(${r.id}, ${domainId}, '${domainName}')" 
                                        class="text-xs px-2 py-1 ${r.enabled ? 'text-orange-500 hover:bg-orange-50' : 'text-green-500 hover:bg-green-50'} rounded transition">
                                    ${r.enabled ? I18n.t('common.disable') : I18n.t('common.enable')}
                                </button>
                                <button onclick="deleteForwardRule(${r.id}, ${domainId}, '${domainName}')" 
                                        class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded transition" data-i18n="domains.action.delete">删除</button>
                            </div>
                        </div>
                    `;
                }).join('');
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) {
                console.error('加载转发规则失败', e);
            }
        }

        async function saveForwardRule(e) {
            e.preventDefault();
            const domainId = document.getElementById('forward-domain-id').value;
            const matchType = document.getElementById('forward-match-type').value;
            const matchAddr = document.getElementById('forward-match-addr').value;
            const forwardTo = document.getElementById('forward-to').value;
            const remark = document.getElementById('forward-remark').value;

            try {
                await request('/forward-rules', {
                    method: 'POST',
                    body: JSON.stringify({
                        domain_id: parseInt(domainId),
                        match_type: matchType,
                        match_addr: matchAddr,
                        forward_to: forwardTo,
                        remark: remark
                    })
                });
                closeForwardModal();
                loadForwardRules(domainId, currentForwardDomainName);
                showToast(I18n.t('domains.toast.rule_add_success'));
            } catch (err) {
                showToast(err.message || '未知错误', 'error');
            }
        }

        async function toggleForwardRule(ruleId, domainId, domainName) {
            try {
                await request(`/forward-rules/${ruleId}/toggle`, { method: 'POST' });
                loadForwardRules(domainId, domainName);
                showToast(I18n.t('domains.toast.status_updated'));
            } catch (e) {
                showToast('操作失败', 'error');
            }
        }

        async function deleteForwardRule(ruleId, domainId, domainName) {
            if (!confirm(I18n.t('domains.alert.delete_rule_confirm'))) return;
            try {
                await request(`/forward-rules/${ruleId}`, { method: 'DELETE' });
                loadForwardRules(domainId, domainName);
                showToast(I18n.t('common.deleted'));
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }

        // ========== 证书夹功能 ==========
        let allCertificates = [];
        let currentAcmeDomain = '';

        function openCertDrawer() {
            document.getElementById('cert-drawer').classList.remove('translate-x-full');
            document.getElementById('cert-drawer-backdrop').classList.remove('hidden');
            loadCertificates();
        }

        function closeCertDrawer() {
            document.getElementById('cert-drawer').classList.add('translate-x-full');
            document.getElementById('cert-drawer-backdrop').classList.add('hidden');
        }

        async function loadCertificates() {
            const container = document.getElementById('cert-list');
            try {
                const certs = await request('/certs');
                allCertificates = certs;
                
                if (!certs || certs.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <p data-i18n="domains.cert.empty">暂无证书</p>
                            <p class="text-xs mt-1" data-i18n="domains.cert.empty_hint">点击上方按钮上传或申请证书</p>
                        </div>`;
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                container.innerHTML = certs.map(c => {
                    const statusClass = {
                        'valid': 'bg-green-100 text-green-700',
                        'warning': 'bg-yellow-100 text-yellow-700',
                        'critical': 'bg-red-100 text-red-700',
                        'expired': 'bg-gray-100 text-gray-500'
                    }[c.status] || 'bg-gray-100 text-gray-500';
                    
                    const statusIcon = {
                        'valid': '✅',
                        'warning': '⚠️',
                        'critical': '🔴',
                        'expired': '❌'
                    }[c.status] || '❓';

                    const sourceLabel = c.source === 'letsencrypt' ? "Let's Encrypt" : '手动上传';
                    
                    return `
                        <div class="bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-gray-800 truncate" title="${c.domains.join(', ')}">${c.domains[0] || c.name || '未知'}</h4>
                                    ${c.domains.length > 1 ? `<p class="text-xs text-gray-400">+${c.domains.length - 1} 个域名</p>` : ''}
                                </div>
                                <span class="text-xs px-2 py-0.5 rounded ${statusClass} flex-shrink-0 ml-2">
                                    ${statusIcon} ${c.days_left >= 0 ? c.days_left + '天' : '已过期'}
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 space-y-1">
                                <p><span class="text-gray-400">颁发者:</span> ${c.issuer || '未知'}</p>
                                <p><span class="text-gray-400">到期:</span> ${new Date(c.not_after).toLocaleDateString()}</p>
                                <p><span class="text-gray-400">来源:</span> ${sourceLabel}</p>
                            </div>
                            <div class="mt-3 flex justify-end space-x-2">
                                <button onclick="applyCertToSTARTTLS(${c.id})" class="text-xs px-2 py-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded transition" data-i18n="domains.cert.apply_starttls">应用到STARTTLS</button>
                                <button onclick="deleteCertificate(${c.id})" class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded transition" data-i18n="common.delete">删除</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) {
                console.error('加载证书失败', e);
                container.innerHTML = `<div class="text-center text-red-500 py-4">加载失败: ${e.message}</div>`;
            }
        }

        // 上传证书
        function openUploadCertModal() {
            document.getElementById('upload-cert-modal').classList.remove('hidden');
            document.getElementById('cert-name').value = '';
            document.getElementById('cert-pem').value = '';
            document.getElementById('key-pem').value = '';
        }

        function closeUploadCertModal() {
            document.getElementById('upload-cert-modal').classList.add('hidden');
        }

        async function uploadCertificate(e) {
            e.preventDefault();
            const name = document.getElementById('cert-name').value;
            const certPem = document.getElementById('cert-pem').value;
            const keyPem = document.getElementById('key-pem').value;

            try {
                await request('/certs', {
                    method: 'POST',
                    body: JSON.stringify({ name, cert_pem: certPem, key_pem: keyPem })
                });
                closeUploadCertModal();
                loadCertificates();
                showToast(I18n.t('domains.cert.upload_success') || '证书上传成功');
            } catch (err) {
                showToast(err.message || '上传失败', 'error');
            }
        }

        // ACME 申请证书
        function openAcmeModal() {
            document.getElementById('acme-modal').classList.remove('hidden');
            document.getElementById('acme-step1').classList.remove('hidden');
            document.getElementById('acme-step2').classList.add('hidden');
            document.getElementById('acme-domain').value = '';
            document.getElementById('acme-email').value = '';
        }

        function closeAcmeModal() {
            document.getElementById('acme-modal').classList.add('hidden');
            currentAcmeDomain = '';
        }

        async function initAcmeChallenge(e) {
            e.preventDefault();
            const domain = document.getElementById('acme-domain').value;
            const email = document.getElementById('acme-email').value;
            currentAcmeDomain = domain;

            try {
                const result = await request('/certs/acme/init', {
                    method: 'POST',
                    body: JSON.stringify({ domain, email, dns_provider: 'manual' })
                });
                
                // 显示 DNS 记录
                document.getElementById('acme-txt-record').innerText = result.txt_record;
                document.getElementById('acme-txt-value').innerText = result.txt_value;
                
                // 切换到步骤 2
                document.getElementById('acme-step1').classList.add('hidden');
                document.getElementById('acme-step2').classList.remove('hidden');
                
                showToast(I18n.t('domains.cert.acme_init_success') || '请添加 DNS 记录');
            } catch (err) {
                showToast(err.message || '初始化失败', 'error');
            }
        }

        async function verifyAcmeChallenge() {
            if (!currentAcmeDomain) {
                showToast('域名信息丢失，请重新开始', 'error');
                return;
            }

            try {
                await request('/certs/acme/verify', {
                    method: 'POST',
                    body: JSON.stringify({ domain: currentAcmeDomain })
                });
                
                closeAcmeModal();
                loadCertificates();
                showToast(I18n.t('domains.cert.acme_success') || '证书申请成功！');
            } catch (err) {
                showToast(err.message || '验证失败，请确保 DNS 记录已正确添加', 'error');
            }
        }

        async function cancelAcmeChallenge() {
            if (currentAcmeDomain) {
                try {
                    await request(`/certs/acme/challenge/${currentAcmeDomain}`, { method: 'DELETE' });
                } catch (e) {}
            }
            closeAcmeModal();
        }

        // 应用证书到 STARTTLS
        async function applyCertToSTARTTLS(certId) {
            if (!confirm(I18n.t('domains.cert.apply_confirm') || '确定要将此证书应用到 STARTTLS 配置吗？应用后需要重启服务生效。')) {
                return;
            }

            try {
                await request(`/certs/${certId}/apply-starttls`, { method: 'POST' });
                showToast(I18n.t('domains.cert.apply_success') || '证书已应用，请重启服务生效');
            } catch (err) {
                showToast(err.message || '应用失败', 'error');
            }
        }

        // 删除证书
        async function deleteCertificate(certId) {
            if (!confirm(I18n.t('domains.cert.delete_confirm') || '确定要删除此证书吗？')) {
                return;
            }

            try {
                await request(`/certs/${certId}`, { method: 'DELETE' });
                loadCertificates();
                showToast(I18n.t('common.deleted') || '已删除');
            } catch (err) {
                showToast(err.message || '删除失败', 'error');
            }
        }

        // 复制到剪贴板
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast('已复制')).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                showToast('已复制');
            } catch (e) {
                showToast('复制失败', 'error');
            }
            document.body.removeChild(ta);
        }
        
        loadDomains();
    </script>
</body>
</html>
