<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>域名管理 - 晴辰云邮</title>
    <link href="/dashboard/css/tailwind.min.css?v=8.0" rel="stylesheet">
    <script src="/dashboard/js/loader.js?v=8.0"></script>
    <script src="/dashboard/js/common.js?v=8.0"></script>
    <script src="/dashboard/js/layout.js?v=8.0"></script>
</head>
<body class="hidden" data-i18n-module="domains">
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-gray-800" data-i18n="domains.title">域名管理</h2>
            <p class="text-gray-500 mt-1" data-i18n="domains.subtitle">配置发信域名与 DNS 验证</p>
        </div>
        <button onclick="openModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span data-i18n="domains.add_btn">添加域名</span>
        </button>
    </div>

    <!-- 域名列表 -->
    <div id="domain-list" class="space-y-6"></div>

    <!-- 添加域名模态框 -->
    <div id="domain-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-8 w-[500px] shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800" data-i18n="domains.modal.add_title">添加发信域名</h3>
            <div class="mb-6 bg-blue-50 text-blue-700 text-sm p-4 rounded-lg flex items-start">
                <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p data-i18n="domains.modal.add_desc">系统将自动生成 SPF、DKIM 和 DMARC 记录。请确保您拥有该域名的 DNS 管理权限。</p>
            </div>
            <form onsubmit="saveDomain(event)">
                <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.domain_label">域名</label>
                <input type="text" id="domain-name" required placeholder="例如: newsletter.example.com" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none mb-6">
                
                <!-- 初始配置: 邮件子域名 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.prefix_label">邮件服务器前缀 (可选)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="domain-prefix" data-i18n-attr="placeholder:domains.modal.prefix_ph" placeholder="默认为主域名 (@)" class="w-32 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <span class="text-gray-400 text-sm">.your-domain.com</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" data-i18n="domains.modal.prefix_hint">推荐填 "mail" 或 "smtp"。留空则使用主域名。</p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">取消</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition" data-i18n="common.next">下一步</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加转发规则模态框 -->
    <div id="forward-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-8 w-[550px] shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800" data-i18n="domains.modal.fwd_title">添加邮件转发规则</h3>
            <div class="mb-4 bg-indigo-50 text-indigo-700 text-sm p-4 rounded-lg flex items-start">
                <svg class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                    <p class="font-medium mb-1" data-i18n="domains.modal.fwd_desc_title">转发规则说明</p>
                    <p data-i18n="domains.modal.fwd_desc">当有邮件发送到域名邮箱时，系统会自动转发到指定的目标邮箱。需要先在 DNS 添加 MX 记录指向本服务器，并启用接收服务。</p>
                </div>
            </div>
            <form onsubmit="saveForwardRule(event)">
                <input type="hidden" id="forward-domain-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.match_type">匹配模式</label>
                    <select id="forward-match-type" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" onchange="updateMatchAddrPlaceholder()">
                        <option value="all" data-i18n="domains.match.all">全部 - 接收所有发往该域名的邮件</option>
                        <option value="exact" data-i18n="domains.match.exact">精确匹配 - 仅匹配指定地址</option>
                        <option value="prefix" data-i18n="domains.match.prefix">前缀匹配 - 匹配以指定前缀开头的地址</option>
                    </select>
                </div>
                <div class="mb-4" id="match-addr-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.match_addr">匹配地址</label>
                    <div class="flex items-center">
                        <input type="text" id="forward-match-addr" placeholder="例如: support" class="flex-1 border rounded-l-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <span id="forward-domain-suffix" class="bg-gray-100 border border-l-0 rounded-r-lg px-3 py-2 text-gray-500">@example.com</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" data-i18n="domains.modal.match_hint">留空表示匹配所有地址（仅限"全部"模式）</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.forward_to">转发到 <span class="text-red-500">*</span></label>
                    <input type="email" id="forward-to" required placeholder="例如: your-email@gmail.com" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="domains.modal.remark">备注</label>
                    <input type="text" id="forward-remark" data-i18n-attr="placeholder:domains.modal.remark_ph" placeholder="可选备注" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeForwardModal()" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" data-i18n="common.cancel">取消</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md transition" data-i18n="domains.modal.save_rule">保存规则</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        Auth.check();

        function openModal() { document.getElementById('domain-modal').classList.remove('hidden'); document.getElementById('domain-name').value = ''; document.getElementById('domain-prefix').value = 'mail'; }
        function closeModal() { document.getElementById('domain-modal').classList.add('hidden'); }

        // 防抖函数，用于自动保存
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function loadDomains() {
            try {
                const list = await request('/domains');
                const container = document.getElementById('domain-list');
                container.innerHTML = '';

                if (list.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16 bg-white rounded-xl border-2 border-dashed border-gray-300">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                            <p class="text-gray-500 text-lg" data-i18n="domains.empty_title">暂无配置域名</p>
                            <button onclick="openModal()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium" data-i18n="domains.empty_btn">立即添加第一个域名</button>
                        </div>`;
                    
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                list.forEach(d => {
                    const statusBadge = (verified, label) => 
                        `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${verified ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                            <span class="w-2 h-2 rounded-full mr-1.5 ${verified ? 'bg-green-500' : 'bg-gray-400'}"></span>
                            ${label}: <span data-i18n="${verified ? 'domains.status.verified' : 'domains.status.unverified'}">${verified ? '已验证' : '未验证'}</span>
                        </span>`;

                    // 初始化前缀（如果是旧数据没字段，默认为空）
                    const prefix = d.mail_subdomain_prefix || '';

                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden';
                    div.innerHTML = `
                        <div class="p-6 border-b border-gray-100 flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                                    ${d.name}
                                    <span class="ml-3 text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded">ID: ${d.id}</span>
                                </h3>
                                <div class="flex flex-wrap gap-2 mt-3">
                                    ${statusBadge(d.spf_verified, 'SPF')}
                                    ${statusBadge(d.dkim_verified, 'DKIM')}
                                    ${statusBadge(d.dmarc_verified, 'DMARC')}
                                    ${statusBadge(d.mx_verified, 'MX')}
                                    <span id="badge-a-${d.id}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                        <span class="w-2 h-2 rounded-full mr-1.5 bg-gray-400"></span> <span data-i18n="domains.status.a_checking">A记录: 检测中...</span>
                                    </span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="verifyDomain(${d.id})" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100 transition text-sm font-medium" data-i18n="domains.action.refresh">刷新状态</button>
                                <button onclick="deleteDomain(${d.id})" class="px-3 py-1.5 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition text-sm" data-i18n="domains.action.delete">删除</button>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-50">
                            <div class="mb-6 flex justify-between items-end">
                                <div>
                                    <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-1" data-i18n="domains.dns.title">DNS 配置记录</h4>
                                    <p class="text-xs text-gray-500" data-i18n="domains.dns.subtitle">请在您的 DNS 服务商处添加以下记录</p>
                                </div>
                                <div class="flex items-center bg-white border rounded-lg px-3 py-2 shadow-sm">
                                    <span class="text-xs text-gray-500 mr-2" data-i18n="domains.dns.mail_server">邮件服务器地址:</span>
                                    <div class="relative">
                                        <input type="text" 
                                            id="prefix-input-${d.id}" 
                                            value="${prefix}" 
                                            data-i18n-attr="placeholder:domains.modal.prefix_ph"
                                            placeholder="@ (主域名)"
                                            class="w-24 text-sm font-medium text-gray-800 outline-none text-right placeholder-gray-300"
                                            oninput="handlePrefixChange(${d.id}, '${d.name}', this.value)"
                                        >
                                        <div class="absolute right-0 -bottom-5 text-[10px] text-green-600 transition-opacity opacity-0" id="save-tip-${d.id}" data-i18n="domains.dns.saved">已保存</div>
                                    </div>
                                    <span class="text-sm text-gray-400 ml-1">.${d.name}</span>
                                </div>
                            </div>

                            <div class="space-y-3" id="dns-records-${d.id}">
                                <!-- 动态内容由 updateDNSRecords 渲染 -->
                            </div>

                            <!-- SPF/DKIM/DMARC -->
                            <div class="space-y-3 mt-3">
                                <!-- SPF 记录 (动态 ID) -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">@</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="spf-${d.id}"></div>
                                    </div>
                                    <button onclick="copyText('spf-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制记录值">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>

                                <!-- DKIM 记录 -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">default._domainkey</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="dkim-${d.id}">v=DKIM1; k=rsa; p=${d.dkim_public_key.replace(/-----.*-----|\n/g, '')}</div>
                                    </div>
                                    <button onclick="copyText('dkim-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制记录值">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>

                                <!-- DMARC 记录 -->
                                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">TXT</div>
                                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">_dmarc</div>
                                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all" id="dmarc-${d.id}">v=DMARC1; p=none; rua=mailto:postmaster@${d.name}</div>
                                    </div>
                                    <button onclick="copyText('dmarc-${d.id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制记录值">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>
                            </div>

                            <!-- 备案提示 -->
                            <div class="mt-4 bg-orange-50 border border-orange-100 rounded-lg p-3 text-xs text-orange-700 flex items-start">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                <div>
                                    <p class="font-medium">⚠️ <span data-i18n="domains.icp.title">备案提示</span>：</p>
                                    <p data-i18n="domains.icp.desc1">如果您的服务器在中国大陆，且域名未备案，可能会导致 80/443 端口（网站访问）被拦截。</p>
                                    <p class="mt-1" data-i18n="domains.icp.desc2">但这不会影响邮件收发功能（使用 SMTP/25 端口）。只要 DNS 解析正确，邮件服务即可正常运行。</p>
                                </div>
                            </div>
                            
                            <!-- 转发规则... (省略保持不变) -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 flex justify-between items-center">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                        <span data-i18n="domains.forward.title">邮件转发规则</span>
                                    </span>
                                    <button onclick="openForwardModal(${d.id}, '${d.name}')" class="text-xs font-medium text-indigo-600 hover:text-indigo-800 flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        <span data-i18n="domains.forward.add">添加规则</span>
                                    </button>
                                </h4>
                                <div id="forward-rules-${d.id}" class="space-y-2">
                                    <div class="text-sm text-gray-400 italic">加载中...</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                    // 渲染初始 DNS 记录
                    updateDNSRecords(d.id, d.name, prefix);
                    // 检查 A 记录
                    checkARecord(prefix ? `${prefix}.${d.name}` : d.name, d.id);
                    // 加载转发规则
                    loadForwardRules(d.id, d.name);
                });
                
                // 渲染所有生成的 data-i18n
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();

            } catch (e) {
                console.error(e);
            }
        }

        // 处理前缀变更（输入框输入时触发）
        const savePrefixDebounced = debounce(async (id, prefix) => {
            try {
                await request(`/domains/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ mail_subdomain_prefix: prefix })
                });
                // 显示“已保存”提示
                const tip = document.getElementById(`save-tip-${id}`);
                tip.style.opacity = '1';
                setTimeout(() => tip.style.opacity = '0', 2000);
            } catch (err) {
                showToast('自动保存失败', 'error');
            }
        }, 800); // 延迟 800ms 保存

        function handlePrefixChange(id, domainName, value) {
            // 1. 更新 UI
            updateDNSRecords(id, domainName, value);
            // 2. 触发 A 记录检查
            const host = value ? `${value}.${domainName}` : domainName;
            checkARecord(host, id);
            // 3. 触发后端保存
            savePrefixDebounced(id, value);
        }

        async function saveDomain(e) {
            e.preventDefault();
            const name = document.getElementById('domain-name').value;
            const prefix = document.getElementById('domain-prefix').value;
            try {
                // 先创建
                const res = await request('/domains', { method: 'POST', body: JSON.stringify({ name }) });
                // 如果有前缀，立即更新
                if (prefix && res.id) {
                    await request(`/domains/${res.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ mail_subdomain_prefix: prefix })
                    });
                }
                closeModal();
                loadDomains();
                showToast(I18n.t('domains.toast.add_success'));
            } catch (err) {
                showToast(err.message || '添加失败', 'error');
            }
        }

        async function verifyDomain(id) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = I18n.t('domains.action.verifying');
            btn.disabled = true;
            try {
                await request(`/domains/${id}/verify`, { method: 'POST' });
                await loadDomains();
                showToast(I18n.t('domains.toast.verified'));
            } catch (e) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function deleteDomain(id) {
            if (confirm(I18n.t('domains.alert.delete_confirm'))) {
                try {
                    await request(`/domains/${id}`, { method: 'DELETE' });
                    loadDomains();
                    showToast(I18n.t('common.success'));
                } catch (e) {}
            }
        }

        // ========== 通用函数 (Copy, CheckA, Render) ==========

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast('已复制')).catch(() => fallbackCopyText(text));
            } else {
                fallbackCopyText(text);
            }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy') ? showToast('已复制') : showToast('复制失败', 'error');
            } catch (err) {
                showToast('复制失败', 'error');
            }
            document.body.removeChild(textArea);
        }

        function updateDNSRecords(id, domainName, prefix) {
            const container = document.getElementById(`dns-records-${id}`);
            if (!container) return;

            const hostname = window.location.hostname;
            // 如果 prefix 为空，表示用主域名 @；否则用 prefix
            const aRecordHost = prefix ? prefix : '@';
            const mxRecordValue = prefix ? `${prefix}.${domainName}` : domainName;
            
            // 优化 SPF: 直接使用 ip4 机制，比 mx 机制更稳定，不受 MX 解析延迟影响
            // 注意：这里我们动态更新 SPF 显示，但不保存到数据库，因为后端验证也是动态的
            const spfValue = `v=spf1 ip4:${hostname} -all`;
            
            // 更新 SPF 容器 (如果存在)
            const spfContainer = document.getElementById(`spf-${id}`);
            if (spfContainer) {
                spfContainer.innerText = spfValue;
            }

            container.innerHTML = `
                <!-- A 记录 -->
                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative border-l-4 border-l-blue-500">
                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1 font-bold">A</div>
                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">${aRecordHost}</div>
                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all flex items-center">
                            <span id="a-${id}" class="bg-gray-50 px-1 rounded border border-gray-200">${hostname}</span>
                            <span class="text-gray-400 ml-2 text-[10px] hidden sm:inline-block">← <span data-i18n="domains.dns.server_ip">您的服务器IP</span></span>
                        </div>
                    </div>
                    <button onclick="copyText('a-${id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制 IP">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    </button>
                </div>

                <!-- MX 记录 -->
                <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between group relative">
                    <div class="flex-1 min-w-0 grid grid-cols-12 gap-4 pr-8">
                        <div class="col-span-1 text-xs text-gray-500 font-mono pt-1">MX</div>
                        <div class="col-span-2 text-sm font-mono text-gray-800 select-all">@</div>
                        <div class="col-span-9 text-xs font-mono text-gray-600 break-all pt-0.5 select-all flex items-center">
                            <span id="mx-${id}" class="bg-gray-50 px-1 rounded border border-gray-200">${mxRecordValue}</span>
                            <span class="text-gray-400 ml-2 text-[10px] hidden sm:inline-block">← <span data-i18n="domains.dns.priority_10">优先级 10</span></span>
                        </div>
                    </div>
                    <button onclick="copyText('mx-${id}')" class="absolute right-3 top-3 text-gray-400 hover:text-blue-600 transition" title="复制域名">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    </button>
                </div>
            `;
        }

        async function checkARecord(hostname, id) {
            const badge = document.getElementById(`badge-a-${id}`);
            if (!badge) return;

            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-yellow-500"></span> <span data-i18n="domains.status.a_local">A记录: 本地环境</span>`;
                // 这里也需要 render 吗？updateDNSRecords 是同步的，checkARecord 是异步的。
                // 如果 checkARecord 执行慢了，上面的 I18n.render() 已经跑完了。
                // 所以这里更新 HTML 后，需要再次 render。
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                return;
            }

            badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600';
            badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-gray-400"></span> <span data-i18n="domains.status.a_checking">A记录: 检测中...</span>`;
            if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();

            try {
                const response = await fetch(`https://cloudflare-dns.com/dns-query?name=${hostname}&type=A`, {
                    headers: { 'Accept': 'application/dns-json' }
                });
                const data = await response.json();
                
                if (data.Answer && data.Answer.some(r => r.type === 1)) {
                    badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-green-500"></span> <span data-i18n="domains.status.a_ok">A记录: 已解析</span>`;
                } else {
                    badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    badge.innerHTML = `<span class="w-2 h-2 rounded-full mr-1.5 bg-red-500"></span> <span data-i18n="domains.status.a_missing">A记录: 未找到</span>`;
                }
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) { console.error(e); }
        }

        // ========== 转发规则逻辑 ==========

        let currentForwardDomainName = '';

        function openForwardModal(domainId, domainName) {
            document.getElementById('forward-modal').classList.remove('hidden');
            document.getElementById('forward-domain-id').value = domainId;
            document.getElementById('forward-match-type').value = 'all';
            document.getElementById('forward-match-addr').value = '';
            document.getElementById('forward-to').value = '';
            document.getElementById('forward-remark').value = '';
            currentForwardDomainName = domainName;
            updateMatchAddrPlaceholder();
        }

        function closeForwardModal() {
            document.getElementById('forward-modal').classList.add('hidden');
        }

        function updateMatchAddrPlaceholder() {
            const matchType = document.getElementById('forward-match-type').value;
            const addrGroup = document.getElementById('match-addr-group');
            const addrInput = document.getElementById('forward-match-addr');
            
            if (matchType === 'all') {
                addrGroup.style.display = 'none';
            } else {
                addrGroup.style.display = 'block';
                if (matchType === 'exact') {
                    addrInput.placeholder = I18n.t('domains.match.exact'); // 实际上这里应该用 data-i18n-attr 但动态修改属性比较麻烦，直接用 t
                } else {
                    addrInput.placeholder = I18n.t('domains.match.prefix');
                }
            }
        }

        async function loadForwardRules(domainId, domainName) {
            try {
                const rules = await request(`/forward-rules?domain_id=${domainId}`);
                const container = document.getElementById(`forward-rules-${domainId}`);
                
                if (!rules || rules.length === 0) {
                    container.innerHTML = `
                        <div class="text-sm text-gray-400 italic py-2">
                            <span data-i18n="domains.forward.empty">暂无转发规则。</span><button onclick="openForwardModal(${domainId}, '${domainName}')" class="text-indigo-500 hover:text-indigo-700" data-i18n="domains.forward.click_add">点击添加</button>
                        </div>`;
                    if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
                    return;
                }

                container.innerHTML = rules.map(r => {
                    const matchLabel = r.match_type === 'all' ? I18n.t('domains.forward.match_all') : 
                                       r.match_type === 'exact' ? I18n.t('domains.forward.match_exact') : I18n.t('domains.forward.match_prefix');
                    const matchDisplay = r.match_type === 'all' ? `*@${domainName}` : 
                                         `${r.match_addr}${r.match_type === 'prefix' ? '*' : ''}@${domainName}`;
                    return `
                        <div class="bg-white p-3 rounded border border-gray-200 flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-3 overflow-hidden">
                                <span class="text-xs px-2 py-0.5 rounded ${r.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'} flex-shrink-0">
                                    ${r.enabled ? I18n.t('common.enabled') : I18n.t('common.disabled')}
                                </span>
                                <span class="text-xs px-2 py-0.5 rounded bg-indigo-50 text-indigo-600 flex-shrink-0">${matchLabel}</span>
                                <div class="flex items-center space-x-1 truncate min-w-0">
                                    <span class="font-mono text-gray-700 truncate" title="${matchDisplay}">${matchDisplay}</span>
                                    <svg class="w-3 h-3 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                                    <span class="font-mono text-blue-600 truncate" title="${r.forward_to}">${r.forward_to}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0 ml-2">
                                <button onclick="toggleForwardRule(${r.id}, ${domainId}, '${domainName}')" 
                                        class="text-xs px-2 py-1 ${r.enabled ? 'text-orange-500 hover:bg-orange-50' : 'text-green-500 hover:bg-green-50'} rounded transition">
                                    ${r.enabled ? I18n.t('common.disable') : I18n.t('common.enable')}
                                </button>
                                <button onclick="deleteForwardRule(${r.id}, ${domainId}, '${domainName}')" 
                                        class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded transition" data-i18n="domains.action.delete">删除</button>
                            </div>
                        </div>
                    `;
                }).join('');
                if (typeof I18n !== 'undefined' && I18n.isReady) I18n.render();
            } catch (e) {
                console.error('加载转发规则失败', e);
            }
        }

        async function saveForwardRule(e) {
            e.preventDefault();
            const domainId = document.getElementById('forward-domain-id').value;
            const matchType = document.getElementById('forward-match-type').value;
            const matchAddr = document.getElementById('forward-match-addr').value;
            const forwardTo = document.getElementById('forward-to').value;
            const remark = document.getElementById('forward-remark').value;

            try {
                await request('/forward-rules', {
                    method: 'POST',
                    body: JSON.stringify({
                        domain_id: parseInt(domainId),
                        match_type: matchType,
                        match_addr: matchAddr,
                        forward_to: forwardTo,
                        remark: remark
                    })
                });
                closeForwardModal();
                loadForwardRules(domainId, currentForwardDomainName);
                showToast(I18n.t('domains.toast.rule_add_success'));
            } catch (err) {
                showToast(err.message || '未知错误', 'error');
            }
        }

        async function toggleForwardRule(ruleId, domainId, domainName) {
            try {
                await request(`/forward-rules/${ruleId}/toggle`, { method: 'POST' });
                loadForwardRules(domainId, domainName);
                showToast(I18n.t('domains.toast.status_updated'));
            } catch (e) {
                showToast('操作失败', 'error');
            }
        }

        async function deleteForwardRule(ruleId, domainId, domainName) {
            if (!confirm(I18n.t('domains.alert.delete_rule_confirm'))) return;
            try {
                await request(`/forward-rules/${ruleId}`, { method: 'DELETE' });
                loadForwardRules(domainId, domainName);
                showToast(I18n.t('common.deleted'));
            } catch (e) {
                showToast('删除失败', 'error');
            }
        }
        
        loadDomains();
    </script>
</body>
</html>
