<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>系统设置 - 晴辰云邮</title>
    <link href="/dashboard/css/tailwind.min.css?v=8.0" rel="stylesheet">
    <script src="/dashboard/js/loader.js?v=8.0"></script>
    <script src="/dashboard/js/common.js?v=8.0"></script>
    <script src="/dashboard/js/layout.js?v=8.0"></script>
</head>
<body class="hidden" data-i18n-module="settings">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800" data-i18n="settings.title">系统设置</h2>
        <p class="text-gray-500 mt-1" data-i18n="settings.subtitle">配置服务器运行参数与安全选项</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <!-- 基础业务配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:col-span-2">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-purple-100 text-purple-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </span>
                <span data-i18n="settings.biz.title">基础业务配置</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.biz.domain_label">默认发信域名 (Domain)</label>
                    <!-- 下拉选择模式 -->
                    <div id="domain-select-mode" class="relative">
                        <select id="domain-select" onchange="onSelectChange()" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500 appearance-none bg-white">
                            <option value="" data-i18n="common.loading">加载中...</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <button type="button" onclick="toggleDomainInput(true)" class="absolute right-8 top-0 bottom-0 px-2 text-xs text-blue-600 hover:text-blue-800 bg-transparent" data-i18n="settings.biz.manual_input">手动输入</button>
                    </div>
                    <!-- 手动输入模式 -->
                    <div id="domain-input-mode" class="relative hidden">
                        <input type="text" id="domain-input" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500" placeholder="example.com">
                        <button type="button" onclick="toggleDomainInput(false)" class="absolute right-2 top-2 text-xs text-blue-600 hover:text-blue-800" data-i18n="settings.biz.select_list">选择列表</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.biz.domain_hint">当未指定发件人时，将使用 noreply@此域名</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.biz.dkim_label">DKIM Selector</label>
                    <input type="text" id="dkim_selector" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500" placeholder="default">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.biz.dkim_hint">DKIM 签名的选择器，通常保持默认</p>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                <button type="button" onclick="saveConfig(event, 'business')" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition shadow-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    <span data-i18n="settings.biz.save_btn">保存业务配置</span>
                </button>
            </div>
        </div>
        
        <!-- Web 服务配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </span>
                <span data-i18n="settings.web.title">Web 服务配置</span>
            </h3>
            
            <form onsubmit="saveConfig(event, 'web')" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.host_label">监听地址 (Host)</label>
                        <div class="relative">
                            <input type="text" id="host" list="host-list" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.0.0.0">
                            <datalist id="host-list">
                                <option value="0.0.0.0" data-i18n="settings.web.host_public">0.0.0.0 (允许公网访问)</option>
                                <option value="127.0.0.1" data-i18n="settings.web.host_local">127.0.0.1 (仅本机/反向代理)</option>
                            </datalist>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" data-i18n="settings.web.host_hint">支持下拉选择或手动输入</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.port_label">监听端口 (Port)</label>
                        <input type="text" id="port" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="9901">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.base_url">公网访问地址 (BaseURL)</label>
                    <input type="text" id="base_url" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://mail.example.com:9901">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.web.base_url_hint">用于生成邮件中的追踪链接和退订链接，请务必填写外部可访问的完整 URL</p>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <div class="mb-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="enable_ssl" class="form-checkbox h-5 w-5 text-blue-600 rounded transition" onchange="toggleSSL()">
                            <span class="ml-2 font-medium text-gray-700" data-i18n="settings.web.ssl_enable">启用 HTTPS (SSL)</span>
                        </label>
                        <p class="text-xs text-yellow-600 mt-1 ml-7" data-i18n="settings.web.ssl_hint">
                            ⚠️ 提示：如果您使用 Nginx/Apache 反向代理，请勿开启此项，直接配置 Nginx 即可。
                        </p>
                    </div>

                    <div id="ssl-config" class="space-y-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.cert_label">证书文件路径 (.crt/.pem)</label>
                            <input type="text" id="cert_file" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="./cert.pem">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.key_label">私钥文件路径 (.key)</label>
                            <input type="text" id="key_file" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="./key.pem">
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition shadow-md">
                        <span data-i18n="settings.web.save_btn">保存 Web 配置</span>
                    </button>
                    <p class="text-xs text-center text-red-500 mt-2" data-i18n="settings.web.restart_hint">注意：修改监听配置后，需要手动重启程序才能生效！</p>
                </div>
            </form>
        </div>

        <!-- 邮件接收服务配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </span>
                <span data-i18n="settings.recv.title">邮件接收服务 (转发)</span>
            </h3>
            
            <form onsubmit="saveConfig(event, 'receiver')" class="space-y-5">
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="enable_receiver" class="form-checkbox h-5 w-5 text-indigo-600 rounded transition" onchange="toggleReceiver()">
                        <span class="ml-2 font-medium text-gray-700" data-i18n="settings.recv.enable">启用 SMTP 接收服务</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-7" data-i18n="settings.recv.desc">
                        启用后可接收发往域名邮箱的邮件，并根据转发规则转发到指定邮箱。
                    </p>
                </div>

                <div id="receiver-config" class="space-y-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 text-sm p-3 rounded-lg">
                        <p class="font-medium mb-1" data-i18n="settings.recv.req_title">⚠️ 使用前提</p>
                        <ul class="list-disc list-inside text-xs space-y-1">
                            <li data-i18n="settings.recv.req_1">需要在域名 DNS 添加 MX 记录指向本服务器 IP</li>
                            <li data-i18n="settings.recv.req_2">端口 25 需要服务器防火墙放行（部分云服务商默认封禁）</li>
                            <li data-i18n="settings.recv.req_3">Linux 下监听 25 端口需要 root 权限或使用 <code class="bg-yellow-100 px-1 rounded">setcap</code></li>
                        </ul>
                    </div>
                    
                    <!-- 端口被占用解决方案 -->
                    <details class="bg-blue-50 border border-blue-200 text-blue-700 text-sm rounded-lg">
                        <summary class="p-3 cursor-pointer font-medium hover:bg-blue-100 rounded-lg transition" data-i18n="settings.recv.port_conflict_title">💡 端口 25 被占用？查看解决方案</summary>
                        <div class="px-3 pb-3 text-xs space-y-3">
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_1_title">方案 1: 端口转发 (推荐)</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_1_desc">程序监听 2525，用 iptables 转发 25→2525：</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto">sudo iptables -t nat -A PREROUTING -p tcp --dport 25 -j REDIRECT --to-port 2525</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_2_title">方案 2: Nginx TCP 代理</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_2_desc">使用 Nginx stream 模块代理：</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto whitespace-pre">stream {
    server {
        listen 25;
        proxy_pass 127.0.0.1:2525;
    }
}</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_3_title">方案 3: 停用原有 MTA</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_3_desc">停止 Postfix/Sendmail 等：</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto">sudo systemctl stop postfix && sudo systemctl disable postfix</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_4_title">方案 4: 与 Postfix 集成</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_4_desc">配置 Postfix 将邮件转发到本程序，详见文档。</p>
                            </div>
                        </div>
                    </details>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.port_label">监听端口</label>
                            <div class="flex space-x-2">
                                <input type="text" id="receiver_port" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="25">
                                <button type="button" onclick="testPort()" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm font-medium whitespace-nowrap" data-i18n="settings.recv.test_btn">检测</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.rate_limit">速率限制 (连接/分钟)</label>
                            <input type="number" id="receiver_rate_limit" min="0" max="1000" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="30">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.max_size">最大邮件大小 (KB)</label>
                            <input type="number" id="receiver_max_msg_size" min="100" max="102400" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="10240">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.blacklist">IP 黑名单</label>
                            <input type="text" id="receiver_blacklist" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="1.2.3.4, 5.6.7.8">
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="receiver_tls" class="form-checkbox h-4 w-4 text-indigo-600 rounded transition" onchange="toggleReceiverTLS()">
                            <span class="ml-2 text-sm text-gray-700" data-i18n="settings.recv.tls_enable">启用 STARTTLS (加密传输)</span>
                        </label>
                        
                        <!-- TLS 证书配置 -->
                        <div id="receiver-tls-config" class="hidden ml-6 p-3 bg-white border border-indigo-200 rounded-lg space-y-3">
                            <div class="bg-red-50 border border-red-200 text-red-700 text-xs p-2 rounded">
                                <strong data-i18n="settings.recv.tls_warning_title">⚠️ 重要：</strong>
                                <span data-i18n="settings.recv.tls_warning">必须配置有效的 SSL 证书，否则 STARTTLS 将无法工作！可使用 Let's Encrypt 免费证书。</span>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1" data-i18n="settings.recv.tls_cert">证书文件 (.pem/.crt)</label>
                                <input type="text" id="receiver_tls_cert" class="w-full border rounded px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="/etc/letsencrypt/live/mail.example.com/fullchain.pem">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1" data-i18n="settings.recv.tls_key">私钥文件 (.key)</label>
                                <input type="text" id="receiver_tls_key" class="w-full border rounded px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="/etc/letsencrypt/live/mail.example.com/privkey.pem">
                            </div>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="receiver_require_tls" class="form-checkbox h-4 w-4 text-indigo-600 rounded transition">
                                <span class="ml-2 text-sm text-gray-700" data-i18n="settings.recv.require_tls">强制 TLS (拒绝明文连接)</span>
                            </label>
                            <p class="text-xs text-red-500" data-i18n="settings.recv.require_tls_warning">⚠️ 勾选后，未配置 STARTTLS 的发件方将无法给你发邮件！建议先测试后再开启。</p>
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2.5 rounded-lg hover:bg-indigo-700 transition shadow-md">
                        <span data-i18n="settings.recv.save_btn">保存接收服务配置</span>
                    </button>
                    <p class="text-xs text-center text-red-500 mt-2" data-i18n="settings.recv.restart_hint">注意：修改接收服务配置后，需要手动重启程序才能生效！</p>
                </div>
            </form>
        </div>

        <!-- 数据清理 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-orange-100 text-orange-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </span>
                <span data-i18n="settings.cleanup.title">数据清理</span>
            </h3>
            
            <form onsubmit="saveCleanupConfig(event)" class="space-y-5">
                <!-- 数据统计 -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-3" data-i18n="settings.cleanup.stats_title">当前数据量</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm" id="cleanup-stats">
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.email_logs">发送日志:</span> <span id="stat-email-logs" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.inbox">收件箱:</span> <span id="stat-inbox" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.queue">队列记录:</span> <span id="stat-queue" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.forward">转发日志:</span> <span id="stat-forward" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.attach">附件文件:</span> <span id="stat-attach" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.attach_size">附件大小:</span> <span id="stat-size" class="font-medium">-</span></div>
                    </div>
                </div>

                <!-- 自动清理开关 -->
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="cleanup_enabled" class="form-checkbox h-5 w-5 text-orange-600 rounded transition">
                        <span class="ml-2 font-medium text-gray-700" data-i18n="settings.cleanup.auto_enable">启用自动清理</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-7" data-i18n="settings.cleanup.auto_desc">
                        启用后，系统将在每天凌晨 3:00 自动清理过期数据。
                    </p>
                </div>

                <!-- 保留天数配置 -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.email_log_days">发送日志保留 (天)</label>
                        <input type="number" id="cleanup_email_log_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.inbox_days">收件箱保留 (天)</label>
                        <input type="number" id="cleanup_inbox_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.queue_days">队列记录保留 (天)</label>
                        <input type="number" id="cleanup_queue_days" min="1" max="90" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="7">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.forward_days">转发日志保留 (天)</label>
                        <input type="number" id="cleanup_forward_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.attach_days">附件保留 (天)</label>
                        <input type="number" id="cleanup_attach_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                </div>

                <div class="pt-4 space-y-3">
                    <button type="submit" class="w-full font-bold py-2.5 rounded-lg transition shadow-md flex items-center justify-center" style="background-color: #ea580c; color: white;">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        <span data-i18n="settings.cleanup.save_btn">保存清理配置</span>
                    </button>
                    <button type="button" onclick="runCleanup()" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-2.5 rounded-lg hover:bg-red-100 transition flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span data-i18n="settings.cleanup.run_btn">立即清理</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- 密码与安全 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col justify-between">
            <div>
                <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                    <span class="bg-green-100 text-green-600 p-1.5 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </span>
                    <span data-i18n="settings.sec.title">安全设置</span>
                </h3>

                <div class="mb-8">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.backup_title">数据备份</h4>
                    <p class="text-xs text-gray-500 mb-3" data-i18n="settings.sec.backup_desc">将 config.json 和数据库文件打包下载，建议定期备份。</p>
                    <button onclick="downloadBackup()" class="w-full bg-blue-50 text-blue-600 border border-blue-200 font-bold py-2 rounded-lg hover:bg-blue-100 transition text-sm flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span data-i18n="settings.sec.backup_btn">下载完整备份</span>
                    </button>
                </div>
                
                <form onsubmit="changePassword(event)" class="space-y-4 mb-8">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.pwd_title">修改管理员密码</h4>
                    <div>
                        <input type="password" id="old-pass" required data-i18n-attr="placeholder:settings.sec.old_pwd_ph" placeholder="当前密码" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <div>
                        <input type="password" id="new-pass" required data-i18n-attr="placeholder:settings.sec.new_pwd_ph" placeholder="新密码" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <div class="pt-1">
                        <button type="submit" class="w-full bg-green-50 text-green-700 border border-green-200 font-bold py-2 rounded-lg hover:bg-green-100 transition text-sm">
                            <span data-i18n="settings.sec.pwd_btn">更新密码</span>
                        </button>
                    </div>
                </form>

                <!-- 两步验证 (2FA) -->
                <div class="mb-8 border-t border-gray-100 pt-6">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.totp_title">两步验证 (2FA)</h4>
                    
                    <!-- 未启用状态 -->
                    <div id="totp-disabled-section">
                        <p class="text-xs text-gray-500 mb-3" data-i18n="settings.sec.totp_desc">启用后，登录时需要输入验证器 App 中的动态验证码。</p>
                        <button type="button" onclick="setupTOTP()" class="w-full bg-indigo-50 text-indigo-600 border border-indigo-200 font-bold py-2 rounded-lg hover:bg-indigo-100 transition text-sm flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                            <span data-i18n="settings.sec.totp_enable_btn">启用两步验证</span>
                        </button>
                    </div>

                    <!-- 已启用状态 -->
                    <div id="totp-enabled-section" class="hidden">
                        <div class="flex items-center text-green-600 mb-3">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="text-sm font-semibold" data-i18n="settings.sec.totp_enabled">两步验证已启用</span>
                        </div>
                        <button type="button" onclick="showDisableTOTPModal()" class="w-full bg-gray-50 text-gray-600 border border-gray-200 font-bold py-2 rounded-lg hover:bg-gray-100 transition text-sm">
                            <span data-i18n="settings.sec.totp_disable_btn">关闭两步验证</span>
                        </button>
                    </div>

                    <!-- 设置二维码（弹窗模式） -->
                    <div id="totp-setup-section" class="hidden mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <p class="text-sm text-indigo-700 font-semibold mb-3" data-i18n="settings.sec.totp_scan">请使用验证器 App 扫描二维码：</p>
                        <div class="flex justify-center mb-3">
                            <img id="totp-qrcode" src="" alt="TOTP QR Code" class="w-48 h-48 border border-indigo-300 rounded-lg bg-white p-2">
                        </div>
                        <p class="text-xs text-indigo-600 mb-2" data-i18n="settings.sec.totp_manual">或手动输入密钥：</p>
                        <div class="flex items-center mb-4">
                            <code id="totp-secret" class="flex-1 bg-white px-3 py-2 rounded border border-indigo-200 text-xs font-mono text-indigo-800 select-all"></code>
                            <button type="button" onclick="copyTOTPSecret()" class="ml-2 p-2 bg-white border border-indigo-200 rounded hover:bg-indigo-100 transition">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="totp-verify-code" maxlength="6" pattern="[0-9]{6}" data-i18n-attr="placeholder:settings.sec.totp_code_ph" placeholder="输入 6 位验证码" class="flex-1 border border-indigo-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 text-sm text-center font-mono tracking-widest">
                            <button type="button" onclick="enableTOTP()" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition text-sm">
                                <span data-i18n="settings.sec.totp_confirm">确认启用</span>
                            </button>
                        </div>
                        <button type="button" onclick="cancelTOTPSetup()" class="w-full mt-3 text-xs text-gray-500 hover:text-gray-700">
                            <span data-i18n="settings.sec.totp_cancel">取消</span>
                        </button>
                    </div>

                    <p class="text-xs text-gray-400 mt-3" data-i18n="settings.sec.totp_reset_hint">忘记验证器？请在服务器执行 ./goemail -reset-totp</p>
                </div>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3" data-i18n="settings.sec.jwt_title">登录密钥 (JWT Secret)</h4>
                <p class="text-xs text-gray-500 mb-4 leading-relaxed" data-i18n="settings.sec.jwt_desc">
                    重置密钥将导致所有已登录用户（包括API Token）立即失效，需重新登录。仅在怀疑密钥泄露时使用。
                </p>
                <button type="button" onclick="resetSecret()" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-2 rounded-lg hover:bg-red-100 transition text-sm flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <span data-i18n="settings.sec.jwt_btn">重置并强制下线</span>
                </button>
            </div>
        </div>

        <!-- 系统更新 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-cyan-100 text-cyan-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </span>
                <span data-i18n="settings.update.title">系统更新</span>
            </h3>

            <!-- 版本信息 -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-5">
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex justify-between">
                        <span data-i18n="settings.update.current_ver">当前版本:</span>
                        <span id="update-current-ver" class="font-mono font-medium text-gray-700">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span data-i18n="settings.update.latest_ver">最新版本:</span>
                        <span id="update-latest-ver" class="font-mono font-medium text-gray-700">-</span>
                    </div>
                    <div class="flex justify-between col-span-2">
                        <span data-i18n="settings.update.platform">运行平台:</span>
                        <span id="update-platform" class="font-mono font-medium text-gray-500">-</span>
                    </div>
                </div>
            </div>

            <!-- 更新状态 -->
            <div id="update-status-box" class="hidden mb-5">
                <div class="flex items-center mb-2">
                    <div id="update-status-icon" class="w-5 h-5 mr-2">
                        <!-- 动态图标 -->
                    </div>
                    <span id="update-status-text" class="text-sm font-medium text-gray-700">准备中...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="update-progress-bar" class="bg-cyan-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- 更新日志 (折叠) -->
            <div id="update-release-notes" class="hidden mb-5">
                <button type="button" onclick="toggleReleaseNotes()" class="flex items-center text-sm text-gray-600 hover:text-gray-800 mb-2">
                    <svg id="release-notes-icon" class="w-4 h-4 mr-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    <span data-i18n="settings.update.release_notes">更新日志</span>
                </button>
                <div id="release-notes-content" class="hidden bg-gray-50 p-3 rounded-lg border border-gray-200 text-xs text-gray-600 max-h-40 overflow-y-auto whitespace-pre-wrap"></div>
            </div>

            <!-- 操作按钮 -->
            <div class="space-y-3">
                <button type="button" onclick="checkForUpdate()" id="btn-check-update" class="w-full font-bold py-2.5 rounded-lg transition shadow-md flex items-center justify-center" style="background-color: #0891b2; color: white;">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span data-i18n="settings.update.check_btn">检查更新</span>
                </button>
                <button type="button" onclick="performUpdate()" id="btn-perform-update" disabled class="w-full bg-gray-100 text-gray-400 font-bold py-2.5 rounded-lg transition flex items-center justify-center cursor-not-allowed">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span data-i18n="settings.update.download_btn">下载并安装</span>
                </button>
            </div>

            <p class="text-xs text-gray-400 mt-4" data-i18n="settings.update.hint">
                更新后需要手动重启服务才能生效。建议在更新前进行数据备份。
            </p>
        </div>

    </div>

    <script>
        Auth.check();

        // 缓存配置与域名映射
        let currentConfig = {};
        let domainMap = {};

        async function loadDomains() {
            try {
                const list = await request('/domains');
                const select = document.getElementById('domain-select');
                select.innerHTML = `<option value="">${I18n.t('settings.js.select_ph')}</option>`;
                
                list.forEach(d => {
                    domainMap[d.name] = d;
                    const opt = document.createElement('option');
                    opt.value = d.name;
                    opt.text = d.name;
                    select.appendChild(opt);
                });
                
                // 如果当前配置的域名在列表中，选中它
                if (currentConfig.domain && domainMap[currentConfig.domain]) {
                    select.value = currentConfig.domain;
                } else if (currentConfig.domain) {
                    // 如果不在列表中，切换到手动模式
                    document.getElementById('domain-input').value = currentConfig.domain;
                    toggleDomainInput(true);
                }
            } catch(e) {}
        }

        function onSelectChange() {
            const val = document.getElementById('domain-select').value;
            if (val && domainMap[val]) {
                document.getElementById('dkim_selector').value = domainMap[val].dkim_selector || 'default';
            }
        }

        function toggleDomainInput(showInput) {
            if (showInput) {
                document.getElementById('domain-select-mode').classList.add('hidden');
                document.getElementById('domain-input-mode').classList.remove('hidden');
                // 假如从下拉切换过来，把下拉的值赋给输入框
                const selVal = document.getElementById('domain-select').value;
                if(selVal) document.getElementById('domain-input').value = selVal;
            } else {
                document.getElementById('domain-select-mode').classList.remove('hidden');
                document.getElementById('domain-input-mode').classList.add('hidden');
            }
        }

        // 获取最终的域名值
        function getDomainValue() {
            if (!document.getElementById('domain-input-mode').classList.contains('hidden')) {
                return document.getElementById('domain-input').value;
            }
            return document.getElementById('domain-select').value;
        }

        function toggleSSL() {
            const enabled = document.getElementById('enable_ssl').checked;
            const div = document.getElementById('ssl-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        }

        function toggleReceiver() {
            const enabled = document.getElementById('enable_receiver').checked;
            const div = document.getElementById('receiver-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        }

        function toggleReceiverTLS() {
            const enabled = document.getElementById('receiver_tls').checked;
            const div = document.getElementById('receiver-tls-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
                // 关闭 TLS 时，自动取消强制 TLS
                document.getElementById('receiver_require_tls').checked = false;
            }
        }

        async function loadConfig() {
            try {
                const cfg = await request('/config'); // GET
                currentConfig = cfg;
                
                // 先加载域名列表，并根据 cfg 设置选中状态
                await loadDomains();

                // 基础配置
                // domain 已在 loadDomains 中处理
                document.getElementById('dkim_selector').value = cfg.dkim_selector || 'default';

                // Web配置
                document.getElementById('host').value = cfg.host || '0.0.0.0';
                document.getElementById('port').value = cfg.port || '9901';
                document.getElementById('base_url').value = cfg.base_url || ''; // 加载 BaseURL
                document.getElementById('enable_ssl').checked = cfg.enable_ssl || false;
                document.getElementById('cert_file').value = cfg.cert_file || '';
                document.getElementById('key_file').value = cfg.key_file || '';
                
                // 接收服务配置
                document.getElementById('enable_receiver').checked = cfg.enable_receiver || false;
                document.getElementById('receiver_port').value = cfg.receiver_port || '25';
                document.getElementById('receiver_tls').checked = cfg.receiver_tls || false;
                document.getElementById('receiver_tls_cert').value = cfg.receiver_tls_cert || '';
                document.getElementById('receiver_tls_key').value = cfg.receiver_tls_key || '';
                document.getElementById('receiver_rate_limit').value = cfg.receiver_rate_limit || 30;
                document.getElementById('receiver_max_msg_size').value = cfg.receiver_max_msg_size || 10240;
                document.getElementById('receiver_blacklist').value = cfg.receiver_blacklist || '';
                document.getElementById('receiver_require_tls').checked = cfg.receiver_require_tls || false;
                
                toggleSSL();
                toggleReceiver();
                toggleReceiverTLS();
            } catch (e) {}
        }

        async function saveConfig(e, type) {
            e.preventDefault();
            
            // 定义敏感字段列表 (这些字段后端返回掩码值，不应回传)
            const sensitiveFields = ['jwt_secret', 'dkim_private_key'];
            
            // 从 currentConfig 中排除敏感字段后合并
            const safeCurrentConfig = Object.fromEntries(
                Object.entries(currentConfig).filter(([key]) => !sensitiveFields.includes(key))
            );
            
            // 合并配置 (排除敏感字段后的基础配置 + 表单输入值)
            const newConfig = {
                ...safeCurrentConfig,
                domain: getDomainValue(),
                dkim_selector: document.getElementById('dkim_selector').value,
                host: document.getElementById('host').value,
                port: document.getElementById('port').value,
                base_url: document.getElementById('base_url').value,
                enable_ssl: document.getElementById('enable_ssl').checked,
                cert_file: document.getElementById('cert_file').value,
                key_file: document.getElementById('key_file').value,
                enable_receiver: document.getElementById('enable_receiver').checked,
                receiver_port: document.getElementById('receiver_port').value,
                receiver_tls: document.getElementById('receiver_tls').checked,
                receiver_tls_cert: document.getElementById('receiver_tls_cert').value,
                receiver_tls_key: document.getElementById('receiver_tls_key').value,
                receiver_rate_limit: parseInt(document.getElementById('receiver_rate_limit').value) || 30,
                receiver_max_msg_size: parseInt(document.getElementById('receiver_max_msg_size').value) || 10240,
                receiver_blacklist: document.getElementById('receiver_blacklist').value,
                receiver_require_tls: document.getElementById('receiver_require_tls').checked
            };
            
            // 二次安全检查：确保没有敏感字段的掩码值被发送
            // (防御性编程，防止未来代码变更引入问题)
            sensitiveFields.forEach(field => {
                if (newConfig[field] && (
                    String(newConfig[field]).includes('***') || 
                    String(newConfig[field]).includes('Hidden')
                )) {
                    delete newConfig[field];
                }
            });

            try {
                await request('/config', { method: 'POST', body: JSON.stringify(newConfig) });
                
                // 根据类型显示不同的提示
                if (type === 'business') {
                    showToast(I18n.t('settings.toast.biz_updated'));
                } else if (type === 'web') {
                    showToast(I18n.t('settings.toast.web_updated'), 'info');
                } else if (type === 'receiver') {
                    showToast(I18n.t('settings.toast.recv_updated'), 'info');
                } else {
                    showToast(I18n.t('settings.toast.saved'));
                }
            } catch (e) {
                // request 已经处理了 error toast
                if (e.data && e.data.pid) {
                    setTimeout(async () => {
                        if (confirm(e.message + "\n\n" + I18n.t('settings.alert.kill_confirm'))) {
                            await killProcess(e.data.pid);
                        }
                    }, 500);
                }
            }
        }

        async function resetSecret() {
            if (!confirm(I18n.t('settings.alert.jwt_confirm'))) return;
            
            // 复用保存逻辑，但设置特殊标记
            const newConfig = { ...currentConfig, jwt_secret: 'RESET' };
            try {
                await request('/config', { method: 'POST', body: JSON.stringify(newConfig) });
                showToast(I18n.t('settings.toast.jwt_reset'));
                setTimeout(() => Auth.logout(), 2000);
            } catch (e) {}
        }

        async function downloadBackup() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch('/api/v1/backup', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "goemail-backup.zip";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    showToast(I18n.t('settings.toast.backup_start'));
                } else {
                    showToast(I18n.t('settings.toast.backup_fail'), 'error');
                }
            } catch(e) {
                showToast(I18n.t('settings.toast.net_fail'), 'error');
            }
        }

        async function changePassword(e) {
            e.preventDefault();
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;

            try {
                await request('/password', { 
                    method: 'POST', 
                    body: JSON.stringify({ old_password: oldPass, new_password: newPass }) 
                });
                showToast(I18n.t('settings.toast.pwd_changed'));
                setTimeout(() => Auth.logout(), 1500);
            } catch (e) {}
        }

        async function testPort() {
            const port = document.getElementById('receiver_port').value;
            if (!port) return;
            
            const btn = event.target;
            const originalText = btn.innerText;
            
            try {
                btn.innerText = 'Testing...';
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');

                const res = await request('/config/test-port', {
                    method: 'POST',
                    body: JSON.stringify({ port: port })
                });
                
                if (res.success) {
                    showToast(res.message, 'success');
                } else {
                    showToast(res.message, 'error');
                    // 如果返回了 PID，询问是否关闭
                    if (res.pid) {
                        if (confirm(res.message + "\n\n" + I18n.t('settings.alert.kill_confirm'))) {
                            await killProcess(res.pid);
                        }
                    }
                }
            } catch (e) {
                // request handles error toast
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function killProcess(pid) {
            try {
                const res = await request('/config/kill-process', {
                    method: 'POST',
                    body: JSON.stringify({ pid: pid })
                });
                showToast(res.message, 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        loadConfig();
        loadCleanupData();
        loadTOTPStatus();

        // --- 两步验证 (TOTP) 相关函数 ---
        async function loadTOTPStatus() {
            try {
                const res = await request('/totp/status');
                if (res.enabled) {
                    document.getElementById('totp-disabled-section').classList.add('hidden');
                    document.getElementById('totp-enabled-section').classList.remove('hidden');
                } else {
                    document.getElementById('totp-disabled-section').classList.remove('hidden');
                    document.getElementById('totp-enabled-section').classList.add('hidden');
                }
            } catch (e) {
                console.error('加载 TOTP 状态失败:', e);
            }
        }

        async function setupTOTP() {
            try {
                const res = await request('/totp/setup');
                document.getElementById('totp-qrcode').src = res.qr_code;
                document.getElementById('totp-secret').textContent = res.secret;
                document.getElementById('totp-disabled-section').classList.add('hidden');
                document.getElementById('totp-setup-section').classList.remove('hidden');
                document.getElementById('totp-verify-code').value = '';
                document.getElementById('totp-verify-code').focus();
            } catch (e) {
                showToast(e.message || '获取二维码失败', 'error');
            }
        }

        function cancelTOTPSetup() {
            document.getElementById('totp-setup-section').classList.add('hidden');
            document.getElementById('totp-disabled-section').classList.remove('hidden');
        }

        function copyTOTPSecret() {
            const secret = document.getElementById('totp-secret').textContent;
            navigator.clipboard.writeText(secret).then(() => {
                showToast(I18n.t('settings.toast.copied') || '已复制到剪贴板');
            });
        }

        async function enableTOTP() {
            const code = document.getElementById('totp-verify-code').value.trim();
            if (!code || code.length !== 6) {
                showToast(I18n.t('settings.sec.totp_invalid_code') || '请输入 6 位验证码', 'error');
                return;
            }

            try {
                await request('/totp/enable', {
                    method: 'POST',
                    body: JSON.stringify({ code: code })
                });
                showToast(I18n.t('settings.toast.totp_enabled') || '两步验证已启用');
                document.getElementById('totp-setup-section').classList.add('hidden');
                document.getElementById('totp-enabled-section').classList.remove('hidden');
            } catch (e) {
                showToast(e.message || '验证码错误', 'error');
                document.getElementById('totp-verify-code').value = '';
                document.getElementById('totp-verify-code').focus();
            }
        }

        function showDisableTOTPModal() {
            const pwd = prompt(I18n.t('settings.sec.totp_disable_prompt') || '请输入密码以关闭两步验证：');
            if (pwd) {
                disableTOTP(pwd);
            }
        }

        async function disableTOTP(password) {
            try {
                await request('/totp/disable', {
                    method: 'POST',
                    body: JSON.stringify({ password: password })
                });
                showToast(I18n.t('settings.toast.totp_disabled') || '两步验证已关闭');
                document.getElementById('totp-enabled-section').classList.add('hidden');
                document.getElementById('totp-disabled-section').classList.remove('hidden');
            } catch (e) {
                showToast(e.message || '密码错误', 'error');
            }
        }

        // --- 数据清理相关函数 ---
        async function loadCleanupData() {
            try {
                // 并行加载统计和配置
                const [stats, cfg] = await Promise.all([
                    request('/cleanup/stats'),
                    request('/cleanup/config')
                ]);

                // 更新统计显示
                document.getElementById('stat-email-logs').textContent = stats.email_logs.toLocaleString();
                document.getElementById('stat-inbox').textContent = stats.inbox_items.toLocaleString();
                document.getElementById('stat-queue').textContent = stats.queue_items.toLocaleString();
                document.getElementById('stat-forward').textContent = stats.forward_logs.toLocaleString();
                document.getElementById('stat-attach').textContent = stats.attachments.toLocaleString();
                document.getElementById('stat-size').textContent = formatSize(stats.total_size);

                // 填充配置表单
                document.getElementById('cleanup_enabled').checked = cfg.cleanup_enabled || false;
                document.getElementById('cleanup_email_log_days').value = cfg.cleanup_email_log_days || 30;
                document.getElementById('cleanup_inbox_days').value = cfg.cleanup_inbox_days || 30;
                document.getElementById('cleanup_queue_days').value = cfg.cleanup_queue_days || 7;
                document.getElementById('cleanup_forward_days').value = cfg.cleanup_forward_days || 30;
                document.getElementById('cleanup_attach_days').value = cfg.cleanup_attach_days || 30;
            } catch (e) {
                console.error('加载清理数据失败:', e);
            }
        }

        async function saveCleanupConfig(e) {
            e.preventDefault();
            
            const cfg = {
                cleanup_enabled: document.getElementById('cleanup_enabled').checked,
                cleanup_email_log_days: parseInt(document.getElementById('cleanup_email_log_days').value) || 30,
                cleanup_inbox_days: parseInt(document.getElementById('cleanup_inbox_days').value) || 30,
                cleanup_queue_days: parseInt(document.getElementById('cleanup_queue_days').value) || 7,
                cleanup_forward_days: parseInt(document.getElementById('cleanup_forward_days').value) || 30,
                cleanup_attach_days: parseInt(document.getElementById('cleanup_attach_days').value) || 30
            };

            try {
                await request('/cleanup/config', { method: 'PUT', body: JSON.stringify(cfg) });
                showToast(I18n.t('settings.toast.cleanup_saved') || '清理配置已保存');
            } catch (e) {
                // request 已处理错误
            }
        }

        async function runCleanup() {
            const confirmMsg = I18n.t('settings.alert.cleanup_confirm') || '确定要立即执行数据清理吗？这将删除超过保留期限的历史数据。';
            if (!confirm(confirmMsg)) return;

            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${I18n.t('settings.cleanup.running') || '清理中...'}</span>`;

                const res = await request('/cleanup/run', { method: 'POST' });

                // 显示清理结果
                const msg = `${I18n.t('settings.toast.cleanup_done') || '清理完成'}\n` +
                    `- ${I18n.t('settings.cleanup.email_logs') || '发送日志'}: ${res.email_logs}\n` +
                    `- ${I18n.t('settings.cleanup.inbox') || '收件箱'}: ${res.inbox_items}\n` +
                    `- ${I18n.t('settings.cleanup.queue') || '队列记录'}: ${res.queue_items}\n` +
                    `- ${I18n.t('settings.cleanup.forward') || '转发日志'}: ${res.forward_logs}\n` +
                    `- ${I18n.t('settings.cleanup.attach') || '附件文件'}: ${res.attachments}\n` +
                    `- ${I18n.t('settings.cleanup.freed') || '释放空间'}: ${formatSize(res.freed_bytes)}\n` +
                    `- ${I18n.t('settings.cleanup.duration') || '耗时'}: ${res.duration_ms}ms`;

                showToast(I18n.t('settings.toast.cleanup_done') || '清理完成', 'success');
                alert(msg);

                // 重新加载统计
                loadCleanupData();
            } catch (e) {
                // request 已处理错误
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- 系统更新相关函数 ---
        let updateInfo = null;
        let updatePolling = null;

        async function loadUpdateInfo() {
            try {
                const ver = await request('/config/version');
                document.getElementById('update-current-ver').textContent = ver.version || '-';
            } catch (e) {
                console.error('加载版本信息失败:', e);
            }
        }

        async function checkForUpdate() {
            const btn = document.getElementById('btn-check-update');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${I18n.t('settings.update.checking') || '检查中...'}</span>`;

                updateInfo = await request('/config/update-info');

                // 更新显示
                document.getElementById('update-current-ver').textContent = updateInfo.current_version || '-';
                document.getElementById('update-latest-ver').textContent = updateInfo.latest_version || '-';
                document.getElementById('update-platform').textContent = updateInfo.platform || '-';

                const latestEl = document.getElementById('update-latest-ver');
                const updateBtn = document.getElementById('btn-perform-update');

                if (updateInfo.has_update) {
                    latestEl.classList.remove('text-gray-700');
                    latestEl.classList.add('text-green-600');
                    
                    // 启用更新按钮
                    updateBtn.disabled = false;
                    updateBtn.classList.remove('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                    updateBtn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');

                    // 显示更新日志
                    if (updateInfo.release_notes) {
                        document.getElementById('update-release-notes').classList.remove('hidden');
                        document.getElementById('release-notes-content').textContent = updateInfo.release_notes;
                    }

                    showToast(I18n.t('settings.toast.update_available') || `发现新版本: ${updateInfo.latest_version}`, 'success');
                } else {
                    latestEl.classList.remove('text-green-600');
                    latestEl.classList.add('text-gray-700');
                    updateBtn.disabled = true;
                    updateBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700');
                    updateBtn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                    document.getElementById('update-release-notes').classList.add('hidden');

                    showToast(I18n.t('settings.toast.already_latest') || '已是最新版本');
                }

            } catch (e) {
                showToast(I18n.t('settings.toast.check_failed') || '检查更新失败', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function toggleReleaseNotes() {
            const content = document.getElementById('release-notes-content');
            const icon = document.getElementById('release-notes-icon');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-90');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-90');
            }
        }

        async function performUpdate() {
            if (!updateInfo || !updateInfo.download_url) {
                showToast(I18n.t('settings.toast.no_update_info') || '请先检查更新', 'error');
                return;
            }

            const confirmMsg = I18n.t('settings.alert.update_confirm') || 
                `确定要更新到 ${updateInfo.latest_version} 吗？\n\n更新完成后需要手动重启服务。\n建议先进行数据备份。`;
            if (!confirm(confirmMsg)) return;

            const checkBtn = document.getElementById('btn-check-update');
            const updateBtn = document.getElementById('btn-perform-update');

            try {
                checkBtn.disabled = true;
                updateBtn.disabled = true;
                updateBtn.innerHTML = `<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${I18n.t('settings.update.updating') || '更新中...'}</span>`;

                // 显示状态框
                document.getElementById('update-status-box').classList.remove('hidden');

                // 发起更新请求
                await request('/config/update', {
                    method: 'POST',
                    body: JSON.stringify({
                        download_url: updateInfo.download_url,
                        file_name: updateInfo.file_name
                    })
                });

                // 开始轮询状态
                startUpdatePolling();

            } catch (e) {
                showToast(I18n.t('settings.toast.update_failed') || '更新失败', 'error');
                checkBtn.disabled = false;
                resetUpdateButton();
            }
        }

        function startUpdatePolling() {
            if (updatePolling) clearInterval(updatePolling);
            
            updatePolling = setInterval(async () => {
                try {
                    const status = await request('/config/update-status');
                    updateStatusUI(status);

                    if (status.status === 'completed' || status.status === 'failed') {
                        clearInterval(updatePolling);
                        updatePolling = null;
                        document.getElementById('btn-check-update').disabled = false;

                        if (status.status === 'completed') {
                            showToast(I18n.t('settings.toast.update_success') || '更新成功！请重启服务。', 'success');
                            alert(I18n.t('settings.alert.restart_required') || '更新已完成！\n\n请手动重启服务以应用新版本：\n\n1. 停止当前服务\n2. 启动新版本程序\n\nLinux: systemctl restart goemail 或 ./goemail\nWindows: 重新运行 goemail.exe');
                        } else if (status.status === 'failed') {
                            showToast(status.error || I18n.t('settings.toast.update_failed') || '更新失败', 'error');
                        }
                        resetUpdateButton();
                    }
                } catch (e) {
                    console.error('获取更新状态失败:', e);
                }
            }, 1000);
        }

        function updateStatusUI(status) {
            const statusText = document.getElementById('update-status-text');
            const progressBar = document.getElementById('update-progress-bar');
            const statusIcon = document.getElementById('update-status-icon');

            statusText.textContent = status.message || '处理中...';
            progressBar.style.width = `${status.progress}%`;

            // 更新图标
            if (status.status === 'completed') {
                statusIcon.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                progressBar.classList.remove('bg-cyan-600');
                progressBar.classList.add('bg-green-500');
            } else if (status.status === 'failed') {
                statusIcon.innerHTML = `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                progressBar.classList.remove('bg-cyan-600');
                progressBar.classList.add('bg-red-500');
            } else {
                statusIcon.innerHTML = `<svg class="w-5 h-5 text-cyan-500 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            }
        }

        function resetUpdateButton() {
            const btn = document.getElementById('btn-perform-update');
            btn.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span>${I18n.t('settings.update.download_btn') || '下载并安装'}</span>`;
            
            if (updateInfo && updateInfo.has_update) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
            } else {
                btn.disabled = true;
                btn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700');
                btn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
            }
        }

        // 页面加载时获取当前版本
        loadUpdateInfo();
    </script>
</body>
</html>
