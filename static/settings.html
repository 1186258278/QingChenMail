<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»Ÿè®¾ç½® - æ™´è¾°äº‘é‚®</title>
    <link href="/dashboard/css/tailwind.min.css?v=8.0" rel="stylesheet">
    <script src="/dashboard/js/loader.js?v=8.0"></script>
    <script src="/dashboard/js/common.js?v=8.0"></script>
    <script src="/dashboard/js/layout.js?v=8.0"></script>
</head>
<body class="hidden" data-i18n-module="settings">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800" data-i18n="settings.title">ç³»ç»Ÿè®¾ç½®</h2>
        <p class="text-gray-500 mt-1" data-i18n="settings.subtitle">é…ç½®æœåŠ¡å™¨è¿è¡Œå‚æ•°ä¸å®‰å…¨é€‰é¡¹</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <!-- åŸºç¡€ä¸šåŠ¡é…ç½® -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:col-span-2">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-purple-100 text-purple-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </span>
                <span data-i18n="settings.biz.title">åŸºç¡€ä¸šåŠ¡é…ç½®</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.biz.domain_label">é»˜è®¤å‘ä¿¡åŸŸå (Domain)</label>
                    <!-- ä¸‹æ‹‰é€‰æ‹©æ¨¡å¼ -->
                    <div id="domain-select-mode" class="relative">
                        <select id="domain-select" onchange="onSelectChange()" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500 appearance-none bg-white">
                            <option value="" data-i18n="common.loading">åŠ è½½ä¸­...</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <button type="button" onclick="toggleDomainInput(true)" class="absolute right-8 top-0 bottom-0 px-2 text-xs text-blue-600 hover:text-blue-800 bg-transparent" data-i18n="settings.biz.manual_input">æ‰‹åŠ¨è¾“å…¥</button>
                    </div>
                    <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
                    <div id="domain-input-mode" class="relative hidden">
                        <input type="text" id="domain-input" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500" placeholder="example.com">
                        <button type="button" onclick="toggleDomainInput(false)" class="absolute right-2 top-2 text-xs text-blue-600 hover:text-blue-800" data-i18n="settings.biz.select_list">é€‰æ‹©åˆ—è¡¨</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.biz.domain_hint">å½“æœªæŒ‡å®šå‘ä»¶äººæ—¶ï¼Œå°†ä½¿ç”¨ noreply@æ­¤åŸŸå</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.biz.dkim_label">DKIM Selector</label>
                    <input type="text" id="dkim_selector" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500" placeholder="default">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.biz.dkim_hint">DKIM ç­¾åçš„é€‰æ‹©å™¨ï¼Œé€šå¸¸ä¿æŒé»˜è®¤</p>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                <button type="button" onclick="saveConfig(event, 'business')" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition shadow-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    <span data-i18n="settings.biz.save_btn">ä¿å­˜ä¸šåŠ¡é…ç½®</span>
                </button>
            </div>
        </div>
        
        <!-- Web æœåŠ¡é…ç½® -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </span>
                <span data-i18n="settings.web.title">Web æœåŠ¡é…ç½®</span>
            </h3>
            
            <form onsubmit="saveConfig(event, 'web')" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.host_label">ç›‘å¬åœ°å€ (Host)</label>
                        <div class="relative">
                            <input type="text" id="host" list="host-list" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.0.0.0">
                            <datalist id="host-list">
                                <option value="0.0.0.0" data-i18n="settings.web.host_public">0.0.0.0 (å…è®¸å…¬ç½‘è®¿é—®)</option>
                                <option value="127.0.0.1" data-i18n="settings.web.host_local">127.0.0.1 (ä»…æœ¬æœº/åå‘ä»£ç†)</option>
                            </datalist>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" data-i18n="settings.web.host_hint">æ”¯æŒä¸‹æ‹‰é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.port_label">ç›‘å¬ç«¯å£ (Port)</label>
                        <input type="text" id="port" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="9901">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.base_url">å…¬ç½‘è®¿é—®åœ°å€ (BaseURL)</label>
                    <input type="text" id="base_url" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://mail.example.com:9901">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.web.base_url_hint">ç”¨äºç”Ÿæˆé‚®ä»¶ä¸­çš„è¿½è¸ªé“¾æ¥å’Œé€€è®¢é“¾æ¥ï¼Œè¯·åŠ¡å¿…å¡«å†™å¤–éƒ¨å¯è®¿é—®çš„å®Œæ•´ URL</p>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <div class="mb-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="enable_ssl" class="form-checkbox h-5 w-5 text-blue-600 rounded transition" onchange="toggleSSL()">
                            <span class="ml-2 font-medium text-gray-700" data-i18n="settings.web.ssl_enable">å¯ç”¨ HTTPS (SSL)</span>
                        </label>
                        <p class="text-xs text-yellow-600 mt-1 ml-7" data-i18n="settings.web.ssl_hint">
                            âš ï¸ æç¤ºï¼šå¦‚æœæ‚¨ä½¿ç”¨ Nginx/Apache åå‘ä»£ç†ï¼Œè¯·å‹¿å¼€å¯æ­¤é¡¹ï¼Œç›´æ¥é…ç½® Nginx å³å¯ã€‚
                        </p>
                    </div>

                    <div id="ssl-config" class="space-y-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.cert_label">è¯ä¹¦æ–‡ä»¶è·¯å¾„ (.crt/.pem)</label>
                            <input type="text" id="cert_file" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="./cert.pem">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.key_label">ç§é’¥æ–‡ä»¶è·¯å¾„ (.key)</label>
                            <input type="text" id="key_file" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="./key.pem">
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition shadow-md">
                        <span data-i18n="settings.web.save_btn">ä¿å­˜ Web é…ç½®</span>
                    </button>
                    <p class="text-xs text-center text-red-500 mt-2" data-i18n="settings.web.restart_hint">æ³¨æ„ï¼šä¿®æ”¹ç›‘å¬é…ç½®åï¼Œéœ€è¦æ‰‹åŠ¨é‡å¯ç¨‹åºæ‰èƒ½ç”Ÿæ•ˆï¼</p>
                </div>
            </form>
        </div>

        <!-- é‚®ä»¶æ¥æ”¶æœåŠ¡é…ç½® -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </span>
                <span data-i18n="settings.recv.title">é‚®ä»¶æ¥æ”¶æœåŠ¡ (è½¬å‘)</span>
            </h3>
            
            <form onsubmit="saveConfig(event, 'receiver')" class="space-y-5">
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="enable_receiver" class="form-checkbox h-5 w-5 text-indigo-600 rounded transition" onchange="toggleReceiver()">
                        <span class="ml-2 font-medium text-gray-700" data-i18n="settings.recv.enable">å¯ç”¨ SMTP æ¥æ”¶æœåŠ¡</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-7" data-i18n="settings.recv.desc">
                        å¯ç”¨åå¯æ¥æ”¶å‘å¾€åŸŸåé‚®ç®±çš„é‚®ä»¶ï¼Œå¹¶æ ¹æ®è½¬å‘è§„åˆ™è½¬å‘åˆ°æŒ‡å®šé‚®ç®±ã€‚
                    </p>
                </div>

                <div id="receiver-config" class="space-y-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 text-sm p-3 rounded-lg">
                        <p class="font-medium mb-1" data-i18n="settings.recv.req_title">âš ï¸ ä½¿ç”¨å‰æ</p>
                        <ul class="list-disc list-inside text-xs space-y-1">
                            <li data-i18n="settings.recv.req_1">éœ€è¦åœ¨åŸŸå DNS æ·»åŠ  MX è®°å½•æŒ‡å‘æœ¬æœåŠ¡å™¨ IP</li>
                            <li data-i18n="settings.recv.req_2">ç«¯å£ 25 éœ€è¦æœåŠ¡å™¨é˜²ç«å¢™æ”¾è¡Œï¼ˆéƒ¨åˆ†äº‘æœåŠ¡å•†é»˜è®¤å°ç¦ï¼‰</li>
                            <li data-i18n="settings.recv.req_3">Linux ä¸‹ç›‘å¬ 25 ç«¯å£éœ€è¦ root æƒé™æˆ–ä½¿ç”¨ <code class="bg-yellow-100 px-1 rounded">setcap</code></li>
                        </ul>
                    </div>
                    
                    <!-- ç«¯å£è¢«å ç”¨è§£å†³æ–¹æ¡ˆ -->
                    <details class="bg-blue-50 border border-blue-200 text-blue-700 text-sm rounded-lg">
                        <summary class="p-3 cursor-pointer font-medium hover:bg-blue-100 rounded-lg transition" data-i18n="settings.recv.port_conflict_title">ğŸ’¡ ç«¯å£ 25 è¢«å ç”¨ï¼ŸæŸ¥çœ‹è§£å†³æ–¹æ¡ˆ</summary>
                        <div class="px-3 pb-3 text-xs space-y-3">
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_1_title">æ–¹æ¡ˆ 1: ç«¯å£è½¬å‘ (æ¨è)</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_1_desc">ç¨‹åºç›‘å¬ 2525ï¼Œç”¨ iptables è½¬å‘ 25â†’2525ï¼š</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto">sudo iptables -t nat -A PREROUTING -p tcp --dport 25 -j REDIRECT --to-port 2525</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_2_title">æ–¹æ¡ˆ 2: Nginx TCP ä»£ç†</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_2_desc">ä½¿ç”¨ Nginx stream æ¨¡å—ä»£ç†ï¼š</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto whitespace-pre">stream {
    server {
        listen 25;
        proxy_pass 127.0.0.1:2525;
    }
}</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_3_title">æ–¹æ¡ˆ 3: åœç”¨åŸæœ‰ MTA</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_3_desc">åœæ­¢ Postfix/Sendmail ç­‰ï¼š</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto">sudo systemctl stop postfix && sudo systemctl disable postfix</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_4_title">æ–¹æ¡ˆ 4: ä¸ Postfix é›†æˆ</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_4_desc">é…ç½® Postfix å°†é‚®ä»¶è½¬å‘åˆ°æœ¬ç¨‹åºï¼Œè¯¦è§æ–‡æ¡£ã€‚</p>
                            </div>
                        </div>
                    </details>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.port_label">ç›‘å¬ç«¯å£</label>
                            <div class="flex space-x-2">
                                <input type="text" id="receiver_port" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="25">
                                <button type="button" onclick="testPort()" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm font-medium whitespace-nowrap" data-i18n="settings.recv.test_btn">æ£€æµ‹</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.rate_limit">é€Ÿç‡é™åˆ¶ (è¿æ¥/åˆ†é’Ÿ)</label>
                            <input type="number" id="receiver_rate_limit" min="0" max="1000" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="30">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.max_size">æœ€å¤§é‚®ä»¶å¤§å° (KB)</label>
                            <input type="number" id="receiver_max_msg_size" min="100" max="102400" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="10240">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.blacklist">IP é»‘åå•</label>
                            <input type="text" id="receiver_blacklist" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="1.2.3.4, 5.6.7.8">
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="receiver_tls" class="form-checkbox h-4 w-4 text-indigo-600 rounded transition" onchange="toggleReceiverTLS()">
                            <span class="ml-2 text-sm text-gray-700" data-i18n="settings.recv.tls_enable">å¯ç”¨ STARTTLS (åŠ å¯†ä¼ è¾“)</span>
                        </label>
                        
                        <!-- TLS è¯ä¹¦é…ç½® -->
                        <div id="receiver-tls-config" class="hidden ml-6 p-3 bg-white border border-indigo-200 rounded-lg space-y-3">
                            <div class="bg-red-50 border border-red-200 text-red-700 text-xs p-2 rounded">
                                <strong data-i18n="settings.recv.tls_warning_title">âš ï¸ é‡è¦ï¼š</strong>
                                <span data-i18n="settings.recv.tls_warning">å¿…é¡»é…ç½®æœ‰æ•ˆçš„ SSL è¯ä¹¦ï¼Œå¦åˆ™ STARTTLS å°†æ— æ³•å·¥ä½œï¼å¯ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ã€‚</span>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1" data-i18n="settings.recv.tls_cert">è¯ä¹¦æ–‡ä»¶ (.pem/.crt)</label>
                                <input type="text" id="receiver_tls_cert" class="w-full border rounded px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="/etc/letsencrypt/live/mail.example.com/fullchain.pem">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1" data-i18n="settings.recv.tls_key">ç§é’¥æ–‡ä»¶ (.key)</label>
                                <input type="text" id="receiver_tls_key" class="w-full border rounded px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="/etc/letsencrypt/live/mail.example.com/privkey.pem">
                            </div>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="receiver_require_tls" class="form-checkbox h-4 w-4 text-indigo-600 rounded transition">
                                <span class="ml-2 text-sm text-gray-700" data-i18n="settings.recv.require_tls">å¼ºåˆ¶ TLS (æ‹’ç»æ˜æ–‡è¿æ¥)</span>
                            </label>
                            <p class="text-xs text-red-500" data-i18n="settings.recv.require_tls_warning">âš ï¸ å‹¾é€‰åï¼Œæœªé…ç½® STARTTLS çš„å‘ä»¶æ–¹å°†æ— æ³•ç»™ä½ å‘é‚®ä»¶ï¼å»ºè®®å…ˆæµ‹è¯•åå†å¼€å¯ã€‚</p>
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2.5 rounded-lg hover:bg-indigo-700 transition shadow-md">
                        <span data-i18n="settings.recv.save_btn">ä¿å­˜æ¥æ”¶æœåŠ¡é…ç½®</span>
                    </button>
                    <p class="text-xs text-center text-red-500 mt-2" data-i18n="settings.recv.restart_hint">æ³¨æ„ï¼šä¿®æ”¹æ¥æ”¶æœåŠ¡é…ç½®åï¼Œéœ€è¦æ‰‹åŠ¨é‡å¯ç¨‹åºæ‰èƒ½ç”Ÿæ•ˆï¼</p>
                </div>
            </form>
        </div>

        <!-- æ•°æ®æ¸…ç† -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-orange-100 text-orange-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </span>
                <span data-i18n="settings.cleanup.title">æ•°æ®æ¸…ç†</span>
            </h3>
            
            <form onsubmit="saveCleanupConfig(event)" class="space-y-5">
                <!-- æ•°æ®ç»Ÿè®¡ -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-3" data-i18n="settings.cleanup.stats_title">å½“å‰æ•°æ®é‡</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm" id="cleanup-stats">
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.email_logs">å‘é€æ—¥å¿—:</span> <span id="stat-email-logs" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.inbox">æ”¶ä»¶ç®±:</span> <span id="stat-inbox" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.queue">é˜Ÿåˆ—è®°å½•:</span> <span id="stat-queue" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.forward">è½¬å‘æ—¥å¿—:</span> <span id="stat-forward" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.attach">é™„ä»¶æ–‡ä»¶:</span> <span id="stat-attach" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.attach_size">é™„ä»¶å¤§å°:</span> <span id="stat-size" class="font-medium">-</span></div>
                    </div>
                </div>

                <!-- è‡ªåŠ¨æ¸…ç†å¼€å…³ -->
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="cleanup_enabled" class="form-checkbox h-5 w-5 text-orange-600 rounded transition">
                        <span class="ml-2 font-medium text-gray-700" data-i18n="settings.cleanup.auto_enable">å¯ç”¨è‡ªåŠ¨æ¸…ç†</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-7" data-i18n="settings.cleanup.auto_desc">
                        å¯ç”¨åï¼Œç³»ç»Ÿå°†åœ¨æ¯å¤©å‡Œæ™¨ 3:00 è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ã€‚
                    </p>
                </div>

                <!-- ä¿ç•™å¤©æ•°é…ç½® -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.email_log_days">å‘é€æ—¥å¿—ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_email_log_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.inbox_days">æ”¶ä»¶ç®±ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_inbox_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.queue_days">é˜Ÿåˆ—è®°å½•ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_queue_days" min="1" max="90" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="7">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.forward_days">è½¬å‘æ—¥å¿—ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_forward_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.attach_days">é™„ä»¶ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_attach_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                </div>

                <div class="pt-4 space-y-3">
                    <button type="submit" class="w-full bg-orange-600 text-white font-bold py-2.5 rounded-lg hover:bg-orange-700 transition shadow-md">
                        <span data-i18n="settings.cleanup.save_btn">ä¿å­˜æ¸…ç†é…ç½®</span>
                    </button>
                    <button type="button" onclick="runCleanup()" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-2.5 rounded-lg hover:bg-red-100 transition flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span data-i18n="settings.cleanup.run_btn">ç«‹å³æ¸…ç†</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- å¯†ç ä¸å®‰å…¨ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col justify-between">
            <div>
                <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                    <span class="bg-green-100 text-green-600 p-1.5 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </span>
                    <span data-i18n="settings.sec.title">å®‰å…¨è®¾ç½®</span>
                </h3>

                <div class="mb-8">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.backup_title">æ•°æ®å¤‡ä»½</h4>
                    <p class="text-xs text-gray-500 mb-3" data-i18n="settings.sec.backup_desc">å°† config.json å’Œæ•°æ®åº“æ–‡ä»¶æ‰“åŒ…ä¸‹è½½ï¼Œå»ºè®®å®šæœŸå¤‡ä»½ã€‚</p>
                    <button onclick="downloadBackup()" class="w-full bg-blue-50 text-blue-600 border border-blue-200 font-bold py-2 rounded-lg hover:bg-blue-100 transition text-sm flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span data-i18n="settings.sec.backup_btn">ä¸‹è½½å®Œæ•´å¤‡ä»½</span>
                    </button>
                </div>
                
                <form onsubmit="changePassword(event)" class="space-y-4 mb-8">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.pwd_title">ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h4>
                    <div>
                        <input type="password" id="old-pass" required data-i18n-attr="placeholder:settings.sec.old_pwd_ph" placeholder="å½“å‰å¯†ç " class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <div>
                        <input type="password" id="new-pass" required data-i18n-attr="placeholder:settings.sec.new_pwd_ph" placeholder="æ–°å¯†ç " class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <div class="pt-1">
                        <button type="submit" class="w-full bg-green-50 text-green-700 border border-green-200 font-bold py-2 rounded-lg hover:bg-green-100 transition text-sm">
                            <span data-i18n="settings.sec.pwd_btn">æ›´æ–°å¯†ç </span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3" data-i18n="settings.sec.jwt_title">ç™»å½•å¯†é’¥ (JWT Secret)</h4>
                <p class="text-xs text-gray-500 mb-4 leading-relaxed" data-i18n="settings.sec.jwt_desc">
                    é‡ç½®å¯†é’¥å°†å¯¼è‡´æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·ï¼ˆåŒ…æ‹¬API Tokenï¼‰ç«‹å³å¤±æ•ˆï¼Œéœ€é‡æ–°ç™»å½•ã€‚ä»…åœ¨æ€€ç–‘å¯†é’¥æ³„éœ²æ—¶ä½¿ç”¨ã€‚
                </p>
                <button type="button" onclick="resetSecret()" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-2 rounded-lg hover:bg-red-100 transition text-sm flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <span data-i18n="settings.sec.jwt_btn">é‡ç½®å¹¶å¼ºåˆ¶ä¸‹çº¿</span>
                </button>
            </div>
        </div>

    </div>

    <script>
        Auth.check();

        // ç¼“å­˜é…ç½®ä¸åŸŸåæ˜ å°„
        let currentConfig = {};
        let domainMap = {};

        async function loadDomains() {
            try {
                const list = await request('/domains');
                const select = document.getElementById('domain-select');
                select.innerHTML = `<option value="">${I18n.t('settings.js.select_ph')}</option>`;
                
                list.forEach(d => {
                    domainMap[d.name] = d;
                    const opt = document.createElement('option');
                    opt.value = d.name;
                    opt.text = d.name;
                    select.appendChild(opt);
                });
                
                // å¦‚æœå½“å‰é…ç½®çš„åŸŸååœ¨åˆ—è¡¨ä¸­ï¼Œé€‰ä¸­å®ƒ
                if (currentConfig.domain && domainMap[currentConfig.domain]) {
                    select.value = currentConfig.domain;
                } else if (currentConfig.domain) {
                    // å¦‚æœä¸åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼
                    document.getElementById('domain-input').value = currentConfig.domain;
                    toggleDomainInput(true);
                }
            } catch(e) {}
        }

        function onSelectChange() {
            const val = document.getElementById('domain-select').value;
            if (val && domainMap[val]) {
                document.getElementById('dkim_selector').value = domainMap[val].dkim_selector || 'default';
            }
        }

        function toggleDomainInput(showInput) {
            if (showInput) {
                document.getElementById('domain-select-mode').classList.add('hidden');
                document.getElementById('domain-input-mode').classList.remove('hidden');
                // å‡å¦‚ä»ä¸‹æ‹‰åˆ‡æ¢è¿‡æ¥ï¼ŒæŠŠä¸‹æ‹‰çš„å€¼èµ‹ç»™è¾“å…¥æ¡†
                const selVal = document.getElementById('domain-select').value;
                if(selVal) document.getElementById('domain-input').value = selVal;
            } else {
                document.getElementById('domain-select-mode').classList.remove('hidden');
                document.getElementById('domain-input-mode').classList.add('hidden');
            }
        }

        // è·å–æœ€ç»ˆçš„åŸŸåå€¼
        function getDomainValue() {
            if (!document.getElementById('domain-input-mode').classList.contains('hidden')) {
                return document.getElementById('domain-input').value;
            }
            return document.getElementById('domain-select').value;
        }

        function toggleSSL() {
            const enabled = document.getElementById('enable_ssl').checked;
            const div = document.getElementById('ssl-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        }

        function toggleReceiver() {
            const enabled = document.getElementById('enable_receiver').checked;
            const div = document.getElementById('receiver-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        }

        function toggleReceiverTLS() {
            const enabled = document.getElementById('receiver_tls').checked;
            const div = document.getElementById('receiver-tls-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
                // å…³é—­ TLS æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆå¼ºåˆ¶ TLS
                document.getElementById('receiver_require_tls').checked = false;
            }
        }

        async function loadConfig() {
            try {
                const cfg = await request('/config'); // GET
                currentConfig = cfg;
                
                // å…ˆåŠ è½½åŸŸååˆ—è¡¨ï¼Œå¹¶æ ¹æ® cfg è®¾ç½®é€‰ä¸­çŠ¶æ€
                await loadDomains();

                // åŸºç¡€é…ç½®
                // domain å·²åœ¨ loadDomains ä¸­å¤„ç†
                document.getElementById('dkim_selector').value = cfg.dkim_selector || 'default';

                // Webé…ç½®
                document.getElementById('host').value = cfg.host || '0.0.0.0';
                document.getElementById('port').value = cfg.port || '9901';
                document.getElementById('base_url').value = cfg.base_url || ''; // åŠ è½½ BaseURL
                document.getElementById('enable_ssl').checked = cfg.enable_ssl || false;
                document.getElementById('cert_file').value = cfg.cert_file || '';
                document.getElementById('key_file').value = cfg.key_file || '';
                
                // æ¥æ”¶æœåŠ¡é…ç½®
                document.getElementById('enable_receiver').checked = cfg.enable_receiver || false;
                document.getElementById('receiver_port').value = cfg.receiver_port || '25';
                document.getElementById('receiver_tls').checked = cfg.receiver_tls || false;
                document.getElementById('receiver_tls_cert').value = cfg.receiver_tls_cert || '';
                document.getElementById('receiver_tls_key').value = cfg.receiver_tls_key || '';
                document.getElementById('receiver_rate_limit').value = cfg.receiver_rate_limit || 30;
                document.getElementById('receiver_max_msg_size').value = cfg.receiver_max_msg_size || 10240;
                document.getElementById('receiver_blacklist').value = cfg.receiver_blacklist || '';
                document.getElementById('receiver_require_tls').checked = cfg.receiver_require_tls || false;
                
                toggleSSL();
                toggleReceiver();
                toggleReceiverTLS();
            } catch (e) {}
        }

        async function saveConfig(e, type) {
            e.preventDefault();
            
            // åˆå¹¶é…ç½®
            const newConfig = {
                ...currentConfig,
                domain: getDomainValue(),
                dkim_selector: document.getElementById('dkim_selector').value,
                host: document.getElementById('host').value,
                port: document.getElementById('port').value,
                base_url: document.getElementById('base_url').value,
                enable_ssl: document.getElementById('enable_ssl').checked,
                cert_file: document.getElementById('cert_file').value,
                key_file: document.getElementById('key_file').value,
                enable_receiver: document.getElementById('enable_receiver').checked,
                receiver_port: document.getElementById('receiver_port').value,
                receiver_tls: document.getElementById('receiver_tls').checked,
                receiver_tls_cert: document.getElementById('receiver_tls_cert').value,
                receiver_tls_key: document.getElementById('receiver_tls_key').value,
                receiver_rate_limit: parseInt(document.getElementById('receiver_rate_limit').value) || 30,
                receiver_max_msg_size: parseInt(document.getElementById('receiver_max_msg_size').value) || 10240,
                receiver_blacklist: document.getElementById('receiver_blacklist').value,
                receiver_require_tls: document.getElementById('receiver_require_tls').checked
            };

            try {
                await request('/config', { method: 'POST', body: JSON.stringify(newConfig) });
                
                // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (type === 'business') {
                    showToast(I18n.t('settings.toast.biz_updated'));
                } else if (type === 'web') {
                    showToast(I18n.t('settings.toast.web_updated'), 'info');
                } else if (type === 'receiver') {
                    showToast(I18n.t('settings.toast.recv_updated'), 'info');
                } else {
                    showToast(I18n.t('settings.toast.saved'));
                }
            } catch (e) {
                // request å·²ç»å¤„ç†äº† error toast
                if (e.data && e.data.pid) {
                    setTimeout(async () => {
                        if (confirm(e.message + "\n\n" + I18n.t('settings.alert.kill_confirm'))) {
                            await killProcess(e.data.pid);
                        }
                    }, 500);
                }
            }
        }

        async function resetSecret() {
            if (!confirm(I18n.t('settings.alert.jwt_confirm'))) return;
            
            // å¤ç”¨ä¿å­˜é€»è¾‘ï¼Œä½†è®¾ç½®ç‰¹æ®Šæ ‡è®°
            const newConfig = { ...currentConfig, jwt_secret: 'RESET' };
            try {
                await request('/config', { method: 'POST', body: JSON.stringify(newConfig) });
                showToast(I18n.t('settings.toast.jwt_reset'));
                setTimeout(() => Auth.logout(), 2000);
            } catch (e) {}
        }

        async function downloadBackup() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch('/api/v1/backup', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "goemail-backup.zip";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    showToast(I18n.t('settings.toast.backup_start'));
                } else {
                    showToast(I18n.t('settings.toast.backup_fail'), 'error');
                }
            } catch(e) {
                showToast(I18n.t('settings.toast.net_fail'), 'error');
            }
        }

        async function changePassword(e) {
            e.preventDefault();
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;

            try {
                await request('/password', { 
                    method: 'POST', 
                    body: JSON.stringify({ old_password: oldPass, new_password: newPass }) 
                });
                showToast(I18n.t('settings.toast.pwd_changed'));
                setTimeout(() => Auth.logout(), 1500);
            } catch (e) {}
        }

        async function testPort() {
            const port = document.getElementById('receiver_port').value;
            if (!port) return;
            
            const btn = event.target;
            const originalText = btn.innerText;
            
            try {
                btn.innerText = 'Testing...';
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');

                const res = await request('/config/test-port', {
                    method: 'POST',
                    body: JSON.stringify({ port: port })
                });
                
                if (res.success) {
                    showToast(res.message, 'success');
                } else {
                    showToast(res.message, 'error');
                    // å¦‚æœè¿”å›äº† PIDï¼Œè¯¢é—®æ˜¯å¦å…³é—­
                    if (res.pid) {
                        if (confirm(res.message + "\n\n" + I18n.t('settings.alert.kill_confirm'))) {
                            await killProcess(res.pid);
                        }
                    }
                }
            } catch (e) {
                // request handles error toast
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function killProcess(pid) {
            try {
                const res = await request('/config/kill-process', {
                    method: 'POST',
                    body: JSON.stringify({ pid: pid })
                });
                showToast(res.message, 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        loadConfig();
        loadCleanupData();

        // --- æ•°æ®æ¸…ç†ç›¸å…³å‡½æ•° ---
        async function loadCleanupData() {
            try {
                // å¹¶è¡ŒåŠ è½½ç»Ÿè®¡å’Œé…ç½®
                const [stats, cfg] = await Promise.all([
                    request('/cleanup/stats'),
                    request('/cleanup/config')
                ]);

                // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                document.getElementById('stat-email-logs').textContent = stats.email_logs.toLocaleString();
                document.getElementById('stat-inbox').textContent = stats.inbox_items.toLocaleString();
                document.getElementById('stat-queue').textContent = stats.queue_items.toLocaleString();
                document.getElementById('stat-forward').textContent = stats.forward_logs.toLocaleString();
                document.getElementById('stat-attach').textContent = stats.attachments.toLocaleString();
                document.getElementById('stat-size').textContent = formatSize(stats.total_size);

                // å¡«å……é…ç½®è¡¨å•
                document.getElementById('cleanup_enabled').checked = cfg.cleanup_enabled || false;
                document.getElementById('cleanup_email_log_days').value = cfg.cleanup_email_log_days || 30;
                document.getElementById('cleanup_inbox_days').value = cfg.cleanup_inbox_days || 30;
                document.getElementById('cleanup_queue_days').value = cfg.cleanup_queue_days || 7;
                document.getElementById('cleanup_forward_days').value = cfg.cleanup_forward_days || 30;
                document.getElementById('cleanup_attach_days').value = cfg.cleanup_attach_days || 30;
            } catch (e) {
                console.error('åŠ è½½æ¸…ç†æ•°æ®å¤±è´¥:', e);
            }
        }

        async function saveCleanupConfig(e) {
            e.preventDefault();
            
            const cfg = {
                cleanup_enabled: document.getElementById('cleanup_enabled').checked,
                cleanup_email_log_days: parseInt(document.getElementById('cleanup_email_log_days').value) || 30,
                cleanup_inbox_days: parseInt(document.getElementById('cleanup_inbox_days').value) || 30,
                cleanup_queue_days: parseInt(document.getElementById('cleanup_queue_days').value) || 7,
                cleanup_forward_days: parseInt(document.getElementById('cleanup_forward_days').value) || 30,
                cleanup_attach_days: parseInt(document.getElementById('cleanup_attach_days').value) || 30
            };

            try {
                await request('/cleanup/config', { method: 'PUT', body: JSON.stringify(cfg) });
                showToast(I18n.t('settings.toast.cleanup_saved') || 'æ¸…ç†é…ç½®å·²ä¿å­˜');
            } catch (e) {
                // request å·²å¤„ç†é”™è¯¯
            }
        }

        async function runCleanup() {
            const confirmMsg = I18n.t('settings.alert.cleanup_confirm') || 'ç¡®å®šè¦ç«‹å³æ‰§è¡Œæ•°æ®æ¸…ç†å—ï¼Ÿè¿™å°†åˆ é™¤è¶…è¿‡ä¿ç•™æœŸé™çš„å†å²æ•°æ®ã€‚';
            if (!confirm(confirmMsg)) return;

            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${I18n.t('settings.cleanup.running') || 'æ¸…ç†ä¸­...'}</span>`;

                const res = await request('/cleanup/run', { method: 'POST' });

                // æ˜¾ç¤ºæ¸…ç†ç»“æœ
                const msg = `${I18n.t('settings.toast.cleanup_done') || 'æ¸…ç†å®Œæˆ'}\n` +
                    `- ${I18n.t('settings.cleanup.email_logs') || 'å‘é€æ—¥å¿—'}: ${res.email_logs}\n` +
                    `- ${I18n.t('settings.cleanup.inbox') || 'æ”¶ä»¶ç®±'}: ${res.inbox_items}\n` +
                    `- ${I18n.t('settings.cleanup.queue') || 'é˜Ÿåˆ—è®°å½•'}: ${res.queue_items}\n` +
                    `- ${I18n.t('settings.cleanup.forward') || 'è½¬å‘æ—¥å¿—'}: ${res.forward_logs}\n` +
                    `- ${I18n.t('settings.cleanup.attach') || 'é™„ä»¶æ–‡ä»¶'}: ${res.attachments}\n` +
                    `- ${I18n.t('settings.cleanup.freed') || 'é‡Šæ”¾ç©ºé—´'}: ${formatSize(res.freed_bytes)}\n` +
                    `- ${I18n.t('settings.cleanup.duration') || 'è€—æ—¶'}: ${res.duration_ms}ms`;

                showToast(I18n.t('settings.toast.cleanup_done') || 'æ¸…ç†å®Œæˆ', 'success');
                alert(msg);

                // é‡æ–°åŠ è½½ç»Ÿè®¡
                loadCleanupData();
            } catch (e) {
                // request å·²å¤„ç†é”™è¯¯
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
