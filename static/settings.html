<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>系统设置 - 晴辰云邮</title>
    <link href="/dashboard/css/tailwind.min.css?v=8.0" rel="stylesheet">
    <script src="/dashboard/js/common.js?v=8.0"></script>
    <script src="/dashboard/js/layout.js?v=8.0"></script>
</head>
<body class="hidden" data-i18n-module="settings">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800" data-i18n="settings.title">系统设置</h2>
        <p class="text-gray-500 mt-1" data-i18n="settings.subtitle">配置服务器运行参数与安全选项</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <!-- 基础业务配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:col-span-2">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-purple-100 text-purple-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </span>
                <span data-i18n="settings.biz.title">基础业务配置</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.biz.domain_label">默认发信域名 (Domain)</label>
                    <!-- 下拉选择模式 -->
                    <div id="domain-select-mode" class="relative">
                        <select id="domain-select" onchange="onSelectChange()" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500 appearance-none bg-white">
                            <option value="" data-i18n="common.loading">加载中...</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <button type="button" onclick="toggleDomainInput(true)" class="absolute right-8 top-0 bottom-0 px-2 text-xs text-blue-600 hover:text-blue-800 bg-transparent" data-i18n="settings.biz.manual_input">手动输入</button>
                    </div>
                    <!-- 手动输入模式 -->
                    <div id="domain-input-mode" class="relative hidden">
                        <input type="text" id="domain-input" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500" placeholder="example.com">
                        <button type="button" onclick="toggleDomainInput(false)" class="absolute right-2 top-2 text-xs text-blue-600 hover:text-blue-800" data-i18n="settings.biz.select_list">选择列表</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.biz.domain_hint">当未指定发件人时，将使用 noreply@此域名</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.biz.dkim_label">DKIM Selector</label>
                    <input type="text" id="dkim_selector" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500" placeholder="default">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.biz.dkim_hint">DKIM 签名的选择器，通常保持默认</p>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                <button type="button" onclick="saveConfig(event, 'business')" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition shadow-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    <span data-i18n="settings.biz.save_btn">保存业务配置</span>
                </button>
            </div>
        </div>
        
        <!-- Web 服务配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </span>
                <span data-i18n="settings.web.title">Web 服务配置</span>
            </h3>
            
            <form onsubmit="saveConfig(event, 'web')" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.host_label">监听地址 (Host)</label>
                        <div class="relative">
                            <input type="text" id="host" list="host-list" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.0.0.0">
                            <datalist id="host-list">
                                <option value="0.0.0.0" data-i18n="settings.web.host_public">0.0.0.0 (允许公网访问)</option>
                                <option value="127.0.0.1" data-i18n="settings.web.host_local">127.0.0.1 (仅本机/反向代理)</option>
                            </datalist>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" data-i18n="settings.web.host_hint">支持下拉选择或手动输入</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.port_label">监听端口 (Port)</label>
                        <input type="text" id="port" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="9901">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.base_url">公网访问地址 (BaseURL)</label>
                    <input type="text" id="base_url" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://mail.example.com:9901">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.web.base_url_hint">用于生成邮件中的追踪链接和退订链接，请务必填写外部可访问的完整 URL</p>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <div class="mb-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="enable_ssl" class="form-checkbox h-5 w-5 text-blue-600 rounded transition" onchange="toggleSSL()">
                            <span class="ml-2 font-medium text-gray-700" data-i18n="settings.web.ssl_enable">启用 HTTPS (SSL)</span>
                        </label>
                        <p class="text-xs text-yellow-600 mt-1 ml-7" data-i18n="settings.web.ssl_hint">
                            ⚠️ 提示：如果您使用 Nginx/Apache 反向代理，请勿开启此项，直接配置 Nginx 即可。
                        </p>
                    </div>

                    <div id="ssl-config" class="space-y-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.cert_label">证书文件路径 (.crt/.pem)</label>
                            <input type="text" id="cert_file" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="./cert.pem">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.key_label">私钥文件路径 (.key)</label>
                            <input type="text" id="key_file" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="./key.pem">
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition shadow-md">
                        <span data-i18n="settings.web.save_btn">保存 Web 配置</span>
                    </button>
                    <p class="text-xs text-center text-red-500 mt-2" data-i18n="settings.web.restart_hint">注意：修改监听配置后，需要手动重启程序才能生效！</p>
                </div>
            </form>
        </div>

        <!-- 邮件接收服务配置 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </span>
                <span data-i18n="settings.recv.title">邮件接收服务 (转发)</span>
            </h3>
            
            <form onsubmit="saveConfig(event, 'receiver')" class="space-y-5">
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="enable_receiver" class="form-checkbox h-5 w-5 text-indigo-600 rounded transition" onchange="toggleReceiver()">
                        <span class="ml-2 font-medium text-gray-700" data-i18n="settings.recv.enable">启用 SMTP 接收服务</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-7" data-i18n="settings.recv.desc">
                        启用后可接收发往域名邮箱的邮件，并根据转发规则转发到指定邮箱。
                    </p>
                </div>

                <div id="receiver-config" class="space-y-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 text-sm p-3 rounded-lg">
                        <p class="font-medium mb-1" data-i18n="settings.recv.req_title">⚠️ 使用前提</p>
                        <ul class="list-disc list-inside text-xs space-y-1">
                            <li data-i18n="settings.recv.req_1">需要在域名 DNS 添加 MX 记录指向本服务器 IP</li>
                            <li data-i18n="settings.recv.req_2">端口 25 需要服务器防火墙放行（部分云服务商默认封禁）</li>
                            <li data-i18n="settings.recv.req_3">Linux 下监听 25 端口需要 root 权限或使用 <code class="bg-yellow-100 px-1 rounded">setcap</code></li>
                        </ul>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.port_label">监听端口</label>
                        <div class="flex space-x-2">
                            <input type="text" id="receiver_port" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="25">
                            <button type="button" onclick="testPort()" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm font-medium whitespace-nowrap" data-i18n="settings.recv.test_btn">检测占用</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" data-i18n="settings.recv.port_hint">SMTP 标准端口为 25，也可使用其他端口如 2525</p>
                    </div>
                    <div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="receiver_tls" class="form-checkbox h-4 w-4 text-indigo-600 rounded transition">
                            <span class="ml-2 text-sm text-gray-700" data-i18n="settings.recv.tls_enable">启用 STARTTLS (推荐)</span>
                        </label>
                        <p class="text-xs text-gray-400 mt-1 ml-6" data-i18n="settings.recv.tls_hint">需要配置 SSL 证书（使用上方 Web 服务的证书）</p>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2.5 rounded-lg hover:bg-indigo-700 transition shadow-md">
                        <span data-i18n="settings.recv.save_btn">保存接收服务配置</span>
                    </button>
                    <p class="text-xs text-center text-red-500 mt-2" data-i18n="settings.recv.restart_hint">注意：修改接收服务配置后，需要手动重启程序才能生效！</p>
                </div>
            </form>
        </div>

        <!-- 密码与安全 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col justify-between">
            <div>
                <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                    <span class="bg-green-100 text-green-600 p-1.5 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </span>
                    <span data-i18n="settings.sec.title">安全设置</span>
                </h3>

                <div class="mb-8">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.backup_title">数据备份</h4>
                    <p class="text-xs text-gray-500 mb-3" data-i18n="settings.sec.backup_desc">将 config.json 和数据库文件打包下载，建议定期备份。</p>
                    <button onclick="downloadBackup()" class="w-full bg-blue-50 text-blue-600 border border-blue-200 font-bold py-2 rounded-lg hover:bg-blue-100 transition text-sm flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span data-i18n="settings.sec.backup_btn">下载完整备份</span>
                    </button>
                </div>
                
                <form onsubmit="changePassword(event)" class="space-y-4 mb-8">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.pwd_title">修改管理员密码</h4>
                    <div>
                        <input type="password" id="old-pass" required data-i18n-attr="placeholder:settings.sec.old_pwd_ph" placeholder="当前密码" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <div>
                        <input type="password" id="new-pass" required data-i18n-attr="placeholder:settings.sec.new_pwd_ph" placeholder="新密码" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <div class="pt-1">
                        <button type="submit" class="w-full bg-green-50 text-green-700 border border-green-200 font-bold py-2 rounded-lg hover:bg-green-100 transition text-sm">
                            <span data-i18n="settings.sec.pwd_btn">更新密码</span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3" data-i18n="settings.sec.jwt_title">登录密钥 (JWT Secret)</h4>
                <p class="text-xs text-gray-500 mb-4 leading-relaxed" data-i18n="settings.sec.jwt_desc">
                    重置密钥将导致所有已登录用户（包括API Token）立即失效，需重新登录。仅在怀疑密钥泄露时使用。
                </p>
                <button type="button" onclick="resetSecret()" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-2 rounded-lg hover:bg-red-100 transition text-sm flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <span data-i18n="settings.sec.jwt_btn">重置并强制下线</span>
                </button>
            </div>
        </div>

    </div>

    <script>
        Auth.check();

        // 缓存配置与域名映射
        let currentConfig = {};
        let domainMap = {};

        async function loadDomains() {
            try {
                const list = await request('/domains');
                const select = document.getElementById('domain-select');
                select.innerHTML = `<option value="">${I18n.t('settings.js.select_ph')}</option>`;
                
                list.forEach(d => {
                    domainMap[d.name] = d;
                    const opt = document.createElement('option');
                    opt.value = d.name;
                    opt.text = d.name;
                    select.appendChild(opt);
                });
                
                // 如果当前配置的域名在列表中，选中它
                if (currentConfig.domain && domainMap[currentConfig.domain]) {
                    select.value = currentConfig.domain;
                } else if (currentConfig.domain) {
                    // 如果不在列表中，切换到手动模式
                    document.getElementById('domain-input').value = currentConfig.domain;
                    toggleDomainInput(true);
                }
            } catch(e) {}
        }

        function onSelectChange() {
            const val = document.getElementById('domain-select').value;
            if (val && domainMap[val]) {
                document.getElementById('dkim_selector').value = domainMap[val].dkim_selector || 'default';
            }
        }

        function toggleDomainInput(showInput) {
            if (showInput) {
                document.getElementById('domain-select-mode').classList.add('hidden');
                document.getElementById('domain-input-mode').classList.remove('hidden');
                // 假如从下拉切换过来，把下拉的值赋给输入框
                const selVal = document.getElementById('domain-select').value;
                if(selVal) document.getElementById('domain-input').value = selVal;
            } else {
                document.getElementById('domain-select-mode').classList.remove('hidden');
                document.getElementById('domain-input-mode').classList.add('hidden');
            }
        }

        // 获取最终的域名值
        function getDomainValue() {
            if (!document.getElementById('domain-input-mode').classList.contains('hidden')) {
                return document.getElementById('domain-input').value;
            }
            return document.getElementById('domain-select').value;
        }

        function toggleSSL() {
            const enabled = document.getElementById('enable_ssl').checked;
            const div = document.getElementById('ssl-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        }

        function toggleReceiver() {
            const enabled = document.getElementById('enable_receiver').checked;
            const div = document.getElementById('receiver-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        }

        async function loadConfig() {
            try {
                const cfg = await request('/config'); // GET
                currentConfig = cfg;
                
                // 先加载域名列表，并根据 cfg 设置选中状态
                await loadDomains();

                // 基础配置
                // domain 已在 loadDomains 中处理
                document.getElementById('dkim_selector').value = cfg.dkim_selector || 'default';

                // Web配置
                document.getElementById('host').value = cfg.host || '0.0.0.0';
                document.getElementById('port').value = cfg.port || '9901';
                document.getElementById('base_url').value = cfg.base_url || ''; // 加载 BaseURL
                document.getElementById('enable_ssl').checked = cfg.enable_ssl || false;
                document.getElementById('cert_file').value = cfg.cert_file || '';
                document.getElementById('key_file').value = cfg.key_file || '';
                
                // 接收服务配置
                document.getElementById('enable_receiver').checked = cfg.enable_receiver || false;
                document.getElementById('receiver_port').value = cfg.receiver_port || '25';
                document.getElementById('receiver_tls').checked = cfg.receiver_tls || false;
                
                toggleSSL();
                toggleReceiver();
            } catch (e) {}
        }

        async function saveConfig(e, type) {
            e.preventDefault();
            
            // 合并配置
            const newConfig = {
                ...currentConfig,
                domain: getDomainValue(),
                dkim_selector: document.getElementById('dkim_selector').value,
                host: document.getElementById('host').value,
                port: document.getElementById('port').value,
                base_url: document.getElementById('base_url').value, // 保存 BaseURL
                enable_ssl: document.getElementById('enable_ssl').checked,
                cert_file: document.getElementById('cert_file').value,
                key_file: document.getElementById('key_file').value,
                enable_receiver: document.getElementById('enable_receiver').checked,
                receiver_port: document.getElementById('receiver_port').value,
                receiver_tls: document.getElementById('receiver_tls').checked
            };

            try {
                await request('/config', { method: 'POST', body: JSON.stringify(newConfig) });
                
                // 根据类型显示不同的提示
                if (type === 'business') {
                    showToast(I18n.t('settings.toast.biz_updated'));
                } else if (type === 'web') {
                    showToast(I18n.t('settings.toast.web_updated'), 'info');
                } else if (type === 'receiver') {
                    showToast(I18n.t('settings.toast.recv_updated'), 'info');
                } else {
                    showToast(I18n.t('settings.toast.saved'));
                }
            } catch (e) {
                // request 已经处理了 error toast
                if (e.data && e.data.pid) {
                    setTimeout(async () => {
                        if (confirm(e.message + "\n\n" + I18n.t('settings.alert.kill_confirm'))) {
                            await killProcess(e.data.pid);
                        }
                    }, 500);
                }
            }
        }

        async function resetSecret() {
            if (!confirm(I18n.t('settings.alert.jwt_confirm'))) return;
            
            // 复用保存逻辑，但设置特殊标记
            const newConfig = { ...currentConfig, jwt_secret: 'RESET' };
            try {
                await request('/config', { method: 'POST', body: JSON.stringify(newConfig) });
                showToast(I18n.t('settings.toast.jwt_reset'));
                setTimeout(() => Auth.logout(), 2000);
            } catch (e) {}
        }

        async function downloadBackup() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch('/api/v1/backup', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "goemail-backup.zip";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    showToast(I18n.t('settings.toast.backup_start'));
                } else {
                    showToast(I18n.t('settings.toast.backup_fail'), 'error');
                }
            } catch(e) {
                showToast(I18n.t('settings.toast.net_fail'), 'error');
            }
        }

        async function changePassword(e) {
            e.preventDefault();
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;

            try {
                await request('/password', { 
                    method: 'POST', 
                    body: JSON.stringify({ old_password: oldPass, new_password: newPass }) 
                });
                showToast(I18n.t('settings.toast.pwd_changed'));
                setTimeout(() => Auth.logout(), 1500);
            } catch (e) {}
        }

        async function testPort() {
            const port = document.getElementById('receiver_port').value;
            if (!port) return;
            
            const btn = event.target;
            const originalText = btn.innerText;
            
            try {
                btn.innerText = 'Testing...';
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');

                const res = await request('/config/test-port', {
                    method: 'POST',
                    body: JSON.stringify({ port: port })
                });
                
                if (res.success) {
                    showToast(res.message, 'success');
                } else {
                    showToast(res.message, 'error');
                    // 如果返回了 PID，询问是否关闭
                    if (res.pid) {
                        if (confirm(res.message + "\n\n" + I18n.t('settings.alert.kill_confirm'))) {
                            await killProcess(res.pid);
                        }
                    }
                }
            } catch (e) {
                // request handles error toast
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function killProcess(pid) {
            try {
                const res = await request('/config/kill-process', {
                    method: 'POST',
                    body: JSON.stringify({ pid: pid })
                });
                showToast(res.message, 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        loadConfig();
    </script>
</body>
</html>
