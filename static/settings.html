<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»Ÿè®¾ç½® - æ™´è¾°äº‘é‚®</title>
    <link href="/dashboard/css/tailwind.min.css?v=8.0" rel="stylesheet">
    <script src="/dashboard/js/loader.js?v=8.0"></script>
    <script src="/dashboard/js/common.js?v=8.0"></script>
    <script src="/dashboard/js/layout.js?v=8.0"></script>
</head>
<body class="hidden" data-i18n-module="settings">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800" data-i18n="settings.title">ç³»ç»Ÿè®¾ç½®</h2>
        <p class="text-gray-500 mt-1" data-i18n="settings.subtitle">é…ç½®æœåŠ¡å™¨è¿è¡Œå‚æ•°ä¸å®‰å…¨é€‰é¡¹</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <!-- åŸºç¡€ä¸šåŠ¡é…ç½® -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:col-span-2">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-purple-100 text-purple-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </span>
                <span data-i18n="settings.biz.title">åŸºç¡€ä¸šåŠ¡é…ç½®</span>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.biz.domain_label">é»˜è®¤å‘ä¿¡åŸŸå (Domain)</label>
                    <!-- ä¸‹æ‹‰é€‰æ‹©æ¨¡å¼ -->
                    <div id="domain-select-mode" class="relative">
                        <select id="domain-select" onchange="onSelectChange()" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500 appearance-none bg-white">
                            <option value="" data-i18n="common.loading">åŠ è½½ä¸­...</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <button type="button" onclick="toggleDomainInput(true)" class="absolute right-8 top-0 bottom-0 px-2 text-xs text-blue-600 hover:text-blue-800 bg-transparent" data-i18n="settings.biz.manual_input">æ‰‹åŠ¨è¾“å…¥</button>
                    </div>
                    <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
                    <div id="domain-input-mode" class="relative hidden">
                        <input type="text" id="domain-input" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500" placeholder="example.com">
                        <button type="button" onclick="toggleDomainInput(false)" class="absolute right-2 top-2 text-xs text-blue-600 hover:text-blue-800" data-i18n="settings.biz.select_list">é€‰æ‹©åˆ—è¡¨</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.biz.domain_hint">å½“æœªæŒ‡å®šå‘ä»¶äººæ—¶ï¼Œå°†ä½¿ç”¨ noreply@æ­¤åŸŸå</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.biz.dkim_label">DKIM Selector</label>
                    <input type="text" id="dkim_selector" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-purple-500" placeholder="default">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.biz.dkim_hint">DKIM ç­¾åçš„é€‰æ‹©å™¨ï¼Œé€šå¸¸ä¿æŒé»˜è®¤</p>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                <button type="button" onclick="saveConfig(event, 'business')" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition shadow-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    <span data-i18n="settings.biz.save_btn">ä¿å­˜ä¸šåŠ¡é…ç½®</span>
                </button>
            </div>
        </div>
        
        <!-- Web æœåŠ¡é…ç½® -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </span>
                <span data-i18n="settings.web.title">Web æœåŠ¡é…ç½®</span>
            </h3>
            
            <form onsubmit="saveConfig(event, 'web')" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.host_label">ç›‘å¬åœ°å€ (Host)</label>
                        <div class="relative">
                            <input type="text" id="host" list="host-list" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.0.0.0">
                            <datalist id="host-list">
                                <option value="0.0.0.0" data-i18n="settings.web.host_public">0.0.0.0 (å…è®¸å…¬ç½‘è®¿é—®)</option>
                                <option value="127.0.0.1" data-i18n="settings.web.host_local">127.0.0.1 (ä»…æœ¬æœº/åå‘ä»£ç†)</option>
                            </datalist>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" data-i18n="settings.web.host_hint">æ”¯æŒä¸‹æ‹‰é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.port_label">ç›‘å¬ç«¯å£ (Port)</label>
                        <input type="text" id="port" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="9901">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.base_url">å…¬ç½‘è®¿é—®åœ°å€ (BaseURL)</label>
                    <input type="text" id="base_url" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://mail.example.com:9901">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="settings.web.base_url_hint">ç”¨äºç”Ÿæˆé‚®ä»¶ä¸­çš„è¿½è¸ªé“¾æ¥å’Œé€€è®¢é“¾æ¥ï¼Œè¯·åŠ¡å¿…å¡«å†™å¤–éƒ¨å¯è®¿é—®çš„å®Œæ•´ URL</p>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <div class="mb-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="enable_ssl" class="form-checkbox h-5 w-5 text-blue-600 rounded transition" onchange="toggleSSL()">
                            <span class="ml-2 font-medium text-gray-700" data-i18n="settings.web.ssl_enable">å¯ç”¨ HTTPS (SSL)</span>
                        </label>
                        <p class="text-xs text-yellow-600 mt-1 ml-7" data-i18n="settings.web.ssl_hint">
                            âš ï¸ æç¤ºï¼šå¦‚æœæ‚¨ä½¿ç”¨ Nginx/Apache åå‘ä»£ç†ï¼Œè¯·å‹¿å¼€å¯æ­¤é¡¹ï¼Œç›´æ¥é…ç½® Nginx å³å¯ã€‚
                        </p>
                    </div>

                    <div id="ssl-config" class="space-y-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.cert_label">è¯ä¹¦æ–‡ä»¶è·¯å¾„ (.crt/.pem)</label>
                            <input type="text" id="cert_file" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="./cert.pem">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.web.key_label">ç§é’¥æ–‡ä»¶è·¯å¾„ (.key)</label>
                            <input type="text" id="key_file" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="./key.pem">
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition shadow-md">
                        <span data-i18n="settings.web.save_btn">ä¿å­˜ Web é…ç½®</span>
                    </button>
                    <p class="text-xs text-center text-red-500 mt-2" data-i18n="settings.web.restart_hint">æ³¨æ„ï¼šä¿®æ”¹ç›‘å¬é…ç½®åï¼Œéœ€è¦æ‰‹åŠ¨é‡å¯ç¨‹åºæ‰èƒ½ç”Ÿæ•ˆï¼</p>
                </div>
            </form>
        </div>

        <!-- é‚®ä»¶æ¥æ”¶æœåŠ¡é…ç½® -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </span>
                <span data-i18n="settings.recv.title">é‚®ä»¶æ¥æ”¶æœåŠ¡ (è½¬å‘)</span>
            </h3>
            
            <form onsubmit="saveConfig(event, 'receiver')" class="space-y-5">
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="enable_receiver" class="form-checkbox h-5 w-5 text-indigo-600 rounded transition" onchange="toggleReceiver()">
                        <span class="ml-2 font-medium text-gray-700" data-i18n="settings.recv.enable">å¯ç”¨ SMTP æ¥æ”¶æœåŠ¡</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-7" data-i18n="settings.recv.desc">
                        å¯ç”¨åå¯æ¥æ”¶å‘å¾€åŸŸåé‚®ç®±çš„é‚®ä»¶ï¼Œå¹¶æ ¹æ®è½¬å‘è§„åˆ™è½¬å‘åˆ°æŒ‡å®šé‚®ç®±ã€‚
                    </p>
                </div>

                <div id="receiver-config" class="space-y-4 hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 text-sm p-3 rounded-lg">
                        <p class="font-medium mb-1" data-i18n="settings.recv.req_title">âš ï¸ ä½¿ç”¨å‰æ</p>
                        <ul class="list-disc list-inside text-xs space-y-1">
                            <li data-i18n="settings.recv.req_1">éœ€è¦åœ¨åŸŸå DNS æ·»åŠ  MX è®°å½•æŒ‡å‘æœ¬æœåŠ¡å™¨ IP</li>
                            <li data-i18n="settings.recv.req_2">ç«¯å£ 25 éœ€è¦æœåŠ¡å™¨é˜²ç«å¢™æ”¾è¡Œï¼ˆéƒ¨åˆ†äº‘æœåŠ¡å•†é»˜è®¤å°ç¦ï¼‰</li>
                            <li data-i18n="settings.recv.req_3">Linux ä¸‹ç›‘å¬ 25 ç«¯å£éœ€è¦ root æƒé™æˆ–ä½¿ç”¨ <code class="bg-yellow-100 px-1 rounded">setcap</code></li>
                        </ul>
                    </div>
                    
                    <!-- ç«¯å£è¢«å ç”¨è§£å†³æ–¹æ¡ˆ -->
                    <details class="bg-blue-50 border border-blue-200 text-blue-700 text-sm rounded-lg">
                        <summary class="p-3 cursor-pointer font-medium hover:bg-blue-100 rounded-lg transition" data-i18n="settings.recv.port_conflict_title">ğŸ’¡ ç«¯å£ 25 è¢«å ç”¨ï¼ŸæŸ¥çœ‹è§£å†³æ–¹æ¡ˆ</summary>
                        <div class="px-3 pb-3 text-xs space-y-3">
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_1_title">æ–¹æ¡ˆ 1: ç«¯å£è½¬å‘ (æ¨è)</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_1_desc">ç¨‹åºç›‘å¬ 2525ï¼Œç”¨ iptables è½¬å‘ 25â†’2525ï¼š</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto">sudo iptables -t nat -A PREROUTING -p tcp --dport 25 -j REDIRECT --to-port 2525</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_2_title">æ–¹æ¡ˆ 2: Nginx TCP ä»£ç†</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_2_desc">ä½¿ç”¨ Nginx stream æ¨¡å—ä»£ç†ï¼š</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto whitespace-pre">stream {
    server {
        listen 25;
        proxy_pass 127.0.0.1:2525;
    }
}</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_3_title">æ–¹æ¡ˆ 3: åœç”¨åŸæœ‰ MTA</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_3_desc">åœæ­¢ Postfix/Sendmail ç­‰ï¼š</p>
                                <code class="block bg-blue-100 p-2 rounded text-xs overflow-x-auto">sudo systemctl stop postfix && sudo systemctl disable postfix</code>
                            </div>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-i18n="settings.recv.solution_4_title">æ–¹æ¡ˆ 4: ä¸ Postfix é›†æˆ</p>
                                <p class="text-blue-600 mb-1" data-i18n="settings.recv.solution_4_desc">é…ç½® Postfix å°†é‚®ä»¶è½¬å‘åˆ°æœ¬ç¨‹åºï¼Œè¯¦è§æ–‡æ¡£ã€‚</p>
                            </div>
                        </div>
                    </details>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.port_label">ç›‘å¬ç«¯å£</label>
                            <div class="flex space-x-2">
                                <input type="text" id="receiver_port" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="25">
                                <button type="button" onclick="testPort()" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm font-medium whitespace-nowrap" data-i18n="settings.recv.test_btn">æ£€æµ‹</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.rate_limit">é€Ÿç‡é™åˆ¶ (è¿æ¥/åˆ†é’Ÿ)</label>
                            <input type="number" id="receiver_rate_limit" min="0" max="1000" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="30">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.max_size">æœ€å¤§é‚®ä»¶å¤§å° (KB)</label>
                            <input type="number" id="receiver_max_msg_size" min="100" max="102400" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="10240">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.recv.blacklist">IP é»‘åå•</label>
                            <input type="text" id="receiver_blacklist" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="1.2.3.4, 5.6.7.8">
                        </div>
                    </div>
                    <div class="space-y-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="receiver_tls" class="form-checkbox h-4 w-4 text-indigo-600 rounded transition" onchange="toggleReceiverTLS()">
                            <span class="ml-2 text-sm text-gray-700" data-i18n="settings.recv.tls_enable">å¯ç”¨ STARTTLS (åŠ å¯†ä¼ è¾“)</span>
                        </label>
                        
                        <!-- TLS è¯ä¹¦é…ç½® -->
                        <div id="receiver-tls-config" class="hidden ml-6 p-3 bg-white border border-indigo-200 rounded-lg space-y-3">
                            <div class="bg-red-50 border border-red-200 text-red-700 text-xs p-2 rounded">
                                <strong data-i18n="settings.recv.tls_warning_title">âš ï¸ é‡è¦ï¼š</strong>
                                <span data-i18n="settings.recv.tls_warning">å¿…é¡»é…ç½®æœ‰æ•ˆçš„ SSL è¯ä¹¦ï¼Œå¦åˆ™ STARTTLS å°†æ— æ³•å·¥ä½œï¼å¯ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ã€‚</span>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1" data-i18n="settings.recv.tls_cert">è¯ä¹¦æ–‡ä»¶ (.pem/.crt)</label>
                                <input type="text" id="receiver_tls_cert" class="w-full border rounded px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="/etc/letsencrypt/live/mail.example.com/fullchain.pem">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1" data-i18n="settings.recv.tls_key">ç§é’¥æ–‡ä»¶ (.key)</label>
                                <input type="text" id="receiver_tls_key" class="w-full border rounded px-2 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="/etc/letsencrypt/live/mail.example.com/privkey.pem">
                            </div>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="receiver_require_tls" class="form-checkbox h-4 w-4 text-indigo-600 rounded transition">
                                <span class="ml-2 text-sm text-gray-700" data-i18n="settings.recv.require_tls">å¼ºåˆ¶ TLS (æ‹’ç»æ˜æ–‡è¿æ¥)</span>
                            </label>
                            <p class="text-xs text-red-500" data-i18n="settings.recv.require_tls_warning">âš ï¸ å‹¾é€‰åï¼Œæœªé…ç½® STARTTLS çš„å‘ä»¶æ–¹å°†æ— æ³•ç»™ä½ å‘é‚®ä»¶ï¼å»ºè®®å…ˆæµ‹è¯•åå†å¼€å¯ã€‚</p>
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2.5 rounded-lg hover:bg-indigo-700 transition shadow-md">
                        <span data-i18n="settings.recv.save_btn">ä¿å­˜æ¥æ”¶æœåŠ¡é…ç½®</span>
                    </button>
                    <p class="text-xs text-center text-red-500 mt-2" data-i18n="settings.recv.restart_hint">æ³¨æ„ï¼šä¿®æ”¹æ¥æ”¶æœåŠ¡é…ç½®åï¼Œéœ€è¦æ‰‹åŠ¨é‡å¯ç¨‹åºæ‰èƒ½ç”Ÿæ•ˆï¼</p>
                </div>
            </form>
        </div>

        <!-- æ•°æ®æ¸…ç† -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-orange-100 text-orange-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </span>
                <span data-i18n="settings.cleanup.title">æ•°æ®æ¸…ç†</span>
            </h3>
            
            <form onsubmit="saveCleanupConfig(event)" class="space-y-5">
                <!-- æ•°æ®ç»Ÿè®¡ -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-3" data-i18n="settings.cleanup.stats_title">å½“å‰æ•°æ®é‡</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm" id="cleanup-stats">
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.email_logs">å‘é€æ—¥å¿—:</span> <span id="stat-email-logs" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.inbox">æ”¶ä»¶ç®±:</span> <span id="stat-inbox" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.queue">é˜Ÿåˆ—è®°å½•:</span> <span id="stat-queue" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.forward">è½¬å‘æ—¥å¿—:</span> <span id="stat-forward" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.attach">é™„ä»¶æ–‡ä»¶:</span> <span id="stat-attach" class="font-medium">-</span></div>
                        <div class="flex justify-between"><span data-i18n="settings.cleanup.attach_size">é™„ä»¶å¤§å°:</span> <span id="stat-size" class="font-medium">-</span></div>
                    </div>
                </div>

                <!-- è‡ªåŠ¨æ¸…ç†å¼€å…³ -->
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="cleanup_enabled" class="form-checkbox h-5 w-5 text-orange-600 rounded transition">
                        <span class="ml-2 font-medium text-gray-700" data-i18n="settings.cleanup.auto_enable">å¯ç”¨è‡ªåŠ¨æ¸…ç†</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-7" data-i18n="settings.cleanup.auto_desc">
                        å¯ç”¨åï¼Œç³»ç»Ÿå°†åœ¨æ¯å¤©å‡Œæ™¨ 3:00 è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ã€‚
                    </p>
                </div>

                <!-- ä¿ç•™å¤©æ•°é…ç½® -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.email_log_days">å‘é€æ—¥å¿—ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_email_log_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.inbox_days">æ”¶ä»¶ç®±ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_inbox_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.queue_days">é˜Ÿåˆ—è®°å½•ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_queue_days" min="1" max="90" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="7">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.forward_days">è½¬å‘æ—¥å¿—ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_forward_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="settings.cleanup.attach_days">é™„ä»¶ä¿ç•™ (å¤©)</label>
                        <input type="number" id="cleanup_attach_days" min="1" max="365" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="30">
                    </div>
                </div>

                <div class="pt-4 space-y-3">
                    <button type="submit" class="w-full font-bold py-2.5 rounded-lg transition shadow-md flex items-center justify-center" style="background-color: #ea580c; color: white;">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        <span data-i18n="settings.cleanup.save_btn">ä¿å­˜æ¸…ç†é…ç½®</span>
                    </button>
                    <button type="button" onclick="runCleanup()" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-2.5 rounded-lg hover:bg-red-100 transition flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span data-i18n="settings.cleanup.run_btn">ç«‹å³æ¸…ç†</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- å¯†ç ä¸å®‰å…¨ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col justify-between">
            <div>
                <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                    <span class="bg-green-100 text-green-600 p-1.5 rounded-lg mr-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </span>
                    <span data-i18n="settings.sec.title">å®‰å…¨è®¾ç½®</span>
                </h3>

                <div class="mb-8">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.backup_title">æ•°æ®å¤‡ä»½</h4>
                    <p class="text-xs text-gray-500 mb-3" data-i18n="settings.sec.backup_desc">å°† config.json å’Œæ•°æ®åº“æ–‡ä»¶æ‰“åŒ…ä¸‹è½½ï¼Œå»ºè®®å®šæœŸå¤‡ä»½ã€‚</p>
                    <button onclick="downloadBackup()" class="w-full bg-blue-50 text-blue-600 border border-blue-200 font-bold py-2 rounded-lg hover:bg-blue-100 transition text-sm flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span data-i18n="settings.sec.backup_btn">ä¸‹è½½å®Œæ•´å¤‡ä»½</span>
                    </button>
                </div>
                
                <form onsubmit="changePassword(event)" class="space-y-4 mb-8">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.pwd_title">ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h4>
                    <div>
                        <input type="password" id="old-pass" required data-i18n-attr="placeholder:settings.sec.old_pwd_ph" placeholder="å½“å‰å¯†ç " class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <div>
                        <input type="password" id="new-pass" required data-i18n-attr="placeholder:settings.sec.new_pwd_ph" placeholder="æ–°å¯†ç " class="w-full border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <div class="pt-1">
                        <button type="submit" class="w-full bg-green-50 text-green-700 border border-green-200 font-bold py-2 rounded-lg hover:bg-green-100 transition text-sm">
                            <span data-i18n="settings.sec.pwd_btn">æ›´æ–°å¯†ç </span>
                        </button>
                    </div>
                </form>

                <!-- ä¸¤æ­¥éªŒè¯ (2FA) -->
                <div class="mb-8 border-t border-gray-100 pt-6">
                    <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2" data-i18n="settings.sec.totp_title">ä¸¤æ­¥éªŒè¯ (2FA)</h4>
                    
                    <!-- æœªå¯ç”¨çŠ¶æ€ -->
                    <div id="totp-disabled-section">
                        <p class="text-xs text-gray-500 mb-3" data-i18n="settings.sec.totp_desc">å¯ç”¨åï¼Œç™»å½•æ—¶éœ€è¦è¾“å…¥éªŒè¯å™¨ App ä¸­çš„åŠ¨æ€éªŒè¯ç ã€‚</p>
                        <button type="button" onclick="setupTOTP()" class="w-full bg-indigo-50 text-indigo-600 border border-indigo-200 font-bold py-2 rounded-lg hover:bg-indigo-100 transition text-sm flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                            <span data-i18n="settings.sec.totp_enable_btn">å¯ç”¨ä¸¤æ­¥éªŒè¯</span>
                        </button>
                    </div>

                    <!-- å·²å¯ç”¨çŠ¶æ€ -->
                    <div id="totp-enabled-section" class="hidden">
                        <div class="flex items-center text-green-600 mb-3">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="text-sm font-semibold" data-i18n="settings.sec.totp_enabled">ä¸¤æ­¥éªŒè¯å·²å¯ç”¨</span>
                        </div>
                        <button type="button" onclick="showDisableTOTPModal()" class="w-full bg-gray-50 text-gray-600 border border-gray-200 font-bold py-2 rounded-lg hover:bg-gray-100 transition text-sm">
                            <span data-i18n="settings.sec.totp_disable_btn">å…³é—­ä¸¤æ­¥éªŒè¯</span>
                        </button>
                    </div>

                    <!-- è®¾ç½®äºŒç»´ç ï¼ˆå¼¹çª—æ¨¡å¼ï¼‰ -->
                    <div id="totp-setup-section" class="hidden mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <p class="text-sm text-indigo-700 font-semibold mb-3" data-i18n="settings.sec.totp_scan">è¯·ä½¿ç”¨éªŒè¯å™¨ App æ‰«æäºŒç»´ç ï¼š</p>
                        <div class="flex justify-center mb-3">
                            <img id="totp-qrcode" src="" alt="TOTP QR Code" class="w-48 h-48 border border-indigo-300 rounded-lg bg-white p-2">
                        </div>
                        <p class="text-xs text-indigo-600 mb-2" data-i18n="settings.sec.totp_manual">æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥ï¼š</p>
                        <div class="flex items-center mb-4">
                            <code id="totp-secret" class="flex-1 bg-white px-3 py-2 rounded border border-indigo-200 text-xs font-mono text-indigo-800 select-all"></code>
                            <button type="button" onclick="copyTOTPSecret()" class="ml-2 p-2 bg-white border border-indigo-200 rounded hover:bg-indigo-100 transition">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="totp-verify-code" maxlength="6" pattern="[0-9]{6}" data-i18n-attr="placeholder:settings.sec.totp_code_ph" placeholder="è¾“å…¥ 6 ä½éªŒè¯ç " class="flex-1 border border-indigo-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 text-sm text-center font-mono tracking-widest">
                            <button type="button" onclick="enableTOTP()" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition text-sm">
                                <span data-i18n="settings.sec.totp_confirm">ç¡®è®¤å¯ç”¨</span>
                            </button>
                        </div>
                        <button type="button" onclick="cancelTOTPSetup()" class="w-full mt-3 text-xs text-gray-500 hover:text-gray-700">
                            <span data-i18n="settings.sec.totp_cancel">å–æ¶ˆ</span>
                        </button>
                    </div>

                    <p class="text-xs text-gray-400 mt-3" data-i18n="settings.sec.totp_reset_hint">å¿˜è®°éªŒè¯å™¨ï¼Ÿè¯·åœ¨æœåŠ¡å™¨æ‰§è¡Œ ./goemail -reset-totp</p>
                </div>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3" data-i18n="settings.sec.jwt_title">ç™»å½•å¯†é’¥ (JWT Secret)</h4>
                <p class="text-xs text-gray-500 mb-4 leading-relaxed" data-i18n="settings.sec.jwt_desc">
                    é‡ç½®å¯†é’¥å°†å¯¼è‡´æ‰€æœ‰å·²ç™»å½•ç”¨æˆ·ï¼ˆåŒ…æ‹¬API Tokenï¼‰ç«‹å³å¤±æ•ˆï¼Œéœ€é‡æ–°ç™»å½•ã€‚ä»…åœ¨æ€€ç–‘å¯†é’¥æ³„éœ²æ—¶ä½¿ç”¨ã€‚
                </p>
                <button type="button" onclick="resetSecret()" class="w-full bg-red-50 text-red-600 border border-red-200 font-bold py-2 rounded-lg hover:bg-red-100 transition text-sm flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <span data-i18n="settings.sec.jwt_btn">é‡ç½®å¹¶å¼ºåˆ¶ä¸‹çº¿</span>
                </button>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ›´æ–° -->
        <div id="update-section" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 transition-all duration-300">
            <h3 class="font-bold text-lg text-gray-800 mb-6 flex items-center">
                <span class="bg-cyan-100 text-cyan-600 p-1.5 rounded-lg mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </span>
                <span data-i18n="settings.update.title">ç³»ç»Ÿæ›´æ–°</span>
            </h3>

            <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-5">
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex justify-between">
                        <span data-i18n="settings.update.current_ver">å½“å‰ç‰ˆæœ¬:</span>
                        <span id="update-current-ver" class="font-mono font-medium text-gray-700">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span data-i18n="settings.update.latest_ver">æœ€æ–°ç‰ˆæœ¬:</span>
                        <span id="update-latest-ver" class="font-mono font-medium text-gray-700">-</span>
                    </div>
                    <div class="flex justify-between col-span-2">
                        <span data-i18n="settings.update.platform">è¿è¡Œå¹³å°:</span>
                        <span id="update-platform" class="font-mono font-medium text-gray-500">-</span>
                    </div>
                </div>
            </div>

            <!-- æ›´æ–°çŠ¶æ€ -->
            <div id="update-status-box" class="hidden mb-5">
                <div class="flex items-center mb-2">
                    <div id="update-status-icon" class="w-5 h-5 mr-2">
                        <!-- åŠ¨æ€å›¾æ ‡ -->
                    </div>
                    <span id="update-status-text" class="text-sm font-medium text-gray-700">å‡†å¤‡ä¸­...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="update-progress-bar" class="bg-cyan-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- æ›´æ–°æ—¥å¿— (æŠ˜å ) -->
            <div id="update-release-notes" class="hidden mb-5">
                <button type="button" onclick="toggleReleaseNotes()" class="flex items-center text-sm text-gray-600 hover:text-gray-800 mb-2">
                    <svg id="release-notes-icon" class="w-4 h-4 mr-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    <span data-i18n="settings.update.release_notes">æ›´æ–°æ—¥å¿—</span>
                </button>
                <div id="release-notes-content" class="hidden bg-gray-50 p-3 rounded-lg border border-gray-200 text-xs text-gray-600 max-h-40 overflow-y-auto whitespace-pre-wrap"></div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="space-y-3">
                <button type="button" onclick="checkForUpdate()" id="btn-check-update" class="w-full font-bold py-2.5 rounded-lg transition shadow-md flex items-center justify-center" style="background-color: #0891b2; color: white;">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span data-i18n="settings.update.check_btn">æ£€æŸ¥æ›´æ–°</span>
                </button>
                <button type="button" onclick="performUpdate()" id="btn-perform-update" disabled class="w-full bg-gray-100 text-gray-400 font-bold py-2.5 rounded-lg transition flex items-center justify-center cursor-not-allowed">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span data-i18n="settings.update.download_btn">ä¸‹è½½å¹¶å®‰è£…</span>
                </button>
            </div>

            <!-- è‡ªåŠ¨æ›´æ–°è®¾ç½® -->
            <div class="border-t border-gray-200 mt-5 pt-5">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-sm font-medium text-gray-700" data-i18n="settings.update.auto_title">è‡ªåŠ¨æ›´æ–°</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer" onclick="toggleAutoUpdate()">
                        <input type="checkbox" id="auto-update-toggle" class="sr-only">
                        <div id="auto-update-toggle-track" class="w-11 h-6 rounded-full transition-colors duration-200" style="background-color: #d1d5db;">
                            <div id="auto-update-toggle-thumb" class="absolute top-[2px] left-[2px] bg-white border border-gray-300 rounded-full h-5 w-5 transition-transform duration-200"></div>
                        </div>
                    </label>
                </div>
                <div id="auto-update-settings" class="hidden space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600" data-i18n="settings.update.auto_interval">æ£€æŸ¥é—´éš”:</span>
                        <select id="auto-update-interval" onchange="saveAutoUpdateConfig()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-cyan-500 outline-none">
                            <option value="6">æ¯ 6 å°æ—¶</option>
                            <option value="12">æ¯ 12 å°æ—¶</option>
                            <option value="24" selected>æ¯å¤©</option>
                            <option value="168">æ¯å‘¨</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600" data-i18n="settings.update.auto_time">æ›´æ–°æ—¶é—´:</span>
                        <input type="time" id="auto-update-time" value="03:00" onchange="saveAutoUpdateConfig()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-cyan-500 outline-none">
                    </div>
                    <p class="text-xs text-gray-400" data-i18n="settings.update.auto_hint">ç³»ç»Ÿå°†åœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨æ£€æŸ¥å¹¶å®‰è£…æ›´æ–°ï¼Œæ›´æ–°åä¼šè‡ªåŠ¨é‡å¯æœåŠ¡ã€‚</p>
                </div>
            </div>

            <!-- å¤‡ä»½ç®¡ç† -->
            <div class="border-t border-gray-200 mt-5 pt-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        <span class="text-sm font-medium text-gray-700" data-i18n="settings.backup.title">å¤‡ä»½ç®¡ç†</span>
                    </div>
                    <button type="button" onclick="createManualBackup()" id="btn-create-backup" class="text-xs px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span data-i18n="settings.backup.create">æ‰‹åŠ¨å¤‡ä»½</span>
                    </button>
                </div>
                <div id="backup-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <div class="text-center text-gray-400 text-sm py-4" data-i18n="settings.backup.loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <p class="text-xs text-gray-400 mt-4" data-i18n="settings.update.hint">
                ç³»ç»Ÿä¼šåœ¨æ›´æ–°å‰è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºå¤‡ä»½æˆ–æ¢å¤åˆ°å†å²ç‰ˆæœ¬ã€‚
            </p>
        </div>

    </div>

    <script>
        Auth.check();

        // ç¼“å­˜é…ç½®ä¸åŸŸåæ˜ å°„
        let currentConfig = {};
        let domainMap = {};

        async function loadDomains() {
            try {
                const list = await request('/domains');
                const select = document.getElementById('domain-select');
                select.innerHTML = `<option value="">${I18n.t('settings.js.select_ph')}</option>`;
                
                list.forEach(d => {
                    domainMap[d.name] = d;
                    const opt = document.createElement('option');
                    opt.value = d.name;
                    opt.text = d.name;
                    select.appendChild(opt);
                });
                
                // å¦‚æœå½“å‰é…ç½®çš„åŸŸååœ¨åˆ—è¡¨ä¸­ï¼Œé€‰ä¸­å®ƒ
                if (currentConfig.domain && domainMap[currentConfig.domain]) {
                    select.value = currentConfig.domain;
                } else if (currentConfig.domain) {
                    // å¦‚æœä¸åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼
                    document.getElementById('domain-input').value = currentConfig.domain;
                    toggleDomainInput(true);
                }
            } catch(e) {}
        }

        function onSelectChange() {
            const val = document.getElementById('domain-select').value;
            if (val && domainMap[val]) {
                document.getElementById('dkim_selector').value = domainMap[val].dkim_selector || 'default';
            }
        }

        function toggleDomainInput(showInput) {
            if (showInput) {
                document.getElementById('domain-select-mode').classList.add('hidden');
                document.getElementById('domain-input-mode').classList.remove('hidden');
                // å‡å¦‚ä»ä¸‹æ‹‰åˆ‡æ¢è¿‡æ¥ï¼ŒæŠŠä¸‹æ‹‰çš„å€¼èµ‹ç»™è¾“å…¥æ¡†
                const selVal = document.getElementById('domain-select').value;
                if(selVal) document.getElementById('domain-input').value = selVal;
            } else {
                document.getElementById('domain-select-mode').classList.remove('hidden');
                document.getElementById('domain-input-mode').classList.add('hidden');
            }
        }

        // è·å–æœ€ç»ˆçš„åŸŸåå€¼
        function getDomainValue() {
            if (!document.getElementById('domain-input-mode').classList.contains('hidden')) {
                return document.getElementById('domain-input').value;
            }
            return document.getElementById('domain-select').value;
        }

        function toggleSSL() {
            const enabled = document.getElementById('enable_ssl').checked;
            const div = document.getElementById('ssl-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        }

        function toggleReceiver() {
            const enabled = document.getElementById('enable_receiver').checked;
            const div = document.getElementById('receiver-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
            }
        }

        function toggleReceiverTLS() {
            const enabled = document.getElementById('receiver_tls').checked;
            const div = document.getElementById('receiver-tls-config');
            if (enabled) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
                // å…³é—­ TLS æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆå¼ºåˆ¶ TLS
                document.getElementById('receiver_require_tls').checked = false;
            }
        }

        async function loadConfig() {
            try {
                const cfg = await request('/config'); // GET
                currentConfig = cfg;
                
                // å…ˆåŠ è½½åŸŸååˆ—è¡¨ï¼Œå¹¶æ ¹æ® cfg è®¾ç½®é€‰ä¸­çŠ¶æ€
                await loadDomains();

                // åŸºç¡€é…ç½®
                // domain å·²åœ¨ loadDomains ä¸­å¤„ç†
                document.getElementById('dkim_selector').value = cfg.dkim_selector || 'default';

                // Webé…ç½®
                document.getElementById('host').value = cfg.host || '0.0.0.0';
                document.getElementById('port').value = cfg.port || '9901';
                document.getElementById('base_url').value = cfg.base_url || ''; // åŠ è½½ BaseURL
                document.getElementById('enable_ssl').checked = cfg.enable_ssl || false;
                document.getElementById('cert_file').value = cfg.cert_file || '';
                document.getElementById('key_file').value = cfg.key_file || '';
                
                // æ¥æ”¶æœåŠ¡é…ç½®
                document.getElementById('enable_receiver').checked = cfg.enable_receiver || false;
                document.getElementById('receiver_port').value = cfg.receiver_port || '25';
                document.getElementById('receiver_tls').checked = cfg.receiver_tls || false;
                document.getElementById('receiver_tls_cert').value = cfg.receiver_tls_cert || '';
                document.getElementById('receiver_tls_key').value = cfg.receiver_tls_key || '';
                document.getElementById('receiver_rate_limit').value = cfg.receiver_rate_limit || 30;
                document.getElementById('receiver_max_msg_size').value = cfg.receiver_max_msg_size || 10240;
                document.getElementById('receiver_blacklist').value = cfg.receiver_blacklist || '';
                document.getElementById('receiver_require_tls').checked = cfg.receiver_require_tls || false;
                
                toggleSSL();
                toggleReceiver();
                toggleReceiverTLS();
            } catch (e) {}
        }

        async function saveConfig(e, type) {
            e.preventDefault();
            
            // å®šä¹‰æ•æ„Ÿå­—æ®µåˆ—è¡¨ (è¿™äº›å­—æ®µåç«¯è¿”å›æ©ç å€¼ï¼Œä¸åº”å›ä¼ )
            const sensitiveFields = ['jwt_secret', 'dkim_private_key'];
            
            // ä» currentConfig ä¸­æ’é™¤æ•æ„Ÿå­—æ®µååˆå¹¶
            const safeCurrentConfig = Object.fromEntries(
                Object.entries(currentConfig).filter(([key]) => !sensitiveFields.includes(key))
            );
            
            // åˆå¹¶é…ç½® (æ’é™¤æ•æ„Ÿå­—æ®µåçš„åŸºç¡€é…ç½® + è¡¨å•è¾“å…¥å€¼)
            const newConfig = {
                ...safeCurrentConfig,
                domain: getDomainValue(),
                dkim_selector: document.getElementById('dkim_selector').value,
                host: document.getElementById('host').value,
                port: document.getElementById('port').value,
                base_url: document.getElementById('base_url').value,
                enable_ssl: document.getElementById('enable_ssl').checked,
                cert_file: document.getElementById('cert_file').value,
                key_file: document.getElementById('key_file').value,
                enable_receiver: document.getElementById('enable_receiver').checked,
                receiver_port: document.getElementById('receiver_port').value,
                receiver_tls: document.getElementById('receiver_tls').checked,
                receiver_tls_cert: document.getElementById('receiver_tls_cert').value,
                receiver_tls_key: document.getElementById('receiver_tls_key').value,
                receiver_rate_limit: parseInt(document.getElementById('receiver_rate_limit').value) || 30,
                receiver_max_msg_size: parseInt(document.getElementById('receiver_max_msg_size').value) || 10240,
                receiver_blacklist: document.getElementById('receiver_blacklist').value,
                receiver_require_tls: document.getElementById('receiver_require_tls').checked
            };
            
            // äºŒæ¬¡å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ²¡æœ‰æ•æ„Ÿå­—æ®µçš„æ©ç å€¼è¢«å‘é€
            // (é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œé˜²æ­¢æœªæ¥ä»£ç å˜æ›´å¼•å…¥é—®é¢˜)
            sensitiveFields.forEach(field => {
                if (newConfig[field] && (
                    String(newConfig[field]).includes('***') || 
                    String(newConfig[field]).includes('Hidden')
                )) {
                    delete newConfig[field];
                }
            });

            try {
                await request('/config', { method: 'POST', body: JSON.stringify(newConfig) });
                
                // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (type === 'business') {
                    showToast(I18n.t('settings.toast.biz_updated'));
                } else if (type === 'web') {
                    showToast(I18n.t('settings.toast.web_updated'), 'info');
                } else if (type === 'receiver') {
                    showToast(I18n.t('settings.toast.recv_updated'), 'info');
                } else {
                    showToast(I18n.t('settings.toast.saved'));
                }
            } catch (e) {
                // request å·²ç»å¤„ç†äº† error toast
                if (e.data && e.data.pid) {
                    setTimeout(async () => {
                        const confirmed = await Modal.confirm(
                            I18n.t('settings.modal.port_conflict') || 'ç«¯å£å†²çª',
                            e.message + "\n\n" + I18n.t('settings.alert.kill_confirm'),
                            { type: 'warning', confirmText: I18n.t('settings.modal.kill_btn') || 'ç»ˆæ­¢è¿›ç¨‹', confirmClass: 'bg-red-600 text-white hover:bg-red-700' }
                        );
                        if (confirmed) {
                            await killProcess(e.data.pid);
                        }
                    }, 500);
                }
            }
        }

        async function resetSecret() {
            const confirmed = await Modal.confirm(
                I18n.t('settings.modal.reset_jwt_title') || 'é‡ç½® JWT å¯†é’¥',
                I18n.t('settings.alert.jwt_confirm'),
                { type: 'danger', confirmText: I18n.t('settings.modal.reset_btn') || 'ç¡®è®¤é‡ç½®', confirmClass: 'bg-red-600 text-white hover:bg-red-700' }
            );
            if (!confirmed) return;
            
            // å¤ç”¨ä¿å­˜é€»è¾‘ï¼Œä½†è®¾ç½®ç‰¹æ®Šæ ‡è®°
            const newConfig = { ...currentConfig, jwt_secret: 'RESET' };
            try {
                await request('/config', { method: 'POST', body: JSON.stringify(newConfig) });
                showToast(I18n.t('settings.toast.jwt_reset'));
                setTimeout(() => Auth.logout(), 2000);
            } catch (e) {}
        }

        async function downloadBackup() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch('/api/v1/backup', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "goemail-backup.zip";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    showToast(I18n.t('settings.toast.backup_start'));
                } else {
                    showToast(I18n.t('settings.toast.backup_fail'), 'error');
                }
            } catch(e) {
                showToast(I18n.t('settings.toast.net_fail'), 'error');
            }
        }

        async function changePassword(e) {
            e.preventDefault();
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;

            try {
                await request('/password', { 
                    method: 'POST', 
                    body: JSON.stringify({ old_password: oldPass, new_password: newPass }) 
                });
                showToast(I18n.t('settings.toast.pwd_changed'));
                setTimeout(() => Auth.logout(), 1500);
            } catch (e) {}
        }

        async function testPort() {
            const port = document.getElementById('receiver_port').value;
            if (!port) return;
            
            const btn = event.target;
            const originalText = btn.innerText;
            
            try {
                btn.innerText = 'Testing...';
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');

                const res = await request('/config/test-port', {
                    method: 'POST',
                    body: JSON.stringify({ port: port })
                });
                
                if (res.success) {
                    showToast(res.message, 'success');
                } else {
                    showToast(res.message, 'error');
                    // å¦‚æœè¿”å›äº† PIDï¼Œè¯¢é—®æ˜¯å¦å…³é—­
                    if (res.pid) {
                        const confirmed = await Modal.confirm(
                            I18n.t('settings.modal.port_conflict') || 'ç«¯å£å†²çª',
                            res.message + "\n\n" + I18n.t('settings.alert.kill_confirm'),
                            { type: 'warning', confirmText: I18n.t('settings.modal.kill_btn') || 'ç»ˆæ­¢è¿›ç¨‹', confirmClass: 'bg-red-600 text-white hover:bg-red-700' }
                        );
                        if (confirmed) {
                            await killProcess(res.pid);
                        }
                    }
                }
            } catch (e) {
                // request handles error toast
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function killProcess(pid) {
            try {
                const res = await request('/config/kill-process', {
                    method: 'POST',
                    body: JSON.stringify({ pid: pid })
                });
                showToast(res.message, 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        loadConfig();
        loadCleanupData();
        loadTOTPStatus();

        // --- ä¸¤æ­¥éªŒè¯ (TOTP) ç›¸å…³å‡½æ•° ---
        async function loadTOTPStatus() {
            try {
                const res = await request('/totp/status');
                if (res.enabled) {
                    document.getElementById('totp-disabled-section').classList.add('hidden');
                    document.getElementById('totp-enabled-section').classList.remove('hidden');
                } else {
                    document.getElementById('totp-disabled-section').classList.remove('hidden');
                    document.getElementById('totp-enabled-section').classList.add('hidden');
                }
            } catch (e) {
                console.error('åŠ è½½ TOTP çŠ¶æ€å¤±è´¥:', e);
            }
        }

        async function setupTOTP() {
            try {
                const res = await request('/totp/setup');
                document.getElementById('totp-qrcode').src = res.qr_code;
                document.getElementById('totp-secret').textContent = res.secret;
                document.getElementById('totp-disabled-section').classList.add('hidden');
                document.getElementById('totp-setup-section').classList.remove('hidden');
                document.getElementById('totp-verify-code').value = '';
                document.getElementById('totp-verify-code').focus();
            } catch (e) {
                showToast(e.message || 'è·å–äºŒç»´ç å¤±è´¥', 'error');
            }
        }

        function cancelTOTPSetup() {
            document.getElementById('totp-setup-section').classList.add('hidden');
            document.getElementById('totp-disabled-section').classList.remove('hidden');
        }

        function copyTOTPSecret() {
            const secret = document.getElementById('totp-secret').textContent;
            navigator.clipboard.writeText(secret).then(() => {
                showToast(I18n.t('settings.toast.copied') || 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        async function enableTOTP() {
            const code = document.getElementById('totp-verify-code').value.trim();
            if (!code || code.length !== 6) {
                showToast(I18n.t('settings.sec.totp_invalid_code') || 'è¯·è¾“å…¥ 6 ä½éªŒè¯ç ', 'error');
                return;
            }

            try {
                await request('/totp/enable', {
                    method: 'POST',
                    body: JSON.stringify({ code: code })
                });
                showToast(I18n.t('settings.toast.totp_enabled') || 'ä¸¤æ­¥éªŒè¯å·²å¯ç”¨');
                document.getElementById('totp-setup-section').classList.add('hidden');
                document.getElementById('totp-enabled-section').classList.remove('hidden');
            } catch (e) {
                showToast(e.message || 'éªŒè¯ç é”™è¯¯', 'error');
                document.getElementById('totp-verify-code').value = '';
                document.getElementById('totp-verify-code').focus();
            }
        }

        function showDisableTOTPModal() {
            const pwd = prompt(I18n.t('settings.sec.totp_disable_prompt') || 'è¯·è¾“å…¥å¯†ç ä»¥å…³é—­ä¸¤æ­¥éªŒè¯ï¼š');
            if (pwd) {
                disableTOTP(pwd);
            }
        }

        async function disableTOTP(password) {
            try {
                await request('/totp/disable', {
                    method: 'POST',
                    body: JSON.stringify({ password: password })
                });
                showToast(I18n.t('settings.toast.totp_disabled') || 'ä¸¤æ­¥éªŒè¯å·²å…³é—­');
                document.getElementById('totp-enabled-section').classList.add('hidden');
                document.getElementById('totp-disabled-section').classList.remove('hidden');
            } catch (e) {
                showToast(e.message || 'å¯†ç é”™è¯¯', 'error');
            }
        }

        // --- æ•°æ®æ¸…ç†ç›¸å…³å‡½æ•° ---
        async function loadCleanupData() {
            try {
                // å¹¶è¡ŒåŠ è½½ç»Ÿè®¡å’Œé…ç½®
                const [stats, cfg] = await Promise.all([
                    request('/cleanup/stats'),
                    request('/cleanup/config')
                ]);

                // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                document.getElementById('stat-email-logs').textContent = stats.email_logs.toLocaleString();
                document.getElementById('stat-inbox').textContent = stats.inbox_items.toLocaleString();
                document.getElementById('stat-queue').textContent = stats.queue_items.toLocaleString();
                document.getElementById('stat-forward').textContent = stats.forward_logs.toLocaleString();
                document.getElementById('stat-attach').textContent = stats.attachments.toLocaleString();
                document.getElementById('stat-size').textContent = formatSize(stats.total_size);

                // å¡«å……é…ç½®è¡¨å•
                document.getElementById('cleanup_enabled').checked = cfg.cleanup_enabled || false;
                document.getElementById('cleanup_email_log_days').value = cfg.cleanup_email_log_days || 30;
                document.getElementById('cleanup_inbox_days').value = cfg.cleanup_inbox_days || 30;
                document.getElementById('cleanup_queue_days').value = cfg.cleanup_queue_days || 7;
                document.getElementById('cleanup_forward_days').value = cfg.cleanup_forward_days || 30;
                document.getElementById('cleanup_attach_days').value = cfg.cleanup_attach_days || 30;
            } catch (e) {
                console.error('åŠ è½½æ¸…ç†æ•°æ®å¤±è´¥:', e);
            }
        }

        async function saveCleanupConfig(e) {
            e.preventDefault();
            
            const cfg = {
                cleanup_enabled: document.getElementById('cleanup_enabled').checked,
                cleanup_email_log_days: parseInt(document.getElementById('cleanup_email_log_days').value) || 30,
                cleanup_inbox_days: parseInt(document.getElementById('cleanup_inbox_days').value) || 30,
                cleanup_queue_days: parseInt(document.getElementById('cleanup_queue_days').value) || 7,
                cleanup_forward_days: parseInt(document.getElementById('cleanup_forward_days').value) || 30,
                cleanup_attach_days: parseInt(document.getElementById('cleanup_attach_days').value) || 30
            };

            try {
                await request('/cleanup/config', { method: 'PUT', body: JSON.stringify(cfg) });
                showToast(I18n.t('settings.toast.cleanup_saved') || 'æ¸…ç†é…ç½®å·²ä¿å­˜');
            } catch (e) {
                // request å·²å¤„ç†é”™è¯¯
            }
        }

        async function runCleanup() {
            const confirmMsg = I18n.t('settings.alert.cleanup_confirm') || 'ç¡®å®šè¦ç«‹å³æ‰§è¡Œæ•°æ®æ¸…ç†å—ï¼Ÿè¿™å°†åˆ é™¤è¶…è¿‡ä¿ç•™æœŸé™çš„å†å²æ•°æ®ã€‚';
            const confirmed = await Modal.confirm(
                I18n.t('settings.modal.cleanup_title') || 'æ•°æ®æ¸…ç†',
                confirmMsg,
                { type: 'warning', confirmText: I18n.t('settings.modal.cleanup_btn') || 'ç«‹å³æ¸…ç†', confirmClass: 'bg-orange-600 text-white hover:bg-orange-700' }
            );
            if (!confirmed) return;

            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${I18n.t('settings.cleanup.running') || 'æ¸…ç†ä¸­...'}</span>`;

                const res = await request('/cleanup/run', { method: 'POST' });

                // æ˜¾ç¤ºæ¸…ç†ç»“æœ
                const msg = `${I18n.t('settings.toast.cleanup_done') || 'æ¸…ç†å®Œæˆ'}\n` +
                    `- ${I18n.t('settings.cleanup.email_logs') || 'å‘é€æ—¥å¿—'}: ${res.email_logs}\n` +
                    `- ${I18n.t('settings.cleanup.inbox') || 'æ”¶ä»¶ç®±'}: ${res.inbox_items}\n` +
                    `- ${I18n.t('settings.cleanup.queue') || 'é˜Ÿåˆ—è®°å½•'}: ${res.queue_items}\n` +
                    `- ${I18n.t('settings.cleanup.forward') || 'è½¬å‘æ—¥å¿—'}: ${res.forward_logs}\n` +
                    `- ${I18n.t('settings.cleanup.attach') || 'é™„ä»¶æ–‡ä»¶'}: ${res.attachments}\n` +
                    `- ${I18n.t('settings.cleanup.freed') || 'é‡Šæ”¾ç©ºé—´'}: ${formatSize(res.freed_bytes)}\n` +
                    `- ${I18n.t('settings.cleanup.duration') || 'è€—æ—¶'}: ${res.duration_ms}ms`;

                showToast(I18n.t('settings.toast.cleanup_done') || 'æ¸…ç†å®Œæˆ', 'success');
                await Modal.alert(
                    I18n.t('settings.modal.cleanup_result') || 'æ¸…ç†ç»“æœ',
                    msg,
                    { type: 'success' }
                );

                // é‡æ–°åŠ è½½ç»Ÿè®¡
                loadCleanupData();
            } catch (e) {
                // request å·²å¤„ç†é”™è¯¯
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- ç³»ç»Ÿæ›´æ–°ç›¸å…³å‡½æ•° ---
        let updateInfo = null;
        let updatePolling = null;

        async function loadUpdateInfo() {
            try {
                const ver = await request('/config/version');
                document.getElementById('update-current-ver').textContent = ver.version || '-';
            } catch (e) {
                console.error('åŠ è½½ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:', e);
            }
        }

        // è‡ªå®šä¹‰æ›´æ–°ç¡®è®¤å¼¹çª—ï¼ˆå¸¦æ›´æ–°æ—¥å¿—ï¼‰
        function showUpdateConfirmModal(info) {
            return new Promise((resolve) => {
                const modalId = 'update-confirm-modal';
                let modal = document.getElementById(modalId);
                if (modal) modal.remove();

                // æ ¼å¼åŒ–æ›´æ–°æ—¥å¿—ï¼ˆç®€å•çš„ Markdown è½¬æ¢ï¼‰
                let releaseNotes = info.release_notes || 'æš‚æ— æ›´æ–°æ—¥å¿—';
                // è½¬æ¢åŸºæœ¬ Markdown æ ¼å¼
                releaseNotes = releaseNotes
                    .replace(/^### (.+)$/gm, '<h4 class="font-bold text-gray-800 mt-3 mb-1">$1</h4>')
                    .replace(/^## (.+)$/gm, '<h3 class="font-bold text-gray-900 mt-4 mb-2 text-base">$1</h3>')
                    .replace(/^# (.+)$/gm, '<h2 class="font-bold text-gray-900 mt-4 mb-2 text-lg">$1</h2>')
                    .replace(/^\* (.+)$/gm, '<li class="ml-4 text-gray-600">â€¢ $1</li>')
                    .replace(/^- (.+)$/gm, '<li class="ml-4 text-gray-600">â€¢ $1</li>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/`(.+?)`/g, '<code class="bg-gray-100 px-1 rounded text-sm">$1</code>')
                    .replace(/\n\n/g, '<br/><br/>')
                    .replace(/\n/g, '<br/>');

                // æ ¼å¼åŒ–å‘å¸ƒæ—¶é—´
                let publishTime = '-';
                if (info.published_at) {
                    try {
                        publishTime = new Date(info.published_at).toLocaleString();
                    } catch(e) {}
                }

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                let fileSize = '-';
                if (info.download_size > 0) {
                    fileSize = (info.download_size / 1024 / 1024).toFixed(2) + ' MB';
                }

                const modalHTML = `
                    <div id="${modalId}" class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden">
                            <!-- å¤´éƒ¨ -->
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 px-6 py-5 text-white">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mr-4">
                                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold">${I18n.t('settings.modal.update_available_title') || 'å‘ç°æ–°ç‰ˆæœ¬'}</h3>
                                        <p class="text-white/80 text-sm mt-0.5">${info.current_version} â†’ <span class="font-bold">${info.latest_version}</span></p>
                                    </div>
                                </div>
                            </div>

                            <!-- å†…å®¹åŒº -->
                            <div class="px-6 py-5">
                                <!-- ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡ -->
                                <div class="bg-gray-50 rounded-xl p-4 mb-4 grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <span class="text-gray-400">${I18n.t('settings.update.publish_time') || 'å‘å¸ƒæ—¶é—´'}:</span>
                                        <span class="text-gray-700 ml-1">${publishTime}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">${I18n.t('settings.update.file_size') || 'æ–‡ä»¶å¤§å°'}:</span>
                                        <span class="text-gray-700 ml-1">${fileSize}</span>
                                    </div>
                                    <div class="col-span-2">
                                        <span class="text-gray-400">${I18n.t('settings.update.platform') || 'ç›®æ ‡å¹³å°'}:</span>
                                        <span class="text-gray-700 ml-1">${info.platform || '-'}</span>
                                    </div>
                                </div>

                                <!-- æ›´æ–°æ—¥å¿— -->
                                <div class="mb-4">
                                    <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                                        <svg class="w-4 h-4 mr-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        ${I18n.t('settings.update.release_notes') || 'æ›´æ–°æ—¥å¿—'}
                                    </h4>
                                    <div class="bg-gray-50 rounded-lg p-4 max-h-48 overflow-y-auto text-sm leading-relaxed border border-gray-100">
                                        ${releaseNotes}
                                    </div>
                                </div>

                                <!-- æç¤ºä¿¡æ¯ -->
                                <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 text-sm text-blue-700 flex items-start">
                                    <svg class="w-5 h-5 mr-2 flex-shrink-0 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>${I18n.t('settings.modal.update_hint') || 'ç³»ç»Ÿå°†è‡ªåŠ¨å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼Œæ›´æ–°å®Œæˆåå¯é€‰æ‹©ç«‹å³é‡å¯ã€‚'}</span>
                                </div>
                            </div>

                            <!-- åº•éƒ¨æŒ‰é’® -->
                            <div class="px-6 py-4 bg-gray-50 border-t flex justify-end space-x-3">
                                <button id="${modalId}-cancel" class="px-5 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition font-medium">
                                    ${I18n.t('common.cancel') || 'å–æ¶ˆ'}
                                </button>
                                <button id="${modalId}-confirm" class="px-5 py-2.5 text-white rounded-lg shadow-md transition font-medium flex items-center" style="background-color: #10b981;">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    ${I18n.t('settings.modal.update_btn') || 'å¼€å§‹æ›´æ–°'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById(modalId);

                // ç»‘å®šäº‹ä»¶
                document.getElementById(`${modalId}-cancel`).onclick = () => { modal.remove(); resolve(false); };
                document.getElementById(`${modalId}-confirm`).onclick = () => { modal.remove(); resolve(true); };
                document.getElementById(`${modalId}-confirm`).onmouseenter = function() { this.style.backgroundColor = '#059669'; };
                document.getElementById(`${modalId}-confirm`).onmouseleave = function() { this.style.backgroundColor = '#10b981'; };

                // ESC å…³é—­
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', escHandler);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', escHandler);
            });
        }

        async function checkForUpdate() {
            const btn = document.getElementById('btn-check-update');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${I18n.t('settings.update.checking') || 'æ£€æŸ¥ä¸­...'}</span>`;

                updateInfo = await request('/config/update-info');

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('update-current-ver').textContent = updateInfo.current_version || '-';
                document.getElementById('update-latest-ver').textContent = updateInfo.latest_version || '-';
                document.getElementById('update-platform').textContent = updateInfo.platform || '-';

                const latestEl = document.getElementById('update-latest-ver');
                const updateBtn = document.getElementById('btn-perform-update');

                if (updateInfo.has_update) {
                    latestEl.classList.remove('text-gray-700');
                    latestEl.classList.add('text-green-600');
                    
                    // å¯ç”¨æ›´æ–°æŒ‰é’®
                    updateBtn.disabled = false;
                    updateBtn.classList.remove('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                    updateBtn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');

                    // æ˜¾ç¤ºæ›´æ–°æ—¥å¿—
                    if (updateInfo.release_notes) {
                        document.getElementById('update-release-notes').classList.remove('hidden');
                        document.getElementById('release-notes-content').textContent = updateInfo.release_notes;
                    }

                    showToast(I18n.t('settings.toast.update_available') || `å‘ç°æ–°ç‰ˆæœ¬: ${updateInfo.latest_version}`, 'success');
                } else {
                    latestEl.classList.remove('text-green-600');
                    latestEl.classList.add('text-gray-700');
                    updateBtn.disabled = true;
                    updateBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700');
                    updateBtn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                    document.getElementById('update-release-notes').classList.add('hidden');

                    showToast(I18n.t('settings.toast.already_latest') || 'å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
                }

            } catch (e) {
                showToast(I18n.t('settings.toast.check_failed') || 'æ£€æŸ¥æ›´æ–°å¤±è´¥', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function toggleReleaseNotes() {
            const content = document.getElementById('release-notes-content');
            const icon = document.getElementById('release-notes-icon');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-90');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-90');
            }
        }

        async function performUpdate() {
            if (!updateInfo || !updateInfo.download_url) {
                showToast(I18n.t('settings.toast.no_update_info') || 'è¯·å…ˆæ£€æŸ¥æ›´æ–°', 'error');
                return;
            }

            // ä½¿ç”¨è‡ªå®šä¹‰æ›´æ–°ç¡®è®¤å¼¹çª—ï¼ˆå¸¦æ›´æ–°æ—¥å¿—ï¼‰
            const confirmed = await showUpdateConfirmModal(updateInfo);
            if (!confirmed) return;

            const checkBtn = document.getElementById('btn-check-update');
            const updateBtn = document.getElementById('btn-perform-update');

            try {
                checkBtn.disabled = true;
                updateBtn.disabled = true;
                updateBtn.innerHTML = `<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${I18n.t('settings.update.updating') || 'æ›´æ–°ä¸­...'}</span>`;

                // æ˜¾ç¤ºçŠ¶æ€æ¡†
                document.getElementById('update-status-box').classList.remove('hidden');

                // å‘èµ·æ›´æ–°è¯·æ±‚
                await request('/config/update', {
                    method: 'POST',
                    body: JSON.stringify({
                        download_url: updateInfo.download_url,
                        file_name: updateInfo.file_name
                    })
                });

                // å¼€å§‹è½®è¯¢çŠ¶æ€
                startUpdatePolling();

            } catch (e) {
                showToast(I18n.t('settings.toast.update_failed') || 'æ›´æ–°å¤±è´¥', 'error');
                checkBtn.disabled = false;
                resetUpdateButton();
            }
        }

        function startUpdatePolling() {
            if (updatePolling) clearInterval(updatePolling);
            
            updatePolling = setInterval(async () => {
                try {
                    const status = await request('/config/update-status');
                    updateStatusUI(status);

                    if (status.status === 'completed' || status.status === 'failed') {
                        clearInterval(updatePolling);
                        updatePolling = null;
                        document.getElementById('btn-check-update').disabled = false;

                        if (status.status === 'completed') {
                            showToast(I18n.t('settings.toast.update_success') || 'æ›´æ–°æˆåŠŸï¼', 'success');
                            showUpdateCompleteModal();
                        } else if (status.status === 'failed') {
                            showUpdateFailedModal(status.error);
                        }
                        resetUpdateButton();
                    }
                } catch (e) {
                    console.error('è·å–æ›´æ–°çŠ¶æ€å¤±è´¥:', e);
                }
            }, 1000);
        }

        function updateStatusUI(status) {
            const statusText = document.getElementById('update-status-text');
            const progressBar = document.getElementById('update-progress-bar');
            const statusIcon = document.getElementById('update-status-icon');

            statusText.textContent = status.message || 'å¤„ç†ä¸­...';
            progressBar.style.width = `${status.progress}%`;

            // æ›´æ–°å›¾æ ‡
            if (status.status === 'completed') {
                statusIcon.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                progressBar.classList.remove('bg-cyan-600');
                progressBar.classList.add('bg-green-500');
            } else if (status.status === 'failed') {
                statusIcon.innerHTML = `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                progressBar.classList.remove('bg-cyan-600');
                progressBar.classList.add('bg-red-500');
            } else {
                statusIcon.innerHTML = `<svg class="w-5 h-5 text-cyan-500 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            }
        }

        function resetUpdateButton() {
            const btn = document.getElementById('btn-perform-update');
            btn.innerHTML = `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span>${I18n.t('settings.update.download_btn') || 'ä¸‹è½½å¹¶å®‰è£…'}</span>`;
            
            if (updateInfo && updateInfo.has_update) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
            } else {
                btn.disabled = true;
                btn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700');
                btn.classList.add('bg-gray-100', 'text-gray-400', 'cursor-not-allowed');
            }
        }

        // æ›´æ–°å¤±è´¥åçš„æ¨¡æ€æ¡†
        async function showUpdateFailedModal(errorMsg) {
            // æ„å»ºé”™è¯¯ä¿¡æ¯
            let message = I18n.t('settings.modal.update_failed_msg') || 'æ›´æ–°ä¸‹è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ã€‚';
            message += '\n\n';
            message += (I18n.t('settings.modal.error_detail') || 'é”™è¯¯è¯¦æƒ…') + ':\n' + (errorMsg || 'æœªçŸ¥é”™è¯¯');
            message += '\n\n';
            message += I18n.t('settings.modal.update_failed_hint') || 'æ‚¨å¯ä»¥é€‰æ‹©é‡è¯•æˆ–å‰å¾€ GitHub æ‰‹åŠ¨ä¸‹è½½ã€‚';

            // ä½¿ç”¨è‡ªå®šä¹‰ä¸‰æŒ‰é’®æ¨¡æ€æ¡†
            const action = await showUpdateFailedOptions(
                I18n.t('settings.modal.update_failed_title') || 'æ›´æ–°å¤±è´¥',
                message
            );

            if (action === 'retry') {
                // é‡è¯•æ›´æ–°
                performUpdate();
            } else if (action === 'manual') {
                // æ‰“å¼€ GitHub Releases é¡µé¢
                window.open('https://github.com/1186258278/QingChenMail/releases', '_blank');
            }
            // action === 'cancel' æ—¶ä¸åšä»»ä½•æ“ä½œ
        }

        // æ›´æ–°å¤±è´¥é€‰é¡¹æ¨¡æ€æ¡†ï¼ˆä¸‰ä¸ªæŒ‰é’®ï¼‰
        function showUpdateFailedOptions(title, message) {
            return new Promise((resolve) => {
                // åˆ›å»ºæ¨¡æ€æ¡†
                const modalId = 'update-failed-modal';
                let modal = document.getElementById(modalId);
                if (modal) modal.remove();

                const modalHTML = `
                    <div id="${modalId}" class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center">
                        <div class="bg-white rounded-xl p-6 w-[480px] shadow-2xl mx-4">
                            <div class="flex items-start mb-4">
                                <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                                    <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg text-gray-800 mb-1">${title}</h3>
                                </div>
                            </div>
                            <div class="text-gray-600 mb-6 whitespace-pre-line text-sm bg-gray-50 p-4 rounded-lg border max-h-48 overflow-y-auto">${Utils.escapeHtml(message)}</div>
                            <div class="flex justify-end space-x-3">
                                <button id="${modalId}-cancel" class="px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition font-medium">
                                    ${I18n.t('common.cancel') || 'å–æ¶ˆ'}
                                </button>
                                <button id="${modalId}-manual" class="px-4 py-2.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-medium flex items-center">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                    ${I18n.t('settings.modal.manual_download') || 'æ‰‹åŠ¨ä¸‹è½½'}
                                </button>
                                <button id="${modalId}-retry" class="px-4 py-2.5 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 shadow-md transition font-medium flex items-center">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                    ${I18n.t('settings.modal.retry') || 'é‡è¯•'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById(modalId);

                // ç»‘å®šäº‹ä»¶
                document.getElementById(`${modalId}-cancel`).onclick = () => { modal.remove(); resolve('cancel'); };
                document.getElementById(`${modalId}-manual`).onclick = () => { modal.remove(); resolve('manual'); };
                document.getElementById(`${modalId}-retry`).onclick = () => { modal.remove(); resolve('retry'); };

                // ESC å…³é—­
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', escHandler);
                        resolve('cancel');
                    }
                };
                document.addEventListener('keydown', escHandler);
            });
        }

        // æ›´æ–°å®Œæˆåçš„æ¨¡æ€æ¡†
        async function showUpdateCompleteModal() {
            const confirmed = await Modal.confirm(
                I18n.t('settings.modal.update_complete_title') || 'æ›´æ–°å®Œæˆ',
                I18n.t('settings.modal.update_complete_msg') || 'æ›´æ–°å·²æˆåŠŸå®Œæˆï¼\n\næ˜¯å¦ç«‹å³é‡å¯æœåŠ¡ä»¥åº”ç”¨æ–°ç‰ˆæœ¬ï¼Ÿ',
                { 
                    type: 'success', 
                    confirmText: I18n.t('settings.modal.restart_now') || 'ç«‹å³é‡å¯',
                    cancelText: I18n.t('settings.modal.restart_later') || 'ç¨åæ‰‹åŠ¨é‡å¯',
                    confirmClass: 'bg-green-600 text-white hover:bg-green-700'
                }
            );
            
            if (confirmed) {
                await restartService();
            } else {
                // æ˜¾ç¤ºæ‰‹åŠ¨é‡å¯æŒ‡å—
                await Modal.alert(
                    I18n.t('settings.modal.manual_restart_title') || 'æ‰‹åŠ¨é‡å¯æŒ‡å—',
                    I18n.t('settings.alert.restart_required') || 'è¯·æ‰‹åŠ¨é‡å¯æœåŠ¡ä»¥åº”ç”¨æ–°ç‰ˆæœ¬ï¼š\n\n1. åœæ­¢å½“å‰æœåŠ¡\n2. å¯åŠ¨æ–°ç‰ˆæœ¬ç¨‹åº\n\nLinux: systemctl restart goemail æˆ– ./goemail\nWindows: é‡æ–°è¿è¡Œ goemail.exe',
                    { type: 'info' }
                );
            }
        }

        // é‡å¯æœåŠ¡
        async function restartService() {
            try {
                showToast(I18n.t('settings.toast.restarting') || 'æ­£åœ¨é‡å¯æœåŠ¡...', 'success');
                
                // æ˜¾ç¤ºé‡å¯ä¸­çŠ¶æ€
                document.getElementById('update-status-text').textContent = I18n.t('settings.update.restarting') || 'æ­£åœ¨é‡å¯æœåŠ¡...';
                document.getElementById('update-progress-bar').style.width = '100%';
                
                await request('/config/restart', { method: 'POST' });
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´ååˆ·æ–°é¡µé¢
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } catch (e) {
                // å¦‚æœè¯·æ±‚å¤±è´¥ï¼ˆå¯èƒ½æ˜¯å› ä¸ºæœåŠ¡å·²ç»å…³é—­ï¼‰ï¼Œä¹Ÿå°è¯•åˆ·æ–°
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        }

        // --- å¤‡ä»½ç®¡ç†ç›¸å…³å‡½æ•° ---
        async function loadBackupList() {
            const container = document.getElementById('backup-list');
            try {
                const backups = await request('/backups');
                
                if (!backups || backups.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-400 text-sm py-4" data-i18n="settings.backup.empty">æš‚æ— å¤‡ä»½</div>`;
                    return;
                }

                container.innerHTML = backups.map(b => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <span class="font-mono text-sm font-medium text-gray-700">${b.version}</span>
                                ${b.is_auto ? '<span class="ml-2 text-xs px-1.5 py-0.5 bg-blue-100 text-blue-600 rounded">è‡ªåŠ¨</span>' : ''}
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                ${new Date(b.created_at).toLocaleString()} Â· ${formatSize(b.size)}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-3">
                            <button onclick="restoreBackup('${b.id}', '${b.version}')" class="text-xs px-2 py-1 text-cyan-600 hover:bg-cyan-50 rounded transition" title="${I18n.t('settings.backup.restore') || 'æ¢å¤'}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                            <button onclick="deleteBackup('${b.id}')" class="text-xs px-2 py-1 text-red-500 hover:bg-red-50 rounded transition" title="${I18n.t('settings.backup.delete') || 'åˆ é™¤'}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<div class="text-center text-red-400 text-sm py-4">åŠ è½½å¤±è´¥</div>`;
            }
        }

        async function createManualBackup() {
            const btn = document.getElementById('btn-create-backup');
            const originalHTML = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = `<svg class="w-3 h-3 mr-1 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>åˆ›å»ºä¸­...`;

                await request('/backups', { method: 'POST' });
                showToast(I18n.t('settings.toast.backup_created') || 'å¤‡ä»½åˆ›å»ºæˆåŠŸ', 'success');
                loadBackupList();
            } catch (e) {
                showToast(I18n.t('settings.toast.backup_failed') || 'å¤‡ä»½åˆ›å»ºå¤±è´¥', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function restoreBackup(backupId, version) {
            const confirmed = await Modal.confirm(
                I18n.t('settings.modal.restore_title') || 'æ¢å¤å¤‡ä»½',
                (I18n.t('settings.backup.confirm_restore') || 'ç¡®å®šè¦æ¢å¤åˆ°æ­¤ç‰ˆæœ¬å—ï¼Ÿ') + `\n\nç‰ˆæœ¬: ${version}`,
                { type: 'warning', confirmText: I18n.t('settings.backup.restore') || 'æ¢å¤', confirmClass: 'bg-orange-600 text-white hover:bg-orange-700' }
            );
            
            if (!confirmed) return;

            try {
                const res = await request(`/backups/${backupId}/restore`, { method: 'POST' });
                showToast(I18n.t('settings.toast.restore_success') || 'æ¢å¤æˆåŠŸ', 'success');
                
                if (res.needs_restart) {
                    const restartConfirmed = await Modal.confirm(
                        I18n.t('settings.modal.restart_required_title') || 'éœ€è¦é‡å¯',
                        I18n.t('settings.modal.restart_required_msg') || 'ç¨‹åºæ–‡ä»¶å·²æ¢å¤ï¼Œéœ€è¦é‡å¯æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹ã€‚æ˜¯å¦ç«‹å³é‡å¯ï¼Ÿ',
                        { type: 'info', confirmText: I18n.t('settings.modal.restart_now') || 'ç«‹å³é‡å¯', confirmClass: 'bg-cyan-600 text-white hover:bg-cyan-700' }
                    );
                    if (restartConfirmed) {
                        await restartService();
                    }
                }
            } catch (e) {
                showToast(I18n.t('settings.toast.restore_failed') || 'æ¢å¤å¤±è´¥', 'error');
            }
        }

        async function deleteBackup(backupId) {
            const confirmed = await Modal.confirm(
                I18n.t('settings.modal.delete_backup_title') || 'åˆ é™¤å¤‡ä»½',
                I18n.t('settings.backup.confirm_delete') || 'ç¡®å®šè¦åˆ é™¤æ­¤å¤‡ä»½å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                { type: 'danger', confirmText: I18n.t('common.delete') || 'åˆ é™¤', confirmClass: 'bg-red-600 text-white hover:bg-red-700' }
            );
            
            if (!confirmed) return;

            try {
                await request(`/backups/${backupId}`, { method: 'DELETE' });
                showToast(I18n.t('settings.toast.backup_deleted') || 'å¤‡ä»½å·²åˆ é™¤', 'success');
                loadBackupList();
            } catch (e) {
                showToast(I18n.t('settings.toast.delete_failed') || 'åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // --- è‡ªåŠ¨æ›´æ–°é…ç½®ç›¸å…³å‡½æ•° ---
        async function loadAutoUpdateConfig() {
            try {
                const config = await request('/config/auto-update');
                
                document.getElementById('auto-update-toggle').checked = config.enabled;
                document.getElementById('auto-update-interval').value = config.interval || 24;
                document.getElementById('auto-update-time').value = config.time || '03:00';
                
                // æ›´æ–°å¼€å…³æ ·å¼
                updateToggleStyle(config.enabled);
                
                // æ ¹æ®å¼€å…³çŠ¶æ€æ˜¾ç¤º/éšè—è®¾ç½®
                document.getElementById('auto-update-settings').classList.toggle('hidden', !config.enabled);
            } catch (e) {
                console.error('åŠ è½½è‡ªåŠ¨æ›´æ–°é…ç½®å¤±è´¥:', e);
            }
        }

        function toggleAutoUpdate() {
            const checkbox = document.getElementById('auto-update-toggle');
            checkbox.checked = !checkbox.checked;
            const enabled = checkbox.checked;
            
            updateToggleStyle(enabled);
            document.getElementById('auto-update-settings').classList.toggle('hidden', !enabled);
            saveAutoUpdateConfig();
        }
        
        function updateToggleStyle(enabled) {
            const track = document.getElementById('auto-update-toggle-track');
            const thumb = document.getElementById('auto-update-toggle-thumb');
            
            if (enabled) {
                track.style.backgroundColor = '#0891b2'; // cyan-600
                thumb.style.transform = 'translateX(20px)';
            } else {
                track.style.backgroundColor = '#d1d5db'; // gray-300
                thumb.style.transform = 'translateX(0)';
            }
        }

        async function saveAutoUpdateConfig() {
            try {
                await request('/config/auto-update', {
                    method: 'POST',
                    body: JSON.stringify({
                        enabled: document.getElementById('auto-update-toggle').checked,
                        interval: parseInt(document.getElementById('auto-update-interval').value),
                        time: document.getElementById('auto-update-time').value
                    })
                });
                showToast(I18n.t('settings.toast.auto_update_saved') || 'è‡ªåŠ¨æ›´æ–°é…ç½®å·²ä¿å­˜', 'success');
            } catch (e) {
                showToast(I18n.t('settings.toast.save_failed') || 'ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        function initPage() {
            console.log('[Settings] åˆå§‹åŒ–é¡µé¢...');
            loadUpdateInfo();
            loadBackupList().then(() => console.log('[Settings] å¤‡ä»½åˆ—è¡¨å·²åŠ è½½')).catch(e => console.error('[Settings] å¤‡ä»½åˆ—è¡¨åŠ è½½å¤±è´¥:', e));
            loadAutoUpdateConfig();
            
            // å¤‡ä»½åˆ—è¡¨å®šæ—¶åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
            setInterval(() => {
                loadBackupList();
            }, 30000);
        }
        
        // ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
        if (document.readyState === 'complete') {
            initPage();
        } else {
            window.addEventListener('load', initPage);
        }

        // å¤„ç† URL hash è·³è½¬ï¼ˆä»å…¶ä»–é¡µé¢ç‚¹å‡»æ–°ç‰ˆæœ¬å¾½ç« è·³è½¬è¿‡æ¥æ—¶ï¼‰
        if (window.location.hash === '#update-section') {
            setTimeout(() => {
                const updateCard = document.getElementById('update-section');
                if (updateCard) {
                    updateCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // æ·»åŠ é«˜äº®æ•ˆæœ
                    updateCard.classList.add('ring-2', 'ring-cyan-400', 'ring-offset-2');
                    setTimeout(() => {
                        updateCard.classList.remove('ring-2', 'ring-cyan-400', 'ring-offset-2');
                    }, 3000);
                }
            }, 500);
        }
    </script>
</body>
</html>
